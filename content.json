{"meta":{"title":"沃德发","subtitle":"相互吹捧，共同进步😍😍😍","description":null,"author":"Yang","url":"http://example.com","root":"/"},"pages":[{"title":"about","date":"2023-12-07T14:14:04.000Z","updated":"2023-12-07T14:19:57.552Z","comments":true,"path":"about/index.html","permalink":"http://example.com/about/index.html","excerpt":"","text":""},{"title":"categories","date":"2023-11-23T11:58:42.000Z","updated":"2023-11-23T11:59:22.023Z","comments":true,"path":"categories/index.html","permalink":"http://example.com/categories/index.html","excerpt":"","text":""},{"title":"link","date":"2023-12-07T13:41:21.000Z","updated":"2023-12-07T13:41:48.936Z","comments":true,"path":"link/index.html","permalink":"http://example.com/link/index.html","excerpt":"","text":""},{"title":"tags","date":"2023-11-23T12:01:15.000Z","updated":"2023-11-23T12:04:24.284Z","comments":true,"path":"tags/index.html","permalink":"http://example.com/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"子网划分","slug":"子网划分","date":"2024-03-23T16:39:44.000Z","updated":"2024-03-23T17:25:29.504Z","comments":true,"path":"2024/03/24/子网划分/","permalink":"http://example.com/2024/03/24/%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86/","excerpt":"","text":"子网划分首先为什么要子网划分？ 有类IP地址规划的缺陷：使用默认掩码的问题：地址范围过大或过小，导致IP地址的浪费！ 在一个网络地址中，主机数：2的n次方，可用的主机数：2*n-2（这里n是主机数） 如果这个网段只用于一个小型局域网，例如一个实验室，只有几十台主机，那么大大浪费了ip地址 所以，子网划分给这个网络地址分成若干个，减少浪费 相当于把主机数均匀的分配给若干个（网络号借位，主机号减少） 例如网络地址：192.168.1.0&#x2F;24，网络号24位，主机号8位，如果划成两个子网，网络号借1位 借的1位是1或者是0 192.168.1.00000000（前25位变成网络号）子网1：192.168.1.0&#x2F;25 192.168.1.10000000 子网2：192.168.128.0&#x2F;25 例：192.168.1.0 分配三个部门，每个部门30台主机 要借2位 00 01 10 11 这四种排列组合，分为四个子网 192.168.1.00 000000 –192.168.1.0&#x2F;26 192.168.1.01 000000 –192.168.1.64&#x2F;26 192.168.1.10 000000 –192.168.1.128&#x2F;26 192.168.1.11 000000 –192.168.1.192&#x2F;26 子网划分的原理 IP地址由网络位+主机位组成，子网划分就是借用现有网段的主机位的最左边某几位作为子网位，划分出多个子网。 ①把原来有类网络IPv4地址中的“网络号”部分向“主机号”部分借位 ②把一部分原来属于“主机号”部分的位变成“网络号”的一部分（通常称之为“子网号”）。 因此IP地址进行转变：网络号+主机号 变成 网络号+子网号（m）+主机号（n） 划分后子网数量：2*m 划分后每个子网可用主机数：2*n-2（主机号全为0和全为1（指二进制）的ip地址分别为网络地址与广播地址，是不能分配给某个特定的主机使用的） 子网划分的步骤 ① 确定所需子网数2*m， ② 确定每个子网可用主机数2*n-2 ③ 确定需像主机号部分借多少位（m），才能满足需要求 ④ 根据主机数可得知子网地址空间大小2*n ⑤ 进行地址划分 子网划分示例 某公司有四个部门，每个部门拥有50台主机，分配一个C类地址200.161.30.0&#x2F;24,请问如何进行网络地址规划？ a.确定子网数：四个部门，2*m&gt;&#x3D;4 b.确定主机数：30台主机，2*n-2&gt;&#x3D;30 c.C类地址网络号位24位，主机位8位，向第四段主机位借位，由上可知子网位m&#x3D;2，主机位n&#x3D;6 d.子网空间为64，子网数为4，根据原主机位八位则原网络空间为0-255，共256个，此时我们算出子网空间为64，可得出四个子网范围0-63、64-127、127-192、192-255 e. 第一个子网200.161.30.0&#x2F;26-200.161.30.63&#x2F;26 第二个子网200.161.30.64&#x2F;26-200.161.30.127&#x2F;26 第三个子网200.161.30.128&#x2F;26-200.161.30.191&#x2F;26 第四个子网200.161.39.192&#x2F;26-200.161.30.255&#x2F;26 f.主机位全为0和1的地址分别为网络地址与广播地址，不能分配给主机使用，则 部门1地址范围：200.161.30.1-62&#x2F;26 部门2地址范围：200.161.30.65-12&#x2F;26 部门3地址范围：200.161.30.129-190&#x2F;26 部门4地址范围：200.161.30.193-254&#x2F;26","categories":[{"name":"基础知识","slug":"基础知识","permalink":"http://example.com/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"子网划分","slug":"子网划分","permalink":"http://example.com/tags/%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86/"}]},{"title":"WLAN基础配置（ap上线）","slug":"WLAN基础配置（ap上线）","date":"2023-12-20T10:17:25.000Z","updated":"2023-12-20T10:27:08.822Z","comments":true,"path":"2023/12/20/WLAN基础配置（ap上线）/","permalink":"http://example.com/2023/12/20/WLAN%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%EF%BC%88ap%E4%B8%8A%E7%BA%BF%EF%BC%89/","excerpt":"","text":"概念CAPWAP协议CAPWAP是基于UDP进行传输的应用层协议，CAPWAP协议在传输层运输两种类型的消息： 业务数据流量，封装转发无线数据帧 。——通过CAPWAP数据隧道。 管理流量，管理AP和AC之间交换的管理消息 。——通过CAPWAP控制隧道。 CAPWAP数据和控制报文基于不同的UDP端口发送： 管理流量端口为UDP端口5246。 业务数据流量端口为UDP端口5247。 AC连接方式直连模式下AC部署在用户的转发路径上，采用这种组网方式，对AC的吞吐量以及处理数据能力要求比较高，否则AC会是整个无线网络带宽的瓶颈。但用此种组网，组网架构清晰，组网实施起来简单 在旁挂式组网中，AC只承载对AP的管理功能，管理流封装在CAPWAP隧道中传输。数据业务流可以通过CAPWAP数据隧道经AC转发，也可以不经过AC转发直接转发，后者无线用户业务流经汇聚交换机由汇聚交换机传输至上层网络。 WLAN的基本概念 BSS：一个AP所覆盖的范围，在一个BSS的服务区域内，STA可以相互通信。 BSSID：是无线网络的一个身份标识，用AP的MAC地址表示。 SSID：表示无线网络的标识，用来区分不同的无线网络。例如，当我们在笔记本电脑上搜索可接入无线网络时，显示出来的网络名称就是SSID。 VAP早期的AP只支持1个BSS，如果要在同一空间内部署多个BSS，则需要安放多个AP，这不但增加了成本，还占用了信道资源。为了改善这种状况，现在的AP通常支持创建出多个虚拟AP (Virtual Access Point, VAP)。如图16-13所示，它相当于交换机中的VLAN ESS 为了满足实际业务的需求，需要对BSS的覆盖范围进行扩展。同时用户从一个BSS移动到另一个BSS时，不能感知到SSID的变化，则可以通过扩展服务集ESS (Extend Service Set)实现。如图6-14所示，这是由多个使用相同SSID的BSS组成，是采用相同的SSID的多个BSS组成的更大规模的虚拟BSS。 实验 实验步骤 步骤1：基本配置LSW2的配置system-view[Huawei]undo info-center enable[Huawei]sysname LSW2[LSW2]vlan 100[LSW2-vlan100]quit[LSW2]interface e0&#x2F;0&#x2F;1[LSW2-Ethernet0&#x2F;0&#x2F;1]port link-type trunk[LSW2-Ethernet0&#x2F;0&#x2F;1]port trunk allow-pass vlan 100[LSW2-Ethernet0&#x2F;0&#x2F;1]port trunk pvid vlan 100[LSW2-Ethernet0&#x2F;0&#x2F;1]quit[LSW2]interface e0&#x2F;0&#x2F;2[LSW2-Ethernet0&#x2F;0&#x2F;2]port link-type trunk[LSW2-Ethernet0&#x2F;0&#x2F;2]port trunk allow-pass vlan 100[LSW2-Ethernet0&#x2F;0&#x2F;2]port trunk pvid vlan 100[LSW2-Ethernet0&#x2F;0&#x2F;2]quit[LSW2]interface e0&#x2F;0&#x2F;3[LSW2-Ethernet0&#x2F;0&#x2F;3]port link-type trunk[LSW2-Ethernet0&#x2F;0&#x2F;3]port trunk allow-pass vlan 100[LSW2-Ethernet0&#x2F;0&#x2F;3]quit【思考1】：为什么LSW2只创建VLAN100，不用创建VLAN101？解析：因为我们用的是隧道转发，数据到达AC1后，才会打上101标记然后发给LSW1【思考2】：为什么连接AP的接口要打port trunk pvid vlan 100?解析：交换机收到AP的数据帧打上100的tag发送把带上100tag的数据帧去掉然后发给APLSW1的配置system-view[Huawei]undo info-center enable[Huawei]sysname LSW1[LSW1]vlan batch 100 101[LSW1]interface g0&#x2F;0&#x2F;1[LSW1-GigabitEthernet0&#x2F;0&#x2F;1]port link-type trunk[LSW1-GigabitEthernet0&#x2F;0&#x2F;1]port trunk allow-pass vlan 100[LSW1-GigabitEthernet0&#x2F;0&#x2F;1]quit[LSW1]interface g0&#x2F;0&#x2F;3[LSW1-GigabitEthernet0&#x2F;0&#x2F;3]port link-type trunk[LSW1-GigabitEthernet0&#x2F;0&#x2F;3]port trunk allow-pass vlan 100 101[LSW1-GigabitEthernet0&#x2F;0&#x2F;3]quit[LSW1]interface g0&#x2F;0&#x2F;2[LSW1-GigabitEthernet0&#x2F;0&#x2F;2]port link-type access[LSW1-GigabitEthernet0&#x2F;0&#x2F;2]port default vlan 101[LSW1-GigabitEthernet0&#x2F;0&#x2F;2]quit[LSW1]interface Vlanif 101[LSW1-Vlanif101]ip address 192.168.101.1 24[LSW1-Vlanif101]undo shutdown[LSW1-Vlanif101]quitAC1的配置system-view[AC6005]undo info-center enable[AC6005]sysname AC1[AC1]vlan batch 100 101[AC1]interface g0&#x2F;0&#x2F;1[AC1-GigabitEthernet0&#x2F;0&#x2F;1]port link-type trunk[AC1-GigabitEthernet0&#x2F;0&#x2F;1]port trunk allow-pass vlan 100 101[AC1-GigabitEthernet0&#x2F;0&#x2F;1]quit[AC1]interface Vlanif 100[AC1-Vlanif100]ip address 192.168.100.1 24[AC1-Vlanif100]undo shutdown[AC1-Vlanif100]quitR1的配置system-view[Huawei]undo info-center enable[Huawei]sysname R1[R1]interface g0&#x2F;0&#x2F;0[R1-GigabitEthernet0&#x2F;0&#x2F;0]ip address 192.168.101.2 24[R1-GigabitEthernet0&#x2F;0&#x2F;0]undo shutdown[R1-GigabitEthernet0&#x2F;0&#x2F;0]quit 步骤2：设置DHCP创建VLAN设置TRUNK业务DHCP-让STA获得IP地址[LSW1]dhcp enable[LSW1]interface Vlanif 101[LSW1-Vlanif101]dhcp select interface[LSW1-Vlanif101]quit管理DHCP-让AP获得IP地址system-view[AC1]dhcp enable[AC1]interface Vlanif 100[AC1-Vlanif100]dhcp select interface[AC1-Vlanif100]quit 步骤3：AC的配置 AP上线第一步：创建AP组system-view[AC1]wlan[AC1-wlan-view]ap-group name x &#x2F;&#x2F;创建AP组名字叫x[AC1-wlan-ap-group-x]quit第二步：创建域管理模板并关联到AP组[AC1]wlan[AC1-wlan-view]regulatory-domain-profile name x1 &#x2F;&#x2F;创建域管理模板，名字叫x1[AC1-wlan-regulate-domain-x1]country-code cn &#x2F;&#x2F;国家代码选择中国[AC1-wlan-regulate-domain-x1]quit[AC1-wlan-view]ap-group name x[AC1-wlan-ap-group-x]regulatory-domain-profile x1 &#x2F;&#x2F;AP组的域管理模板是x1Warning: Modifying the country code will clear channel, power and antenna gain configurations of the radio and reset the AP. Continue?[Y&#x2F;N]:y[AC1-wlan-ap-group-x]quit第三步：配置AC的接口源地址[AC1]capwap source interface Vlanif 100 &#x2F;&#x2F;AC的接口源地址为VLAN100第四步：离线导入AP[AC1]wlan[AC1-wlan-view]ap auth-mode mac-auth &#x2F;&#x2F;AP的认证模式为MAC认证[AC1-wlan-view]ap-id 1 ap-mac 00e0-fcd5-1c70 &#x2F;&#x2F;AP的编号和MAC地址[AC1-wlan-ap-1]ap-name ds &#x2F;&#x2F;AP的名字为ds[AC1-wlan-ap-1]ap-group x &#x2F;&#x2F;AP属于AP组x[AC1-wlan-view]ap-id 2 ap-mac 00e0-fc1e-3670 &#x2F;&#x2F;AP的编号和MAC地址[AC1-wlan-ap-2]ap-name xs &#x2F;&#x2F;Ap的名字[AC1-wlan-ap-2]ap-group x &#x2F;&#x2F;AP属于AP组xWarning: This operation may cause AP reset. If the country code changes, it willclear channel, power and antenna gain configurations of the radio, Whether to continue? [Y&#x2F;N]:y思考：AP的MAC地址是怎么知道的？读者可以通过在ap上使用命令“display interface Vlanif 1”查看当前ap的mac地址，然后再将mac地址进行绑定。查看命令：[AC1]display ap allInfo: This operation may take a few seconds. Please wait for a moment.done.Total AP information:nor : normal [2]-—————————————————————————————–ID MAC Name Group IP Type State STA Uptime-—————————————————————————————–1 00e0-fcd5-1c70 ds x 192.168.100.137 AP2050DN nor 0 11M:2S2 00e0-fc1e-3670 xs x 192.168.100.42 AP2050DN nor 0 54S-—————————————————————————————–可以看到两个AP都获取了IP地址，思考：以上过程一共几包？AP获取IP地址4个包：discovery、offer、request、ackCAPWAP的建立2个包：discovery request(udp 目的端口5246广播找AC) discovery response(单播回应AP)AP接入控制2个包：join request(udp 5246端口 单播) join response隧道维持2个包：数据隧道：keepalive(udp 5247) 控制隧道：echo(udp 5246) 配置VLAN业务参数第一步：创建安全模板[AC1]wlan[AC1-wlan-view]security-profile name y1 &#x2F;&#x2F;安全模板的名字叫y1[AC1-wlan-sec-prof-y1]security wpa-wpa2 psk pass-phrase huawei@123 aes &#x2F;&#x2F;密码是huawei@123，用AES加密。[AC1-wlan-sec-prof-y1]quit第二步：创建SSID模板[AC1]wlan[AC1-wlan-view]ssid-profile name y2 &#x2F;&#x2F;ssid的模板名字叫y2[AC1-wlan-ssid-prof-y2]ssid hcia &#x2F;&#x2F;ssid的名称叫hcia[AC1-wlan-ssid-prof-y2]quit[AC1-wlan-view]quit第三步：创建VAP模板[AC1]wlan[AC1-wlan-view]vap-profile name y &#x2F;&#x2F;vap模板的名字叫y[AC1-wlan-vap-prof-y]forward-mode tunnel &#x2F;&#x2F;转发模式为隧道[AC1-wlan-vap-prof-y]service-vlan vlan-id 101 &#x2F;&#x2F;服务的VLAN为101[AC1-wlan-vap-prof-y]security-profile y1 &#x2F;&#x2F;调用安全模板y1[AC1-wlan-vap-prof-y]ssid-profile y2 &#x2F;&#x2F;调用SSID模板y2[AC1-wlan-vap-prof-y]quit第四步：在AP组里面调用VAP模板[AC1-wlan-view]ap-group name x[AC1-wlan-ap-group-x]vap-profile y wlan 1 radio 0 &#x2F;&#x2F;调用VAP模板y[AC1-wlan-ap-group-x]vap-profile y wlan 1 radio 1 &#x2F;&#x2F;思考：radio0 1 2 是什么意思？思考：这相过程要几个包？WLAN业务配置下发2个包：Configuration Update Request Configuration Update Response STA接入，可以看到有两个ssid为hcia的无线网络，在之前的配置中配置了radio 0 、1就是为了释放两个不同的射频信号，选择其中一个，输入之前创建的密码huawei@123","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"ap上线","slug":"ap上线","permalink":"http://example.com/tags/ap%E4%B8%8A%E7%BA%BF/"},{"name":"wlan","slug":"wlan","permalink":"http://example.com/tags/wlan/"}]},{"title":"USG5500防火墙基础实验","slug":"USG5500防火墙基础实验","date":"2023-12-08T09:52:30.000Z","updated":"2023-12-08T10:57:14.753Z","comments":true,"path":"2023/12/08/USG5500防火墙基础实验/","permalink":"http://example.com/2023/12/08/USG5500%E9%98%B2%E7%81%AB%E5%A2%99%E5%9F%BA%E7%A1%80%E5%AE%9E%E9%AA%8C/","excerpt":"","text":"基础配置 1、本实验中的防火墙为USG5500系列防火墙； 2、 防火墙三个接口的IP地址按照上图所示进行配置；将这三个接口划入相应的安全域； 3、配置防火墙的域间包过滤策略，使得PC1能够主动访问PC2，但是PC2无法主动访问PC1；PC2能够主动访问WebServer的WEB服务。 防火墙配置： [FW] interface GigabitEthernet0&#x2F;0&#x2F;1 [FW-GigabitEthernet0&#x2F;0&#x2F;1] ip address 192.168.1.254 24 [FW] interface GigabitEthernet0&#x2F;0&#x2F;2 [FW-GigabitEthernet0&#x2F;0&#x2F;2] ip address 172.16.1.254 24 [FW] interface GigabitEthernet0&#x2F;0&#x2F;3 [FW-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.1.1.254 24 将接口添加到相应的安全区域： [FW] firewall zone trust [FW-zone-trust] add interface GigabitEthernet0&#x2F;0&#x2F;1 [FW] firewall zone dmz [FW-zone-dmz] add interface GigabitEthernet0&#x2F;0&#x2F;2 [FW] firewall zone untrust [FW-zone-untrust] add interface GigabitEthernet0&#x2F;0&#x2F;3 配置域间策略，使得trust域的192.168.1.0&#x2F;24网段用户能够访问untrust区域的10.1.1.0&#x2F;24网段 [FW] policy interzone trust untrust outbound [FW-policy-interzone-trust-untrust-outbound] policy 10 [FW-policy-interzone-trust-untrust-outbound-10] policy destination 10.1.1.0 0.0.0.255 [FW-policy-interzone-trust-untrust-outbound-10] policy source 192.168.1.0 0.0.0.255 [FW-policy-interzone-trust-untrust-outbound-10] action permit 配置域间策略，使得untrust可以访问server [FW] policy interzone dmz untrust inbound [FW-policy-interzone-dmz-untrust-inbound] policy 10 [FW-policy-interzone-dmz-untrust-inbound-10] policy source 10.1.1.0 0.0.0.255 [FW-policy-interzone-dmz-untrust-inbound-10] policy destination 172.16.1.1 0 [FW-policy-interzone-dmz-untrust-inbound-10] policy service service-set http [FW-policy-interzone-dmz-untrust-inbound-10] action permit 完成上述配置后，PC1即可主动发起访问PC2，而PC2无法主动访问PC1；另外，PC2能够访问WebServer的HTTP服务 （ping不同，需要再配置一条允许icmp协议通过） 通过命令display zone，可以查看防火墙的安全区域、安全等级，以及每个安全区域下的接口. 使用display firewall packet-filter default 命令，能查看防火墙的缺省安全策略。当数据包经过防火墙且从一个安全域试图访问另一个安全域时，防火墙会根据数据包的流向首先检查用户定义的policy interzone，如果没有自定义的policy interone，则会看根据防火墙的缺省安全策略进行处理。例如从上面的显示中，我们可以看到local-trust的inbound及outbound都是permit，因此即使我们没有显式的配置local及trust安全区域的区域间策略，但是由于默认的策略就是放行，所以 trust区域的用户可以直接ping通防火墙的接口。 如果要让防火墙默认放行所有域间的流量，可以使用：firewall packet-filter default permit all命令，值得注意的是，在网络正式投入现网使用之前，此命令必须关闭（firewall packet-filter default deny all），针对需要放行的流量，需通过policy interzone的配置来放行，而不能鲁莽地将所有流量统统放行。 使用display policy命令，能查看我们定义的区域间安全策略，例如： [FW] display policy interzone trust untrust outbound USG5500 nat实验 防火墙FW的配置如下： [FW] interface GigabitEthernet0&#x2F;0&#x2F;1 [FW-GigabitEthernet0&#x2F;0&#x2F;1] ip address 192.168.1.254 24 [FW] interface GigabitEthernet0&#x2F;0&#x2F;2 [FW-GigabitEthernet0&#x2F;0&#x2F;2] ip address 172.16.1.254 24 [FW] interface GigabitEthernet0&#x2F;0&#x2F;3 [FW-GigabitEthernet0&#x2F;0&#x2F;3] ip address 200.1.1.1 24 向安全域中添加接口 [FW] firewall zone trust [FW-zone-trust] add interface GigabitEthernet0&#x2F;0&#x2F;1 [FW] firewall zone dmz [FW-zone-dmz] add interface GigabitEthernet0&#x2F;0&#x2F;2 [FW] firewall zone untrust [FW-zone-untrust] add interface GigabitEthernet0&#x2F;0&#x2F;3 配置域间包过滤策略，使得trust区域的192.168.1.0&#x2F;24网段用户能够访问Internet： [FW] policy interzone trust untrust outbound [FW-policy-interzone-trust-untrust-outbound] policy 10 [FW-policy-interzone-trust-untrust-outbound-10] policy source 192.168.1.0 0.0.0.255 [FW-policy-interzone-trust-untrust-outbound-10] action permit 上述配置虽然放通了192.168.1.0&#x2F;24访问Internet的流量，但是由于192.168.1.0&#x2F;24是私有IP地址，不能直接进入公网，因此为了让这部分用户能够访问公网，还必须部署NAT源地址转换 [FW] nat address-group 1 200.1.1.10 200.1.1.20 定义NAT地址池，该地址池使用的公网地址区间是200.1.1.10到200.1.1.20 [FW] nat-policy interzone trust untrust outbound 配置NAT策略 [FW-nat-policy-interzone-trust-untrust-outbound] policy 10 [FW-nat-policy-interzone-trust-untrust-outbound-10] policy source 192.168.1.0 0.0.0.255 [FW-nat-policy-interzone-trust-untrust-outbound-10] action source-nat &#x2F;&#x2F;对匹配的流量执行源地址转换 [FW-nat-policy-interzone-trust-untrust-outbound-10] address-group 1 &#x2F;&#x2F;关联nat地址池1 完成上述配置后，内网用户PC1即可访问公网用户PC2。接下来继续配置防火墙，使得公网用户PC2能够访问WebServer。 配置域间包过滤策略，使得untrust区域的Internet用户能够访问DMZ区域的web服务 [FW] policy interzone dmz untrust inbound [FW-policy-interzone-dmz-untrust-inbound] policy 10 [FW-policy-interzone-dmz-untrust-inbound-10] policy destination 172.16.1.1 0 [FW-policy-interzone-dmz-untrust-inbound-10] policy service service-set http [FW-policy-interzone-dmz-untrust-inbound-10] action permit [FW-policy-interzone-dmz-untrust-inbound-10] quit [FW-policy-interzone-dmz-untrust-inbound] quit 完成上述配置后，Internet用户是依然无法访问WebServer的，因为WebServer是私有IP地址，因此还需要配置NAT server，将DMZ域内的WebServer映射到公网。 下面的命令，将内部IP地址172.16.1.1的80端口映射到了公网地址200.1.1.21的80端口，这样一来，当公网用户访问200.1.1.21的80端口服务时，实际上访问的就是内部服务器172.16.1.1的80端口。 [FW] nat server zone untrust protocol tcp global 200.1.1.21 80 inside 172.16.1.1 80 完成上述配置后，PC2即可使用目的地址200.1.1.21来访问WebServer。 当PC1 ping PC2时，能够在FW上能看到如下会话： display firewall session table Current Total Sessions : 5 icmp VPN:public –&gt; public 192.168.1.1:40373[200.1.1.15:2048]–&gt;200.1.1.2:2048 icmp VPN:public –&gt; public 192.168.1.1:40885[200.1.1.15:2049]–&gt;200.1.1.2:2048 留意到中括号内的IP地址，便是被NAT转换后的IP地址。 当PC2访问Server的WEB服务时，在FW上能看到如下会话： [FW]display firewall session table Current Total Sessions : 1 http VPN:public –&gt; public 200.1.1.2:2055–&gt;200.1.1.21:80[172.16.1.1:80]","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"USG5500","slug":"USG5500","permalink":"http://example.com/tags/USG5500/"},{"name":"防火墙nat","slug":"防火墙nat","permalink":"http://example.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99nat/"}]},{"title":"rstp和mstp","slug":"rstp和mstp","date":"2023-12-07T10:08:51.000Z","updated":"2023-12-07T10:53:06.725Z","comments":true,"path":"2023/12/07/rstp和mstp/","permalink":"http://example.com/2023/12/07/rstp%E5%92%8Cmstp/","excerpt":"","text":"概念STP三个版本：STP（802.1d）RSTP（802.1w）MSTP （802.1s）作用：打破二层环路，实现设备或者链路的冗余STP的计算过程①选举根桥BID&#x3D;优先级+MAC，优先级值越小越优，如果优先级相等，MAC小的成为根桥②选举根端口RPC（小的越优）+上行交换机的BID+上行交换机的PID（优先级和接口ID，越小越优）+本地的PID③选举指定接口RPC（小的越优）+本端的BID+本端的PID（小的越优）④非指定接口 端口优先级 端口ID（pid）&#x3D; 端口优先级（Port Priority）4 bit+ 端口编号12 bit 构成； 缺省情况下，端口优先级是128；端口优先级取值范围是0到240，取值必须为16的整数倍。 优先级 默认32768 越小越优 必须是4096倍数 0-65535 接口根路径开销： 1、dot1tG：20000E：200000 PRC&#x3D;根桥到非根桥经过所有的入方向接口的cost累加 STP的收敛时间： ①根桥故障50s②直连链路发生故障30s③非直连链路故障50s 转发延迟计时器：15sBPDU发送时间：2s老化时间：20s 端口状态：disable:未启用blocking：阻塞listening:侦听learning:学习forwarding：转发 RSTP:一、端口角色：根端口指定端口A:根端口的备份端口，提供了指定桥到达根的另一条路径Backup:作为指定接口的备份，提供了另一条从根桥到相应网段的备份链路 二、端口状态Discarding状态：不转发用户流量也不学习MAC地址；Learning状态：不转发用户流量但是学习MAC地址；Forwarding状：既转发用户流量又学习MAC地址三、配置BPDUBPDU类型和flag字段四、配置BPDU的处理拓扑稳定后，运行RSTP协议的非根桥设备会定期的发送配置BPDURSTP的任何端口角色都会处理次优BPDU，从而加快拓扑收敛五、P&#x2F;A作用：保证一个指定接口从discarding—&gt;forwarding触发：只有指定discarding状态下才可以触发P&#x2F;A机制，必须是根端口在forwarding状态下回复一个A&#x3D;1的一个BPDU ① 选举根桥、根接口、指定接口，然后根接口、指定接口处于discarding②根桥的指定接口处于discarsing，触发到P&#x2F;A，根桥会从指定接口发送P&#x3D;1BPDU；③非根桥的根接口收到P&#x3D;1的BPDU，会启动一个同步过程，将非边缘接口全部阻塞，同步完成之后，根接口切换到转发状态，并且从根接口发送A&#x3D;1 BPDU④根桥收到A&#x3D;1 BPDU，立即切换为转发状态，实现指定接口的快速收敛 保护功能：1、BPDU保护存在问题：边缘端口收到BPDU之后，接口会变成普通接口，那么会引起网络中生成树重新计算，对网络造成影响。解决：开启BPDU保护功能，只要边缘端口收到BPDU，交换机立即把接口置位Error-down，同时会产生告警。（接口恢复两种方式：手工恢复、自动恢复） 2、根保护 存在问题：加入在一个稳定的STP网络，此时根桥连接一台交换机，该交换机支持生成树，发送BPDU，STP网络重新计算；如果新加入的交换机比根桥优先级更优，会抢占根桥的位置，从而引起网络震荡解决：根桥的指定接口下激活跟保护功能，如何接口收到了更优的BPDU，会忽略并且切换到discarding。注意：跟保护只能在指定接口下激活。状态恢复：如果接口不再收到更优的BPDU，在一段时间后（2*转发延迟时间）自动恢复转发状态。 3、环路保护存在问题：AP单向故障：假如交换机之间通过光纤（一收一发），链路发生单向故障，AP接口老化时间后没有收到BPDU,接口会成为DP并切换到转发状态，并转发流量，环路产生RP单向故障：假如交换机之间通过光纤（一收一发），链路发生单向故障，导致DP到RP的单向故障，RP在一段时间没有收到BPDU，AP会切换到RP角色，RP切换到DP，收敛完成，DP开始转发业务流量，环路产生。解决：在AP接口下开启环路保护功能，如何接口长时间没有BPDU ,那么AP接口切换成DP，端口状态保持discarding状态，避免环路。 在RP接口下开启环路保护功能，如何接口长时间没有BPDU，那么会重新计算选举根端口，并将原端口调整为DP，接口状态保持discarding状态，避免环路。 4、拓扑变更保护（TC protection）存在问题：假如网络中存在攻击者，会仿冒TC置位为1的BPDU报文发送大量的TC BPDU，交换机收到BPDU之后，会删除mac地址表项，会消耗大量的设备资源。解决：默认情况交换机开启了拓扑变更保护，缺省2s只会处理异常TC BPDU，超出的部分等待一段时间处理 如何生成STP树？主要通过比较4个参数：根桥ID、根路径开销、网桥ID和端口ID，值越小，越优先。而这些参数，都是报文BPDU中的字段。根桥选举：比较根桥ID，最小胜出。根端口选举：依次比较RPC、对端BID、对端PID和本端PID，最小胜出。指定端口选举：依次比较RPC、本端BID和本端PID，最小胜出。 在确定了根端口和指定端口之后，交换机上所有剩余的非根端口和非指定端口被阻塞。 MSTP：一、概念MST Region：Multiple Spanning Tree Region，多生成树域），也可简称MST域MSTI（Multiple Spanning Tree Instance，多生成树实例）：MSTI使用Instance ID标识，为0~4094。Instance0是缺省存在的，而且缺省时，华为交换机上所有的VLAN都映射到了Instance0。通过设置VLAN映射表（即VLAN和MSTI的对应关系表），把VLAN和MSTI联系起来。每个VLAN只能对应一个MSTI，即同一VLAN的数据只能在一个MSTI中传输，而一个MSTI可能对应多个VLAN。CST公共生成树：是连接交换网络内所有MST域的一棵生成树IST（内部生成树）是各MST域内的一棵生成树。CIST（公共和内部生成树）通过生成树协议计算生成的，连接一个交换网络内所有交换设备的单生成树SST（Single Spanning Tree，单生成树）有两种情况：运行生成树协议的交换设备只能属于一个生成树。MST域中只有一个交换设备，这个交换设备构成单生成树。 总根（CIST Root）是CIST的根桥 域根（Regional Root）分为IST域根和MSTI域根。IST域根，在MST域中IST生成树中距离总根最近的交换设备是IST域根，MSTI域根是每个多生成树实例的树根 主桥（Master Bridge）是IST Master，它是域内距离总根最近的交换设备，如果总根在MST域中，则总根为该域的主桥 新增的端口角色：①Master端口 Master端口是MST域和总根相连的所有路径中最短路径上的端口，它是交换设备上连接MST域到总根的端口。Master端口是域中的报文去往总根的必经之路。Master端口是特殊域边缘端口，Master端口在CIST上的角色是Root Port，在其它各实例上的角色都是Master端口。 ②域边缘端口域边缘端口是指位于MST域的边缘并连接其它MST域或SST的端口 MSTP计算优先级向量说明：根交换设备ID：根交换设备ID用于选择CIST中的根交换设备。根交换设备ID &#x3D; Priority(16 bit) + MAC(48 bit)。其中Priority为MSTI0的优先级。外部路径开销（External Root Path Cost，ERPC）：从CIST的域根到达总根的路径开销。MST域内所有交换设备上保存的外部路径开销相同。若CIST根交换设备在域中，则域内所有交换设备上保存的外部路径开销为0。域根ID：域根ID用于选择MSTI中的域根。域根ID &#x3D; Priority(16 bit) + MAC(48 bit)。其中Priority为MSTI0的优先级。内部路径开销（Internal Root Path Cost，IRPC）：本桥到达域根的路径开销。域边缘端口保存的内部路径开销大于非域边缘端口保存的内部路径开销。指定交换设备ID：CIST或MSTI实例的指定交换设备是本桥通往域根的最邻近的上游桥。如果本桥就是总根或域根，则指定交换设备为自己。指定端口ID：指定交换设备上同本设备上根端口相连的端口。Port ID &#x3D; Priority(4 bit) + 端口号（12 bit）。端口优先级必须是16的整数倍。接收端口ID：接收到BPDU报文的端口。Port ID &#x3D; Priority(4 bit) + 端口号（12 bit）。 端口优先级必须是16的整数倍。 优先级向量比较原则：同一向量比较，值最小的向量具有最高优先级。优先级向量比较原则如下首先，比较根交换设备ID。如果根交换设备ID相同，再比较外部路径开销。如果外部路径开销相同，再比较域根ID。如果域根ID仍然相同，再比较内部路径开销。如果内部路径仍然相同，再比较指定交换设备ID。如果指定交换设备ID仍然相同，再比较指定端口ID。如果指定端口ID还相同，再比较接收端口ID。如果端口接收到的BPDU内包含的配置消息优于端口上保存的配置消息，则端口上原来保存的配置消息被新收到的配置消息替代。端口同时更新交换设备保存的全局配置消息。反之，新收到的BPDU被丢弃。 配置 开启STP，修改STP模式为RSTP。 手动指定S1为RSTP根桥、S2为RSTP备份根桥。 通过修改接口开销值，使得S4的GE0&#x2F;0&#x2F;1接口成为根端口。 通过修改S1的GE0&#x2F;0&#x2F;11接口优先级，使得S2的GE0&#x2F;0&#x2F;11接口成为根端口。 修改STP模式为MSTP，创建Instance1、2，指定SW1为MSTI1的根桥、MSTI2的备份根桥，指定SW2为MSTI2的根桥、MSTI1的备份根桥。 RSTP基础配置#S1-s4 上都配置 stp enable stp mode rstp #查看STP的状态和统计信息摘要 dis stp brief 接口都为指定端口的是根桥，本实验中s4是根桥 根桥选举控制 #手动调整STP优先级，指定S1为主根桥、S2为备份根桥 [S1]stp priority 4096 [S2]stp priority 8192 在另外两台交换机保持默认桥优先级（32768）的情况下，S1拥有最小的桥优先级，S2次之。 此时s1变为根桥，s2备份根桥 dis stp可以看到优先级已经改变 #取消S1、S2上手动调整桥优先级的配置，使用stp root命令指定根桥、备份根桥 [S1]undo stp priority [S1]stp root primary [S2]undo stp priority [S2]stp root secondary #S1、S2上查看STP的状态和统计信息，可以看到如下内容 s1： s2: S1的桥优先级为0，而S2的桥优先级为4096，此时S1为根桥，S2为备份根桥。 修改接口开销值控制根端口选举 #在S4上查看STP的状态和统计信息摘要 S4上GE0&#x2F;0&#x2F;2拥有更小的RPC（根路径开销），从而成为根端口。 #在S4上查看GE0&#x2F;0&#x2F;2接口的STP的状态和统计信息 此时路径开销计算方法为Dot1t，接口的STP cost值为20000。 #修改S4的GE0&#x2F;0&#x2F;2接口的STP cost值为40001 [S4]interface GigabitEthernet 0&#x2F;0&#x2F;2 [S4-GigabitEthernet0&#x2F;0&#x2F;2] stp cost 40001 #再次在S4上查看STP的状态和统计信息摘要 此时GE0&#x2F;0&#x2F;1接口的RPC为20000，小于GE0&#x2F;0&#x2F;2接口的RPC 40001，S4的GE0&#x2F;0&#x2F;1接口成为根端口。 修改接口优先级控制根端口选举 #在S2上查看STP的状态和统计信息摘要 S2上GE0&#x2F;0&#x2F;10、GE0&#x2F;0&#x2F;11接口收到的BPDU拥有相同的RPC、上行交换机BID，此时比较上行交换机PID（优先级+接口id），接口优先级一样，接口id小的优，所以g0&#x2F;0&#x2F;10小，所以是根端口 #在S1上修改GE0&#x2F;0&#x2F;11的STP接口优先级，使其发送的BPDU优于 GE0&#x2F;0&#x2F;10发送的BPDU （修改上行交换机的PID） [S1]interface GigabitEthernet 0&#x2F;0&#x2F;11 [S1-GigabitEthernet0&#x2F;0&#x2F;11] stp port priority 64 端口ID&#x3D; 端口优先级（Port Priority）4 bit+ 端口编号12 bit 构成； 缺省情况下，端口优先级是128；端口优先级取值范围是0到240，取值必须为16的整数倍。 #再次查看S2上的STP状态和统计信息摘要 此时S2的GE0&#x2F;0&#x2F;1接口成为根端口。 MSTP基础配置在所有交换机上创建VLAN10、20、30、40、50、60、70、80，配置MSTP域hcip，并创建两个新的实例：Instance 1、Instance 2，将VLAN10、30、50、70映射到Instance 1，将VLAN20、40、60、80映射到Instance 2，同时将SW1规划为MSTI1的主根桥、MSTI2的备份根桥，将SW2规划为MSTI2的主根桥、MSTI1的备份根桥。 #创建VLAN [S1]vlan batch 10 20 30 40 50 60 70 80 [S2]vlan batch 10 20 30 40 50 60 70 80 [S3]vlan batch 10 20 30 40 50 60 70 80 [S4]vlan batch 10 20 30 40 50 60 70 80 #将所有互联接口配置为Trunk接口，放通所有VLAN 略 #修改STP模式为MSTP [S1]stp mode mstp [S2]stp mode mstp [S3]stp mode mstp [S4]stp mode mstp #配置MSTP [S1]stp region-configuration [S1-mst-region] region-name hcip &#x2F;&#x2F;域名为hcip [S1-mst-region] revision-level 1 &#x2F;&#x2F;版本1 [S1-mst-region] instance 1 vlan 10 30 50 70 实例1映射vlan 10 30 50 70 [S1-mst-region] instance 2 vlan 20 40 60 80 [S1-mst-region] active region-configuration &#x2F;&#x2F;生效 Info: This operation may take a few seconds. Please wait for a moment…done. [S1-mst-region] quit （s2，s3，s4同理配置） #在S1检查MSTP实例和VLAN的映射关系 [S1]display stp region-configuration #配置SW1为MSTI1的根桥、MSTI2的备份根桥 [S1]stp instance 1 root primary [S1]stp instance 2 root secondary #配置SW2为MSTI2的根桥、MSTI1的备份根桥 [S2]stp instance 1 root secondary [S2]stp instance 2 root primary #在S1上查看MSTI1的状态和统计信息摘要 [S1]display stp instance 1 brief MSTID Port Role STP State Protection 1 GigabitEthernet0&#x2F;0&#x2F;10 DESI FORWARDING NONE 1 GigabitEthernet0&#x2F;0&#x2F;11 DESI FORWARDING NONE 1 GigabitEthernet0&#x2F;0&#x2F;12 DESI FORWARDING NONE 1 GigabitEthernet0&#x2F;0&#x2F;13 DESI FORWARDING NONE S1上所有接口都是指定接口，S1为MSTI1的根桥。 #在S2上查看MSTI2的状态和统计信息摘要 [S2]display stp instance 2 brief MSTID Port Role STP State Protection 2 GigabitEthernet0&#x2F;0&#x2F;10 DESI FORWARDING NONE 2 GigabitEthernet0&#x2F;0&#x2F;11 DESI FORWARDING NONE 2 GigabitEthernet0&#x2F;0&#x2F;12 DESI FORWARDING NONE 2 GigabitEthernet0&#x2F;0&#x2F;13 DESI FORWARDING NONE S2上所有接口都是指定接口，S2为MSTI2的根桥。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"rstp","slug":"rstp","permalink":"http://example.com/tags/rstp/"},{"name":"mstp","slug":"mstp","permalink":"http://example.com/tags/mstp/"}]},{"title":"链路聚合","slug":"链路聚合","date":"2023-12-07T07:56:27.000Z","updated":"2023-12-07T08:23:50.207Z","comments":true,"path":"2023/12/07/链路聚合/","permalink":"http://example.com/2023/12/07/%E9%93%BE%E8%B7%AF%E8%81%9A%E5%90%88/","excerpt":"","text":"概念什么是链路聚合在现网中，设备间如果通过一条链路连接，如果这条链路故障了，那么设备两端的终端就不能够通信了。有什么办法可以解决该问题呢？答案是——链路聚合。 从端口的角度定义： 链路聚合（Link Aggregation）是指将多个物理端口汇聚在一起，形成一个逻辑端口，以实现出&#x2F;入流量吞吐量在各成员端口的负荷分担，交换机根据用户配置的端口负载分担方式决定数据包从哪个成员端口发送到对端的交换机。 从链路的角度定义： 链路聚合（Link Aggregation）是把两台设备之间的多条物理链路聚合在一起，当做一条逻辑链路来使用。这两台设备可以是一对路由器，一对交换机，或者是一台路由器和一台交换机。一条聚合链路可以包含多条成员链路，默认最多为8条。 链路聚合的作用 链路聚合能够提高链路带宽。理论上，通过聚合几条链路，一个聚合口的带宽可以扩展为所有成员口带宽的总和，这样就有效地增加了逻辑链路的带宽。 链路聚合为网络提供了高可靠性。配置了链路聚合之后，如果一个成员接口发生故障，该成员口的物理链路会把流量切换到另一条成员链路上。 链路聚合在一个聚合口上实现负载均衡。一个聚合口可以把流量分散到多个不同的成员口上，通过成员链路把流量发送到同一个目的地，将网络产生拥塞的可能性降到最低。 三. 链路聚合的工作原理：应用场景： 链路聚合一般部署在核心结点，以便提升整个网络的数据吞吐量。 链路聚合能够提高链路带宽，增强网络可靠、可用性，支持负载分担。 链路聚合模式: 链路聚合包含两种模式：手动负载均衡模式和静态LACP（Link Aggregation Control Protocol）模式。 手工负载分担模式： 手工负载分担模式下，Eth-Trunk的建立、成员接口的加入由手工配置，没有链路聚合控制协议的参与。 该模式下所有活动链路都参与数据的转发，平均分担流量，因此称为负载分担模式。如果某条活动链路故障，链路聚合组自动在剩余的活动链路中平均分担流量。 使用场景： 当需要在两个直连设备间提供一个较大的链路带宽而设备又不支持LACP协议时，可以使用手工负载分担模式。 2. 静态LACP模式： 在静态LACP模式中，链路两端的设备相互发送LACP报文，协商聚合参数。协商完成后，两台设备确定活动接口和非活动接口。 在静态LACP模式中，需要手动创建一个Eth-Trunk口，并添加成员口。 静态LACP模式也叫M:N模式。M代表活动成员链路，用于在负载均衡模式中转发数据。N代表非活动链路，用于冗余备份。 如果一条活动链路发生故障，该链路传输的数据被切换到一条优先级最高的备份链路上，这条备份链路转变为活动状态。 两种链路聚合模式的主要区别： 在静态LACP模式中，一些链路充当备份链路。 在手动负载均衡模式中，所有的成员口都处于转发状态。 维度 手工模式 LACP模式 Eth-Trunk的建立方式 Eth-Trunk接口的创建、成员接口的加入由手工配置，没有链路聚合控制协议的参与。 Eth-Trunk接口的创建、成员接口的加入由手工配置，LACP协议参与链路动态调整，负责链路状态维护。在聚合条件发生变化时，自动调整或解散链路聚合。 设备是否需要支持LACP协议 不需要 需要 数据转发 正常情况下，所有链路都是活动链路。所有活动链路均参与数据转发。如果某条活动链路故障，链路聚合组自动在剩余的活动链路中分担流量。 正常情况下，部分链路是活动链路。所有活动链路均参与数据转发。如果某条活动链路故障，链路聚合组自动在非活动链路中选择一条链路作为活动链路，参与数据转发的链路数目不变。 检测故障 只能检测到同一聚合组内的成员链路有断路等故障，无法检测到链路断连、错连等故障。 不仅能够检测到同一聚合组内的成员链路有断路等故障，还可以检测到链路故障、链路错连等故障。 数据流控制: Eth-trunk链路两端相连的物理接口的数量、速率、双工方式、流控方式必须一致。 优先级0-65535 默认32768 小的优先 优先级一样，看mac，mac小的优先 配置 配置手工链路聚合# 创建Eth-Trunk接口 [S1]interface Eth-Trunk 1 interface eth-trunk命令用来进入已经存在的Eth-Trunk接口，或创建并进入Eth-Trunk接口。数字“1”代表接口编号，编号范围根据设备情况有所不同。 [S2]interface Eth-Trunk 1 # 设置Eth-Trunk接口的聚合模式 [S1-Eth-Trunk1]mode manual load-balance mode命令用来配置Eth-Trunk的工作模式，有LACP模式和手工负载分担模式（手工模式）两种，缺省情况下，Eth-Trunk的工作模式为手工负载分担模式。此处S1上的模式配置仅为示范目的，实际操作时不需要。 # 将成员接口加入聚合组 [S1]interface GigabitEthernet 0&#x2F;0&#x2F;10 [S1-GigabitEthernet0&#x2F;0&#x2F;10]eth-trunk 1 Info: This operation may take a few seconds. Please wait for a moment…done. [S1-GigabitEthernet0&#x2F;0&#x2F;10]quit [S1]interface GigabitEthernet 0&#x2F;0&#x2F;11 [S1-GigabitEthernet0&#x2F;0&#x2F;11]eth-trunk 1 Info: This operation may take a few seconds. Please wait for a moment…done. [S1-GigabitEthernet0&#x2F;0&#x2F;11]quit [S1]interface GigabitEthernet 0&#x2F;0&#x2F;12 [S1-GigabitEthernet0&#x2F;0&#x2F;12]eth-trunk 1 Info: This operation may take a few seconds. Please wait for a moment…done. [S1-GigabitEthernet0&#x2F;0&#x2F;12]quit 可进入到成员接口的接口视图下，逐一添加到Eth-Trunk接口。也可以在Eth-Trunk接口视图下通过trunkport命令批量添加接口。 [S2]interface Eth-Trunk 1 [S2-Eth-Trunk1]trunkport GigabitEthernet 0&#x2F;0&#x2F;10 to 0&#x2F;0&#x2F;12 Info: This operation may take a few seconds. Please wait for a moment…done. 将成员接口加入Eth-Trunk时，需要注意以下问题： • 每个Eth-Trunk接口下最多可以包含8个成员接口。 • Eth-Trunk接口不能嵌套，即Eth-Trunk接口的成员接口不能是Eth-Trunk接口。 • 一个以太网接口只能加入到一个Eth-Trunk接口，如果需要加入其它Eth-Trunk接口，必须先退出原来的Eth-Trunk接口。 • 如果本地设备使用了Eth-Trunk，与成员接口直连的对端接口也必须捆绑为Eth-Trunk接口，两端才能正常通信。 Eth-Trunk链路两端相连的物理接口的数量、速率、双工方式等必须一致。 #查看Eth-Trunk接口状态 dis eth-trunk 1 配置LACP模式# 删除现有Eth-Trunk接口下的成员接口 [S1]interface Eth-Trunk 1 [S1-Eth-Trunk1]undo trunkport GigabitEthernet 0&#x2F;0&#x2F;10 to 0&#x2F;0&#x2F;12 [S2]interface Eth-Trunk 1 [S2-Eth-Trunk1]undo trunkport GigabitEthernet 0&#x2F;0&#x2F;10 to 0&#x2F;0&#x2F;12 在修改Eth-Trunk接口的聚合模式之前，需要确保Eth-Trunk中没有任何成员接口。 # 修改聚合模式 [S1]interface Eth-Trunk 1 [S1-Eth-Trunk1]mode lacp mode lacp 指定Eth-Trunk工作模式为LACP模式。 注：部分版本的设备命令为 mode lacp-static [S2]interface Eth-Trunk 1 [S2-Eth-Trunk1]mode lacp # 将成员接口加入聚合组 [S1]interface Eth-Trunk 1 [S1-Eth-Trunk1]trunkport GigabitEthernet 0&#x2F;0&#x2F;10 to 0&#x2F;0&#x2F;12 [S2]interface Eth-Trunk 1 [S2-Eth-Trunk1]trunkport GigabitEthernet 0&#x2F;0&#x2F;10 to 0&#x2F;0&#x2F;12 查看 注意此时三个接口都是Select的状态 选择接口​ 考虑到网络流量情况，当网络正常时，只需要GigabitEthernet0&#x2F;0&#x2F;11和GigabitEthernet0&#x2F;0&#x2F;12接口处于转发状态，GigabitEthernet0&#x2F;0&#x2F;10接口作为备份。但当活动接口数量少于2时，直接关闭整个Eth-Trunk接口。 全局配置优先级选举主动方，主动方设备的端口上配置接口优先级选举活动端口 # 配置设备S1的LACP优先级，使其成为主动端设备 [S1]lacp priority 100 # 配置接口优先级，优选GigabitEthernet0&#x2F;0&#x2F;11和GigabitEthernet0&#x2F;0&#x2F;12接口 [S1]interface GigabitEthernet 0&#x2F;0&#x2F;10 [S1-GigabitEthernet0&#x2F;0&#x2F;10]lacp priority 40000 # 配置接口优先级，优选GigabitEthernet0&#x2F;0&#x2F;11和GigabitEthernet0&#x2F;0&#x2F;12接口 [S1]interface GigabitEthernet 0&#x2F;0&#x2F;10 [S1-GigabitEthernet0&#x2F;0&#x2F;10]lacp priority 40000 g0&#x2F;0&#x2F;10配置了大于32768的优先级4000，所以变为备份端口 之后，g0&#x2F;0&#x2F;11和g0&#x2F;0&#x2F;12为活动端口 使能了LACP模式链路聚合的两端设备均会收发的LACPDU报文。 首先选举主动端设备： 比较系统优先级字段，如果对端的系统优先级高于本端的系统优先级（默认为32768，越小越优），则确定对端为LACP主动端。 如果系统优先级相同，比较两端设备的MAC地址，MAC地址小的一端为LACP主动端。 选出主动端后，两端都会以主动端的接口优先级来选择活动接口，接口优先级越小越优，默认为32768。 # 配置Eth-trunk活动接口数上限阈值和下限阈值 [S1]interface Eth-Trunk 1 [S1-Eth-Trunk1]max active-linknumber 2 [S1-Eth-Trunk1]least active-linknumber 2 在一个Eth-Trunk接口内，活动接口数可以影响到Eth-Trunk接口的状态和带宽。Eth-Trunk接口的带宽是所有处于Up状态的成员口带宽之和。为保证Eth-Trunk接口的状态和带宽，可以设置以下两个阈值，以减小成员链路状态的变化带来的影响。 • 活动接口数下限阈值：当活动接口数小于配置的下限阈值时，Eth-Trunk接口的状态转为Down。设置活动接口数下限阈值的目的是为了保证最小带宽。least active-linknumber命令用来配置链路聚合组活动接口数目的下限阈值。 • 活动接口数上限阈值：当活动接口数达到上限阈值后，之后再发生成员链路状态变为Up都不会使Eth-Trunk接口的带宽增加。设置活动接口数上限阈值的目的是在保证了带宽的情况下提高网络的可靠性。max active-linknumber命令用来配置链路聚合组活动接口数目的上限阈值。 # 开启抢占功能 [S1]interface Eth-Trunk 1 [S1-Eth-Trunk1]lacp preempt enable 在LACP模式下，当活动链路中出现故障链路时，系统会从备用链路中选择优先级最高的链路替代故障链路；如果被替代的故障链路恢复了正常，而且该链路的优先级又高于替代自己的链路。这种情况下，如果使能了LACP优先级抢占功能，高优先级链路会抢占低优先级链路，回切到活动状态。lacp preempt enable命令用来使能LACP模式下LACP优先级抢占的功能，缺省情况下，优先级抢占处于禁止状态。 # 查看当前 Eth-Trunk接口状态 shutdown接口g0&#x2F;0&#x2F;11和g0&#x2F;0&#x2F;12 查看状态，发现都变为unselect状态 由于设置了Eth-Trunk的活动链路下限阈值为2，所以聚合组中可用活动接口数量少于2时，整个聚合组对应的接口将会被关闭。尽管此时GigabitEthernet0&#x2F;0&#x2F;10处于UP状态，但是仍处于Unselect状态。 修改负载分担模式# 开启上一步中关闭的接口 [S1]inter GigabitEthernet 0&#x2F;0&#x2F;11 [S1-GigabitEthernet0&#x2F;0&#x2F;11]undo shutdown [S1-GigabitEthernet0&#x2F;0&#x2F;11]quit [S1]inter GigabitEthernet 0&#x2F;0&#x2F;12 [S1-GigabitEthernet0&#x2F;0&#x2F;12]undo shutdown # 大约30秒后，查看当前Eth-Trunk1的接口状态 由于使能了Eth-Trunk接口的抢占功能，所以当GigabitEthernet0&#x2F;0&#x2F;11和GigabitEthernet0&#x2F;0&#x2F;12接口进入UP状态之后，这两个接口的接口的优先级高于GigabitEthernet0&#x2F;0&#x2F;10，所以GigabitEthernet0&#x2F;0&#x2F;10会进入unselect状态。同时因为系统为了保证链路的稳定性，默认的抢占延时为30秒，所以要在30秒后才会发生抢占。 # 修改Eth-Trunk接口的负载分担模式为基于目的IP地址 [S1]interface Eth-Trunk 1 [S1-Eth-Trunk1]load-balance dst-ip 当需要将Eth-Trunk接口的流量分散到不同的链路上，最后能到达统一目的地时，使用load-balance命令配置Eth-Trunk接口负载分担模式，以确保出方向的流量在各物理链路间进行合理的负载分担，避免链路阻塞。由于负载分担只对出方向的流量有效，因此链路两端接口的负载分担模式可以不一致，两端互不影响","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"链路聚合","slug":"链路聚合","permalink":"http://example.com/tags/%E9%93%BE%E8%B7%AF%E8%81%9A%E5%90%88/"},{"name":"lacp","slug":"lacp","permalink":"http://example.com/tags/lacp/"},{"name":"eth-trunk","slug":"eth-trunk","permalink":"http://example.com/tags/eth-trunk/"}]},{"title":"mpls实验","slug":"mpls实验","date":"2023-12-05T09:53:41.000Z","updated":"2023-12-05T10:56:53.373Z","comments":true,"path":"2023/12/05/mpls实验/","permalink":"http://example.com/2023/12/05/mpls%E5%AE%9E%E9%AA%8C/","excerpt":"","text":"概念MPLS（Multiprotocol Label Switching）多协议标签转发复习总结首先我们要先知道MPLS是为何出现的？MPLS是基于传统IP网络（RIP，OSPF等）的缺陷由IETF确定的 顺便先复习一下路由器查路由表 转发的过程： 传统的IP转发中，物理层从交换机的一个端口收到一个报文，上送到数据链路层。数据链路层去掉链路层封装，根据报文的协议域上送给相应的网络层。网络层首先看报文是否是送给本机的，若是，去掉网络层封装，上送给它的上层协议。若不是，则根据报文的目的地址查找路由表，若找到路由，将报文送给相应端口的数据链路层，数据链路层封装后，发送报文。若找不到路由，将报文丢弃。传统的IP转发采用的是逐跳转发，数据报文经过每一台交换机，都要执行上述过程（如图中SWA收到目的地址为10.2.0.1的数据包，SWA会依次查找路由表，根据匹配的路由表项的进行转发，SWB、SWC、SWD都会进行类似的处理），所以速度缓慢。并且所有的交换机需要知道全网的路由或者默认路由。另外，由于传统IP转发是面向无连接的，所以无法提供好的Qos保证。 传统IP网络基于IGP Metric计算最优路径，这是远远不够的，往往在现实网络中还需考虑带宽、链路属性等其他因素；基于IP的流量工程是基于IGP面向目的地址的转发，是hop-by-hop（逐跳）的转发，无法实现根据来源来控制流量转发；另外基于IP的流量工程是面向无连接的，不能实现显式路径（Explicit Routing）。上图中，SWB和SWD之间存在两条路径。传统的IP转发中IGP根据Metric选择最优的路由SWB-SWC-SWD转发所有从Network A和Network B到Network C的IP报文，而SWB-SWG-SWH-SWD链路则闲置，当网络中流量过大，有可能导致最优路径拥塞，但次优路径却空载没有被充分利用。 MPLS的出现从A到走到B有三种方法：1.广播（如以太网）：直接把数据发给每一个地方2.逐跳寻径：走到一个地方，问一下路接下来该怎么走（也就是上面说的根据路由协议，查路由表）3.源路由：提前规划好路线，到哪里怎么走，不常用。 而MPLS是第四种走法：跟在“向导”后面走，向导在走过的路上做好标记，你只要沿着标记的指示走就可以了。这也就是“标签交换” MPLS结合了三层路由技术与二层交换技术，所以可以把它看成“2.5层”的其中的MP多协议指的是支持多种网络协议，如ipv4，ipv6，CLNP，IPX等 MPLS是一种标签转发技术，它采用无连接的控制平面和面向连接的数据平面（具体的MPLS架构下面还有介绍），无连接的控制平面实现路由信息的传递和标签的分发，面向连接的数据平面实现报文在建立的标签转发路径上传送。MPLS域内，交换机不需要查看每个报文的目的IP地址，只需要根据封装在IP头外面的标签进行转发即可，这样可以大大提高效率 MPLS转发与IP逐跳转发的关系MPLS是IP的承载层：MPLS转发与IP转发不冲突，它们的关系是如果能够使用MPLS转发，那么IP包会先封装成MPLS数据帧来转发。如果不能MPLS转发，就还是原来的ip逐跳转发。（也就是尽量优先MPLS，因为它会更快） 看上面的图，我们需要理解：整个MPLS域（可以进行MPLS转发的区域）是嵌在IP域上的，也就是MPLS域外部是IP域，它本身也运行IP域。 MPLS中一些基本概念，名词标签（Label）：是一个定长的，比较短的，只具有本地意义的标识。FEC（转发等价类）：一组或一类数据，这组数据分配的标签相同LSP（标签交换通道）：一个FEC的数据流，在不同的节点被赋予确定的标签,数据转发按照这些标签进行。数据流所走的路径就是LSP。LSR（Label Switching Router）： LSR是MPLS的网络的核心交换机，它提供标签交换和标签分发功能。LER（Label Switching Edge Router）：在MPLS的网络边缘，进入到MPLS网络的流量由LER分为不同的FEC，并为这些FEC请求相应的标签。它提供流量分类和标签的映射、标签的移除功能。 从IP域进入MPLS域的时候，LER（标记边缘路由器）要做一个压入（push），出MPLS域的时候做一个弹出（pop），而LSR（标记交换路由器）负责转发。所以LER实际工作量比LSR大很多。LSP（标记交换路径）就是从进入到离开 走的路径。这条路径是在转发报文之前就已经通过各种协议确定并建立的，报文会在特定的LSP上传递。（也可以把LSP看成一个隧道） 标签报文格式： MPLS Header长度为32bits，包括长度为20bits的标签（Label），该标签用于报文转发；长度为3bits的EXP通常用来承载IP报文中的优先级；长度为1bit的栈底标志S用来表明是否是最后一个标签（MPLS标签可以多层嵌套）；长度为8bits的TTL，作用类似IP头部的TTL，用来防止报文环路等。 事实上MPLS封装有两种方式，上面说的是帧模式，Ethernet和PPP都是帧模式封装；还有一个信元封装模式（ATM采用）。MPLS的 LSP 与标签转发表 MPLS转发过程 1.Push：首先从IP数据包从ip域进入MPLS域，入口LER做 push 操作，分析转发等价类，为数据包“打上标签”，绑定LSP通道；图中A的标签转发表内容大概如下： 2.Swap：B，C两个LSR根据标签转发表，用下一跳分配的标签，替换MPLS报文的标签并转发 3.Pop：转发到出口LER D时，进行pop弹出操作，去掉标签 MPLS转发的过程到这里结束。 PHP（倒数第二跳弹出。Penultimate Hop Popping ，和web开发的php可没关系）：上面的过程我们可以发现，C在发给D时，其实带标签的数据已经没有意义，因为下一跳就要弹出标签了，所以完全可以在C就把标签弹出，然后以ip报文形式转发给D。这样可以大大降低最后的出口LER的工作量，是现在MPLS普遍采用的方法。默认情况下，设备支持PHP特性，支持PHP的Egress节点即出口LER 分配给倒数第二跳节点的标签值为3。 MPLS标签转发表与LDP 我们知道，交换机中的MAC地址表是通过逆向学习法产生的；路由器中的路由表是通过路由协议学习或自己配置静态路由产生的。那么MPLS中标签转发表是怎么产生的呢？ 答案是也会有一个类似的路由器学习的协议，这个协议叫做LDP（Label Distribution Protocol 标签分发协议），这个也是MPLS技术的核心协议之一。LDP来完成标签的分配控制和保持 从整个MPLS架构看这个协议的位置： 以上是MPLS架构图MPLS包括两个平面：控制平面和数据平面。控制平面负责产生和维护路由信息以及标签信息。数据平面负责普通IP报文的转发以及带MPLS标签报文的转发。控制平面中路由协议模块（Routing Protocol）用来传递路由信息，生成路由信息表；标签分发协议模块（Label Distribution Protocol）用来完成标签信息的交换，建立标签转发路径。数据平面包括IP转发表和标签转发表，当收到普通IP报文时（Incoming IP Packets），如果是普通IP转发，则查找IP路由表转发，如果需要标签转发，则按照标签转发表转发；当收到带有标签的报文时（Incoming Labeled Packets）时，如果需要按照标签转发，根据标签转发表转发，如果需要转发到IP网络，则去掉标签后根据IP转发表转发。 LDP的标签管理与保留方式主要内容有下面三部分 标签分配模式 DoD：下游按需标记分发DU：下游自主标记分发2. 标签控制模式 有序方式独立方式 标签保持模式 保守模式自由模式最常用的组合是 下游自主（DU） + 有序 + 自由 下面来具体介绍什么意思 这里先要理解上游，下游的概念，MPLS入口出为最上游；出口处为最下游。标签的产生可以理解为是下游为上游产生的，下游产生的IN标签作为上游的OUT标签（比如图中R3左边要接收的IN标签为100，那么R2向右的OUT标签就要是100，因为R3只要为100的标签） 然后具体介绍上面的三个部分：Ⅰ.标签的控制模式（即标签是怎么产生的）：有序（常用）：只有最下游路由器才能产生标签，最下游的上游收到最下游的标签映射消息后，然后才能再往自己的上游发送标签映射关系。独立：中间的路由器也可以直接产生标签 Ⅱ.标签的分发模式：下游按需 ：需要的时候上游再向下游询问标签信息；下游自主：不管有没有问，下游路由器都自主的向上游发送标签映射信息（主动向上汇报）Ⅲ.标签的保留模式：如果有两条路径，也就会有两个标签，那么路由器保留哪个。保守：只保留路由表中的”最佳路径“，跳数比较少的；自由：保留所有的标签，虽然占用了更多的标签空间，但是收敛会快 基础实验 配置步骤： 完成ip和ospf配置： R1的配置如下： [R1] interface GigabitEthernet0&#x2F;0&#x2F;0 [R1-GigabitEthernet0&#x2F;0&#x2F;0] ip address 12.1.1.1 24 [R1] interface loopback0 [R1-Loopback0] ip address 1.1.1.1 32 [R1] ospf 1 router-id 1.1.1.1 [R1-ospf-1] area 0 [R1-ospf-1-0.0.0.0] network 12.1.1.0 0.0.0.255 [R1-ospf-1-0.0.0.0] network 1.1.1.1 0.0.0.0 R2的配置如下： [R2] interface GigabitEthernet0&#x2F;0&#x2F;0 [R2-GigabitEthernet0&#x2F;0&#x2F;0] ip address 12.1.1.2 24 [R2] interface GigabitEthernet0&#x2F;0&#x2F;1 [R2-GigabitEthernet0&#x2F;0&#x2F;1] ip address 23.1.1.2 24 [R2] interface loopback0 [R2-Loopback0] ip address 2.2.2.2 32 [R2] ospf 1 router-id 2.2.2.2 [R2-ospf-1] area 0 [R2-ospf-1-0.0.0.0] network 12.1.1.0 0.0.0.255 [R2-ospf-1-0.0.0.0] network 23.1.1.0 0.0.0.255 [R2-ospf-1-0.0.0.0] network 2.2.2.2 0.0.0.0 R3的配置如下： [R3] interface GigabitEthernet0&#x2F;0&#x2F;0 [R3-GigabitEthernet0&#x2F;0&#x2F;0] ip address 23.1.1.3 24 [R3] interface GigabitEthernet0&#x2F;0&#x2F;1 [R3-GigabitEthernet0&#x2F;0&#x2F;1] ip address 34.1.1.3 24 [R3] interface loopback0 [R3-Loopback0] ip address 3.3.3.3 32 [R3] ospf 1 router-id 3.3.3.3 [R3-ospf-1] area 0 [R3-ospf-1-0.0.0.0] network 23.1.1.0 0.0.0.255 [R3-ospf-1-0.0.0.0] network 34.1.1.0 0.0.0.255 [R3-ospf-1-0.0.0.0] network 1.1.1.1 0.0.0.0 R4的配置如下： [R4] interface GigabitEthernet0&#x2F;0&#x2F;0 [R4-GigabitEthernet0&#x2F;0&#x2F;0] ip address 34.1.1.4 24 [R4] interface loopback0 [R4-Loopback0] ip address 4.4.4.4 32 [R4] ospf 1 router-id 4.4.4.4 [R4-ospf-1] area 0 [R4-ospf-1-0.0.0.0] network 34.1.1.0 0.0.0.255 [R4-ospf-1-0.0.0.0] network 4.4.4.4 0.0.0.0 激活mpls并激活ldp （全局和接口下都需要激活） R1的配置如下： [R1] mpls lsr-id 1.1.1.1 #配置MPLS LSR ID [R1] mpls #全局激活MPLS [R1-mpls] quit [R1] mpls ldp #全局激活LDP [R1-mpls-ldp] quit [R1] Interface GigabitEthernet 0&#x2F;0&#x2F;0 [R1-GigabitEthernet0&#x2F;0&#x2F;0] mpls #在接口上激活MPLS [R1-GigabitEthernet0&#x2F;0&#x2F;0] mpls ldp #在接口上激活LDP R2的配置如下： [R2] mpls lsr-id 2.2.2.2 [R2] mpls [R2-mpls] quit [R2] mpls ldp [R2-mpls-ldp] quit [R2] Interface GigabitEthernet 0&#x2F;0&#x2F;0 [R2-GigabitEthernet0&#x2F;0&#x2F;0] mpls [R2-GigabitEthernet0&#x2F;0&#x2F;0] mpls ldp [R2] Interface GigabitEthernet 0&#x2F;0&#x2F;1 [R2-GigabitEthernet0&#x2F;0&#x2F;1] mpls [R2-GigabitEthernet0&#x2F;0&#x2F;1] mpls ldp R3的配置如下： [R3] mpls lsr-id 3.3.3.3 [R3] mpls [R3-mpls] quit [R3] mpls ldp [R3-mpls-ldp] quit [R3] Interface GigabitEthernet 0&#x2F;0&#x2F;0 [R3-GigabitEthernet0&#x2F;0&#x2F;0] mpls [R3-GigabitEthernet0&#x2F;0&#x2F;0] mpls ldp [R3] Interface GigabitEthernet 0&#x2F;0&#x2F;1 [R3-GigabitEthernet0&#x2F;0&#x2F;1] mpls [R3-GigabitEthernet0&#x2F;0&#x2F;1] mpls ldp R4的配置如下： [R4] mpls lsr-id 4.4.4.4 [R4] mpls [R4-mpls] quit [R4] mpls ldp [R4-mpls-ldp] quit [R4] Interface GigabitEthernet 0&#x2F;0&#x2F;0 [R4-GigabitEthernet0&#x2F;0&#x2F;0] mpls [R4-GigabitEthernet0&#x2F;0&#x2F;0] mpls ldp 验证： display mpls ldp peer LDP Peer Information in Public network A ‘*’ before a peer means the peer is being deleted. -—————————————————————————– PeerID TransportAddress DiscoverySource -—————————————————————————– 2.2.2.2:0 2.2.2.2 GigabitEthernet0&#x2F;0&#x2F;0 -—————————————————————————– TOTAL: 1 Peer(s) Found. 以上输出的是R1的LDP邻居表，从表中可以看出R1已经发现了一个LDP邻居，那就是R2。 disp mpls ldp session verbose LDP Session(s) in Public Network -—————————————————————————– Peer LDP ID : 2.2.2.2:0 Local LDP ID : 1.1.1.1:0 TCP Connection : 1.1.1.1 &lt;- 2.2.2.2 Session State : Operational Session Role : Passive Session FT Flag : Off MD5 Flag : Off Reconnect Timer : — Recovery Timer : — Keychain Name : — Negotiated Keepalive Hold Timer : 45 Sec Configured Keepalive Send Timer : — Keepalive Message Sent&#x2F;Rcvd : 153&#x2F;153 (Message Count) Label Advertisement Mode : Downstream Unsolicited Label Resource Status(Peer&#x2F;Local) : Available&#x2F;Available Session Age : 0000:00:38 (DDDD:HH:MM) Session Deletion Status : No Capability: Capability-Announcement : Off P2MP Capability : Off Outbound&amp;Inbound Policies applied : NULL Addresses received from peer: (Count: 3) 2.2.2.2 12.1.1.2 23.1.1.2 -—————————————————————————– 以上输出的是LDP会话的详细信息，邻居的状态必须为Operational才是最终的稳态，另外从TCP连接1.1.1.1 &lt; 2.2.2.2可以验证一点，LDP的会话建立是由传输地址大的一方发起的。 display mpls ldp lsp LDP LSP Information -—————————————————————————— DestAddress&#x2F;Mask In&#x2F;OutLabel UpstreamPeer NextHop OutInterface -—————————————————————————— 1.1.1.1&#x2F;32 3&#x2F;NULL 2.2.2.2 127.0.0.1 InLoop0 *1.1.1.1&#x2F;32 Liberal&#x2F;1026 DS&#x2F;2.2.2.2 2.2.2.2&#x2F;32 NULL&#x2F;3 - 12.1.1.2 GE0&#x2F;0&#x2F;0 2.2.2.2&#x2F;32 1026&#x2F;3 2.2.2.2 12.1.1.2 GE0&#x2F;0&#x2F;0 3.3.3.3&#x2F;32 NULL&#x2F;1024 - 12.1.1.2 GE0&#x2F;0&#x2F;0 3.3.3.3&#x2F;32 1024&#x2F;1024 2.2.2.2 12.1.1.2 GE0&#x2F;0&#x2F;0 4.4.4.4&#x2F;32 NULL&#x2F;1025 - 12.1.1.2 GE0&#x2F;0&#x2F;0 4.4.4.4&#x2F;32 1025&#x2F;1025 2.2.2.2 12.1.1.2 GE0&#x2F;0&#x2F;0 -—————————————————————————— TOTAL: 7 Normal LSP(s) Found. TOTAL: 1 Liberal LSP(s) Found. TOTAL: 0 Frr LSP(s) Found. A ‘*’ before an LSP means the LSP is not established A ‘*’ before a Label means the USCB or DSCB is stale A ‘*’ before a UpstreamPeer means the session is stale A ‘*’ before a DS means the session is stale A ‘*’ before a NextHop means the LSP is FRR LSP 以上输出的是R1的LFIB（标签转发信息库），可以看到已经建立好的LSP。 实际上，当我们再R1、R2、R3、R4上运行OSPF后，全网的路由已经被打通，也就是每台路由器都拥有全网的路由，其中包括互联网段的路由，以及各设备的Loopback路由。随后我们激活各设备的MPLS和LDP，每台设备会基于自己的路由表中的路由前缀进行标签捆绑，并且将为路由前缀（FEC）所捆绑的标签分发给自己的LDP邻居。默认情况下在我司的设备上，仅为&#x2F;32的主机路由分发标签，并且默认水平分割规则并未打开。 现在，来测试一下，从R1去tracert 4.4.4.4： tracert lsp ip 4.4.4.4 32 LSP Trace Route FEC: IPV4 PREFIX 4.4.4.4&#x2F;32 , press CTRL_C to break. TTL Replier Time Type Downstream 0 Ingress 12.1.1.2&#x2F;[1025 ] 1 12.1.1.2 20 ms Transit 23.1.1.3&#x2F;[1024 ] 2 23.1.1.3 20 ms Transit 34.1.1.4&#x2F;[3 ] 3 4.4.4.4 20 ms Egress 从tracert的结果我们可以看到数据包行走的路径，以及被压入的标签。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"mpls","slug":"mpls","permalink":"http://example.com/tags/mpls/"}]},{"title":"Hybrid接口","slug":"Hybrid接口","date":"2023-12-05T05:30:11.000Z","updated":"2023-12-05T05:40:22.635Z","comments":true,"path":"2023/12/05/Hybrid接口/","permalink":"http://example.com/2023/12/05/Hybrid%E6%8E%A5%E5%8F%A3/","excerpt":"","text":"接口属性​ 交换机接口的类型，可以是Access、Trunk和Hybrid。Access类型的接口仅属于一个VLAN,,,,只能接收、转发相应VLAN的帧；而Trunk类型接口则默认属于所有VLAN任何Tagged帧都能经过Trunk接收和转发； Hybrid类型接口则介于二者之间，可自主定义端口上能接收和转发那些VLAN Tag帧，并可决定VLAN Tag是否继续携带或者剥离。。Access和Trunk类型接口是Hybrid类型接口的两个特例，，，一个仅支持一个VLAN传递，，一个默认支持所有VLAN的传递，而Access类型和Trunk类型的接口能做到的，Hybrid接口都能做到。 ​ hybrid属性具有trunk和access两种端口属性的特点，tag类似trunk，untag类似access，但是又不同，因为hybrid端口可以接收某个或者多个vlan的数据。 在开始研究之前强调几点： 1、在hybrid端口中，所有端口都默认属于vlan1，除非配置undo port hybrid vlan 1 才能将该hybrid剔除出vlan1，可以使用display vlan 查看端口所属的vlan 2、在hybrid端口中，无论是tag还是untag后面配置的vlan-id就是该hybrid端口所能够收到vlan数据的vlan-id，换句话说就是这些vlan中发出的数据该端口都能收到，可以使用display vlan查看（这里注意虽然可以收到这些vlan的数据但是严格意义上讲hybrid端口并不属于任何一个vlan） 3、所有类型端口的默认pvid都是vlan1，而pvid这个属性只！针对！进入！该端口的！没有标签的！普通数据包有效，作用是将没有标签的普通数据包打上pvid中配置的标签号 4、hybrid属性中，tag是针对于端口的接收方向的（从该端口进来的流量允许带有这些vlan标签的通过），untag是针对端口的发送方向的（从该端口出去的流量去除这些vlan标签） 5、加入一个hybrid端口配置tag vlan 2 3和untag vlan 4 5 ，那么默认情况下这个hybrid属于vlan1、2、3、4、5，在display vlan中可以查看到，只有端口属于了某个vlan，那么该端口才能收到某个vlan的数据包，这一点是理解下列两种配置和hybrid端口属性的关键！！！ 收发过程在数据发送时untag列表的原理，如下图1.带有vlan 3标签的数据从F0&#x2F;0接口出去，通过时查看untag列表，发现有对应的标签，将标签脱掉发送出去2.带有vlan 8标签的数据从F0&#x2F;1接口出去，通过时查看untag列表，发现没有对应的标签，继续查看tag表，发现有对应标签，所以直接带有vlan 8标签的数据发送出去3.带有vlan 5标签的数据从F0&#x2F;2接口出去，通过时查看untag列表，发现没有对应的标签 ，继续查看tag列表，发现也没有对应的标签，所以数据直接被丢弃 tag列表处理数据帧的接收和发送的原理，如下图1.没有标签的数据进入F0&#x2F;0接口，接口查看到数据没有标签，根据接口PVID&#x3D;3，将vlan 3标签打入数据2.带有vlan 9标签的数据进入接口F0&#x2F;1，接口查看到数据带有标签，接着查看tag列表，发现列表中存在对应标签，放通数据3.带有vlan 5标签的数据从接口F0&#x2F;2出去，接口查看到数据带有标签，查看untag列表，发现列表中没有对应vlan 5标签，继续查看tag列表，发现列表中存在对应标签vlan 5，放通数据出去4.带有vlan 3标签的数据从F0&#x2F;2接口出去，查看untag列表，发现列表中存在对应vlan 3标签，将标签脱掉，放通数据出去5.带有vlan 9标签的数据从F0&#x2F;2接口出去，查看untag表，发现列表中不存在对应vlan 9标签，继续查看tag列表，发现列表中不存在vlan 9标签，将数据丢弃 实例分析 1、为了让我们更加简洁的理解hydrid的属性，首先在所有的端口上移除了vlan1这个默认有的vlan，假设为所有端口初始不属于任何vlan，都不能相互之间通信 2、pvid是当普通的主机数据帧进入交换机端口后被打上的vlan-tag的属性，在途中可以看出PC1、PC2、PC3的流量在进入交换机的时候分别会被打上vlan2、vlan3、vlan99的vlan标签 3、untag后面的vlan就是该端口属于的vlan，那么不难看出LSW1的G0&#x2F;0&#x2F;1属于vlan2、3，G0&#x2F;0&#x2F;2属于vlan2、10，G0&#x2F;0&#x2F;3属于vlan3、10，而untag的动作是在流量出端口去往主机的时候把vlan-tag全部去除，那么不难看出LSW1的G0&#x2F;0&#x2F;1将去除vlan2、3的标签，G0&#x2F;0&#x2F;2去除vlan2、10的标签，G0&#x2F;0&#x2F;3去除vlan3、10的标签（还原成普通帧） LSW2的G0&#x2F;0&#x2F;1属于vlan99，G0&#x2F;0&#x2F;2属于vlan99，在流量出端口的时候会去除vlan99的标签（还原成普通帧） 那么PC1与PC2的通信现在分析如下：当PC1发送arp去请求PC2的MAC地址的时候，PC1会将数据包广播发往LSW1的G0&#x2F;0&#x2F;2接口，LSW1收到后发现是个普通的不带标签的数据帧，于是根据接口的pvid给该帧打上vlan2的tag，然后往vlan2中进行泛红，无奈G0&#x2F;0&#x2F;3端口只属于vlan3、10所以无法收到vlan2中的泛红，故PC1与PC2通信失败。 下面再来分析PC1与PC3通信：前面已经分析了PC1要去请求PC3的MAC，被LSW1的G0&#x2F;0&#x2F;2收到，并且打上vlan2的tag，然后在vlan2中泛红，那么在vlan2中的端口就都能收到该泛红了，所以在配置了untag vlan 2 3的G0&#x2F;0&#x2F;1端口自然也能收到vlan2和vlan3的泛红并转发出去，但是LSW1发现G0&#x2F;0&#x2F;1配置untag vlan2 3，所以将从该端口发送出去的所有带有vlan2和vlan3的数据包的tag全部去除（还原成普通帧），然后这个普通的帧就会发往LSW2被G0&#x2F;0&#x2F;1端口接收到，LSW2发现了一个普通的帧，那么就会用到pvid了不是，所以LSW2收到这个帧后打上vlan99的tag进行泛红，那么PC3所在的hybrid因为配置有untag vlan99必然能够收到vlan99的数据包了，然后在G0&#x2F;0&#x2F;2发给PC3的时候将vlan99的tag去除掉，PC3收到的就是一个不带任何tag的普通包（PC3完全不知道在它个PC1之间还有SW这种东西存在），好了PC3收到了PC1发来的arp请求，那么作为有礼貌的人应该回复自己的MAC地址了，与回一个arp响应给PC1， 下面PC3的回包分析：PC3使用PC1的MAC和ip封装好数据包后从网卡发送出去，LSW2的G0&#x2F;0&#x2F;2端口收到了，发现是一个普通帧，OK来pvid打上vlan99的tag，然后查看mac地址表发现PC1的MAC地址在G0&#x2F;0&#x2F;1口，在查看vlan信息，发现G0&#x2F;0&#x2F;1口可以接收vlan99的数据（untag vlan99），两个转发条件都满足了，那么久把数据包发给G0&#x2F;0&#x2F;1转发，G0&#x2F;0&#x2F;1转发的时候根据untag vlan99把数据包vlan-id去除还原成普通帧，被LSW1的G0&#x2F;0&#x2F;1收到，按照pvid的惯例，普通帧被打上了pvid vlan10的tag（用vlan10举例，也可以是任意vlan），然后LSW1根据MAC地址表找到PC1在自己的G0&#x2F;0&#x2F;2口，再查看vlan信息发现G0&#x2F;0&#x2F;2接口配置了untag vlan2 10，可以接收vlan10的数据包，于是就把这个被打上vlan10的PC3发来的arp响应通过G0&#x2F;0&#x2F;2发送给了PC1，当然在从G0&#x2F;0&#x2F;2接口出去的时候根据untag vlan2 10的配置将vlan10的tag去除还原成一个普通的帧，PC1收到的是一个普通的帧，完全不知道它和PC3之间还有交换机这个东西。好了，这就是一次通信过程，PC2与PC3的通信原理也是一样的，于是就实现了PC3与PC1、PC2互通，PC1与PC2之间不通的效果。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"hybrid","slug":"hybrid","permalink":"http://example.com/tags/hybrid/"},{"name":"tag","slug":"tag","permalink":"http://example.com/tags/tag/"}]},{"title":"telnet","slug":"telnet","date":"2023-12-02T09:19:24.000Z","updated":"2023-12-02T09:35:21.015Z","comments":true,"path":"2023/12/02/telnet/","permalink":"http://example.com/2023/12/02/telnet/","excerpt":"","text":"两种配置方法1.仅密码登录验证代码如下（示例）：system-view —–进入配置模式[Quidway]interface vlan 1 —–进入管理vlan[Quidway-Vlanif1]ip address 192.168.28.49 255.255.255.0 —–配置管理ip地址[Quidway-Vlanif1]quit —–退出[Quidway]telnet server enable —–打开telnet服务 （一般默认开启）[Quidway]user-interface vty 0 4 —–用户指定虚拟用户终端接口[Quidway-ui-vty0-4]authentication-mode password —–配置用户终端接口认证方式 密码验证[Quidway-ui-vty0-4]set authentication password cipher huawei123 —–设置接口验证密码,密码为huawei123[Quidway-ui-vty0-4]user privilege level 15 —–设置用户优先级 （可选）[Quidway-ui-vty0-4]idle-timeout 1 —–设置登陆超时为一分钟 （可选）[Quidway-ui-vty0-4]return —–返回用户视图save —–保存 2.配置AAA登录代码如下（示例）：system-view —–进入配置模式[Quidway]interface vlan 1 —–进入管理vlan[Quidway-Vlanif1]ip address 192.168.28.49 255.255.255.0 —–配置管理ip地址[Quidway-Vlanif1]quit —–退出[Quidway]telnet server enable —–打开telnet服务 （一般默认开启）[Quidway]user-interface vty 0 4 —–用户指定虚拟用户终端接口[Quidway-ui-vty0-4]authentication-mode aaa —–配置用户终端接口认证方式 aaa验证[Quidway-ui-vty0-4]user privilege level 15 —–设置用户优先级[Quidway-ui-vty0-4]idle-timeout 1 —–设置登陆超时为一分钟[Quidway-ui-vty0-4]quit —–退出[Quidway]aaa —–进入aaa[Quidway-aaa]local-user huawei password cipher huawei123 —–创建用户名huawei 密码huawei123[Quidway-aaa]local-user huawei privilege level 15 —–设置用户优先级[Quidway-aaa]local-user huawei service-type telnet —–授权用户使用telnet[Quidway-ui-vty0-4]return —–返回用户视图save —–保存 user-interface vty 0 4 详解Quidway]user-interface vty 0 4 ；进入虚拟终端[S3026-ui-vty0-4]authentication-mode password ；设置口令模式[S3026-ui-vty0-4]set authentication-mode password simple 222 ；设置口令[S3026-ui-vty0-4]user privilege level 3 一、第一句的意思是：进入到vty 终端，在华为的交换机里，vty就是人家用telnet远程进入到你交换机的界面，最多有五个，所以说你可以vty 0 vty 1 vty… vty 4交换机最多可以允许五个人同时在线进到交换机里去配置命令的。vty0 4 就是说把这五个界面一起配置了，这五个界面进去的话，都是使用以下的配置。二、用的认证模式是密码认证，可以使用scheme模式来，也可以用password来，用password的话，是要密码的，就是说你telnet的话，要输入密码才能登陆到包交换机里去的。二、设置密码为明文密码，密码是123 ，如果是密文的话，就是cipher四、用户等级为3，也就是最高的，华为的命令级别很多，分为四级，0 1 2 3 ，0是参观级，只能看，1比0要高，可以使用一些命令，2 是可以配置了，3可以备份与删除IOS啦，呵呵，这个命令就是说用这个123密码，进来就是最高级别的，不用换级别。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"telnet","slug":"telnet","permalink":"http://example.com/tags/telnet/"},{"name":"aaa","slug":"aaa","permalink":"http://example.com/tags/aaa/"}]},{"title":"FTP实验","slug":"FTP实验","date":"2023-11-30T10:10:45.000Z","updated":"2023-11-30T10:55:14.400Z","comments":true,"path":"2023/11/30/FTP实验/","permalink":"http://example.com/2023/11/30/FTP%E5%AE%9E%E9%AA%8C/","excerpt":"","text":"File Transfer Protocol 文件传输协议FTP服务器开启21号端口进行控制连接，20号端口与客户端建立数据连接 ASCII ((American Standard Code for Information Interchange): 美国信息交换标准代码）是基于拉丁字母的一套电脑编码系统，主要用于显示现代英语和其他西欧语言，它是最通用的信息交换标准。 FTP是用来传送文件的协议。使用FTP实现远程文件传输的同时，还可以保证数据传输的可靠性和高效性。 FTP 是基于客户———服务器（C&#x2F;S）模型而设计的，在客户端与 FTP 服务器之间建立两个连接 传输方式FTP支持两种方式的传输：文本（ASCII）方式和二进制（Binary）方式。通常文本文件的传输采用ASCII方式，而图象、声音文件、加密和压缩文件等非文本文件采用二进制方式传输，如果为了从一个系统上传输文件而使用了与本地系统不同的计算机字节位数，那么就必须使用Tenex模式。FTP以ASCII方式作为缺省的文件传输方式。 传输过程 使用FTP进行文件传输时，会使用两个TCP连接。第一个连接是FTP客户端和FTP服务器间的控制连接。FTP服务器开启21号端口，等待FTP客户端发送连接请求。FTP客户端随机开启端口，向服务器发送建立连接的请求。控制连接用于在服务器和客户端之间传输控制命令。 第二个连接是FTP客户端和FTP服务器间的数据连接。服务器使用TCP的20号端口与客户端建立数据连接。通常情况下，服务器主动建立或中断数据连接。 FTP服务器配置路由器和X7系列交换机均可提供FTP功能。执行ftp server enable命令使能FTP功能。执行set default ftp-directory命令设置FTP用户的默认工作目录。 在配置FTP服务器时，可以使用AAA为每个用户分别配置登录账号和访问权限。 aaa命令用来进入AAA视图。 local-user user-name { access-limit max-number | ftp-directory directory | idle-timeout minutes [ seconds ] | password cipher password [ opt ] | privilege level level | state {active | block } } *命令用来创建本地用户，并配置本地用户的各项参数。 user-name指定用户名。 local-user huawei service-type ftp命令用来配置本地用户的接入类型为ftp。 ftp-directory指定FTP用户可访问的目录。如果不配置FTP用户可访问的目录，则FTP用户无法登录设备。 access-limit指定用户名可建立的最大连接数目。 idle-timeout指定用户的闲置超时时间。 privilege level指定用户的优先级。 命令详解idle-timeoutidle-timeout命令用来设置用户连接的超时时间。 undo idle-timeout命令用来恢复超时时间的缺省值。 缺省情况下，用户连接的超时时间是5分钟。 命令格式 idle-timeout minutes [ seconds ] undo idle-timeout minutes 指定用户界面断连的超时时间的分钟数。 整数形式，取值范围是0～35791，单位是分钟。 seconds 指定用户界面断连的超时时间的秒数。 整数形式，取值范围是0～59，单位是秒 缺省级别 3：管理级 设置执行命令idle-timeout 0 0即关闭用户界面的超时断连功能。 如果用户界面没有设置闲置断连功能，则会导致已登录的用户始终处于连接状态，给设备带来安全风险，同时还有可能导致其他用户无法获得连接。 通常情况下，推荐设置用户界面断连的超时时间在10～15分钟之间。 # 设置超时为1分钟30秒。 1idle-timeout 1 30 local-user privilege level必须配置在3以上，否则ftp连接无法成功 local-user privilege level命令用来配置本地用户的优先级。 undo local-user privilege level命令用来将本地用户的优先级恢复为缺省配置。 缺省情况下，本地用户（如Telnet用户、SSH用户）的优先级由管理模块来决定。 命令格式 local-user user-name privilege level level undo local-user user-name privilege level user-name 用户名。 字符串形式，不支持空格，不区分大小写，长度范围是1~64。 level 用户的优先级。 整数形式，取值范围是0~15，取值越大，用户的优先级越高。缺省级别是0级。不同级别的用户登录后，只能使用等于或低于自己级别的命令 缺省情况下，命令级别分为0~3级： 级别0即参观级，网络诊断工具命令（ping、tracert）、从本设备出发访问外部设备的命令（包括：Telnet 客户端、SSH）等。该级别命令不允许进行配置文件保存的操作。 级别1即监控级，用于系统维护，包括display命令。该级别命令不允许进行配置文件保存的操作。 级别2即配置级，可以使用业务配置命令，包括路由、各个网络层次的命令，向用户提供直接网络服务。 级别3即管理级，用于系统基本运行的命令，对业务提供支撑作用，包括文件系统、FTP、TFTP、配置文件切换命令、备板控制命令、用户管理命令、命令级别设置命令、系统内部参数设置命令；用于业务故障诊断的debugging命令。 access-limitaccess-limit命令用来配置当前域允许接入的用户数。 undo access-limit命令用来恢复缺省配置。 缺省情况下，不限制接入的用户数目。 命令格式 access-limit max-number undo access-limit max-number 指定允许接入的用户数。 整数形式，取值范围是0～283648。 为了更方便地管理用户访问设备，可以限制域下用户的在线数量。 注意事项 执行这条配置命令后，当接入用户数大于允许的用户数时，系统不再允许用户接入系统，提示用户认证失败。 access-limit命令对一个域下所能接入的用户总数进行限制，不区分接入用户的类型。 # 设置当前域最多允许接入100个用户。 1access-limit 100 local-user ftp-directorylocal-user ftp-directory命令用来配置本地用户的FTP目录。 undo local-user ftp-directory命令用来将本地用户的FTP目录恢复为缺省配置。 缺省情况下，本地用户的FTP目录为空。 当需要将设备配置为FTP服务器，从而便于本地用户以FTP方式登录设备，对设备上的文件进行增加、删除、修改等操作时，可以通过本命令配置本地用户以FTP方式登录设备后所处的目录。 不指定该目录时，本地用户无法以FTP方式登录设备。 配置本地用户的FTP目录时，该用户必须已由local-user password命令建立。 local-user passwordlocal-user password命令用来创建一个本地用户并配置该用户的登录密码，或者修改已创建用户的登录密码。 undo local-user命令用来删除一个本地用户。 缺省情况下，系统没有本地用户。 local-user user-name password [ cipher password | irreversible-cipher irreversible-cipher-password ] undo local-user user-name cipher password 指定密文密钥。密钥以明文或密文形式输入，但配置文件中保存为密文形式。 irreversible-cipher irreversible-cipher-password 指定不可逆密文密钥。密钥以明文或不可逆密文形式输入，但配置文件中保存为密文形式。 总结1.FTP服务器需要开启TCP的21号端口来建立控制连接，20号端口来建立数据连接。 2.如果用户无权访问任何工作目录，则需要定义一个默认的FTP目录。执行set default ftp-directory 命令建立默认目录。 FTP实验R1 做为FTP Server 进行配置R2 做为Client 测试 R1：undo ter mosyssysname R1int g0&#x2F;0&#x2F;0ip add 192.168.1.1 24 R2：undo ter mosyssysname R2int g0&#x2F;0&#x2F;0ip add 192.168.1.2 24 R1:ftp server enableset default ftp-directory flash:&#x2F; （设置默认目录为flash:&#x2F;） ftp server enable命令用来开启设备的FTP服务器功能，允许FTP用户登录。缺省情况下，FTP服务器功能处于关闭状态。 其他可选的配置参数还包括：指定FTP服务器端口号、指定FTP服务器的源地址和配置FTP连接空闲时间等。 R1： 通过在AAA中设置用户名和密码（均为huawei）aaalocal-user huawei password cipher huaweilocal-user huawei service-type ftplocal-user huawei ftp-directory flash:&#x2F;local-user huawei access-limit 200local-user huawei idle-timeout 0 0local-user huawei privilege level 3 查看ftp server配置信息 R2登录FTP服务器 在R1和R2上分别保存文件text1.cfg和text2.cfg，用于后续测试 R1：save text1.cfg R2：save text2.cfg R2上通过dir命令查看服务器上的文件 R2从服务器上下载text1.cfg文件，并改名为newtext1.cfg R2本地查看dir put把本地文件text2.cfg上传到服务器，并改名为newtext2.cfg 查看是否上传成功 关闭ftp连接：bye","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"FTP","slug":"FTP","permalink":"http://example.com/tags/FTP/"}]},{"title":"VRRP基础实验","slug":"VRRP基础实验","date":"2023-11-29T13:01:52.000Z","updated":"2023-11-29T13:33:55.792Z","comments":true,"path":"2023/11/29/VRRP基础实验/","permalink":"http://example.com/2023/11/29/VRRP%E5%9F%BA%E7%A1%80%E5%AE%9E%E9%AA%8C/","excerpt":"","text":"设备连接方式如图所示，网络中存在VLAN10、20，每个VLAN中部署一组VRRP，使用与VLAN ID相同的数值作为VRID，将S1配置为VLAN10的VRRP Master，将S2配置为VLAN20的VRRP Master。 同时在S1、S2、S3上部署MSTP，创建Instance 1、2，将VLAN10映射到MSTI 1、VLAN20映射到MSTI 2，将S1配置为MSTI 1的主根桥、MSTI 2的备份根桥，而将S2配置为MSTI 1的备份根桥、MSTI 2的主根桥。 VLANIF接口地址使用10.0.x.y&#x2F;24，其中x为VRID组号，y为设备编号，VRIP使用10.0.x.254&#x2F;24。 #创建VLAN [S1]vlan batch 10 20 [S2]vlan batch 10 20 [S3]vlan batch 10 20 [S4]vlan batch 10 20 #将所有互联接口配置为Trunk接口，放通对应VLAN 略 #修改STP模式为MSTP [S1]stp mode mstp [S2]stp mode mstp [S3]stp mode mstp #配置MSTP [S1]stp region-configuration [S1-mst-region] region-name hcip [S1-mst-region] revision-level 1 [S1-mst-region] instance 1 vlan 10 [S1-mst-region] instance 2 vlan 20 [S1-mst-region] active region-configuration Info: This operation may take a few seconds. Please wait for a moment…done. [S1-mst-region] quit [S2]stp region-configuration [S2-mst-region] region-name hcip [S2-mst-region] revision-level 1 [S2-mst-region] instance 1 vlan 10 [S2-mst-region] instance 2 vlan 20 [S2-mst-region] active region-configuration Info: This operation may take a few seconds. Please wait for a moment…done. [S2-mst-region] quit [S3]stp region-configuration [S3-mst-region] region-name hcip [S3-mst-region] revision-level 1 [S3-mst-region] instance 1 vlan 10 [S3-mst-region] instance 2 vlan 20 [S3-mst-region] active region-configuration Info: This operation may take a few seconds. Please wait for a moment…done. [S3-mst-region] quit #配置SW1为MSTI1的根桥、MSTI2的备份根桥 [S1]stp instance 1 root primary [S1]stp instance 2 root secondary #配置SW2为MSTI2的根桥、MSTI1的备份根桥 [S2]stp instance 1 root secondary [S2]stp instance 2 root primary #在S1上查看MSTI1的状态和统计信息摘要 S1上所有接口都是指定接口，S1为MSTI1的根桥。 #在S2上查看MSTI2的状态和统计信息摘要 S2上所有接口都是指定接口，S2为MSTI1的根桥。 VRRP基础配置在S1、S2均创建VLANIF 10、20，分别加入VRRP组10、20，手动配置VRRP优先级，使得S1的VLAN10成为VRRP Master、S2的VLAN20成为VRRP Master。 #创建VLANIF [S1]interface Vlanif10 [S1-Vlanif10] ip address 10.0.10.1 255.255.255.0 [S1-Vlanif10] quit [S1]interface Vlanif20 [S1-Vlanif20] ip address 10.0.20.1 255.255.255.0 [S1-Vlanif20] quit [S2]interface Vlanif10 [S2-Vlanif10] ip address 10.0.10.2 255.255.255.0 [S2-Vlanif10] quit [S2]interface Vlanif20 [S2-Vlanif20] ip address 10.0.20.2 255.255.255.0 [S2-Vlanif20] quit #S1上配置VRRP [S1]interface Vlanif 10 [S1-Vlanif10] vrrp vrid 10 virtual-ip 10.0.10.254 [S1-Vlanif10] vrrp vrid 10 priority 120 [S1-Vlanif10] quit [S1]interface Vlanif 20 [S1-Vlanif20] vrrp vrid 20 virtual-ip 10.0.20.254 [S1-Vlanif20] quit 配置VLAN10的VRRP优先级为120，VLAN20保持默认的100。 #S2上配置VRRP [S2]interface Vlanif10 [S2-Vlanif10] vrrp vrid 10 virtual-ip 10.0.10.254 [S2-Vlanif10] quit [S2]interface Vlanif20 [S2-Vlanif20] vrrp vrid 20 virtual-ip 10.0.20.254 [S2-Vlanif20] vrrp vrid 20 priority 120 [S2-Vlanif20] quit 配置VLAN20的VRRP优先级为120，VLAN10保持默认的100。 #查看VRRP组状态 配置VRRP与BFD联动进行快速切换在S1、S2上配置BFD单跳检测，检测VLANIF接口之间的连通性，将VRRP与BFD联动，当BFD会话状态Down时，增加VRRP Backup设备的优先级。 #在S1上配置BFD会话 [S1]bfd [S1-bfd] quit [S1]bfd vlanif10 bind peer-ip 10.0.10.2 interface Vlanif10 [S1-bfd-session-vlanif10] discriminator local 1 [S1-bfd-session-vlanif10] discriminator remote 2 [S1-bfd-session-vlanif10] min-tx-interval 100 [S1-bfd-session-vlanif10] min-rx-interval 100 [S1-bfd-session-vlanif10] commit [S1-bfd-session-vlanif10] quit [S1]bfd vlanif20 bind peer-ip 10.0.20.2 interface Vlanif20 [S1-bfd-session-vlanif20] discriminator local 11 [S1-bfd-session-vlanif20] discriminator remote 22 [S1-bfd-session-vlanif20] min-tx-interval 100 [S1-bfd-session-vlanif20] min-rx-interval 100 [S1-bfd-session-vlanif20] commit [S1-bfd-session-vlanif20] quit #在S2上配置BFD会话 [S2]bfd [S2-bfd] quit [S2]bfd vlanif10 bind peer-ip 10.0.10.1 interface Vlanif10 [S2-bfd-session-vlanif10] discriminator local 2 [S2-bfd-session-vlanif10] discriminator remote 1 [S2-bfd-session-vlanif10] min-tx-interval 100 [S2-bfd-session-vlanif10] min-rx-interval 100 [S2-bfd-session-vlanif10] commit [S2-bfd-session-vlanif10] quit [S2]bfd vlanif20 bind peer-ip 10.0.20.1 interface Vlanif20 [S2-bfd-session-vlanif20] discriminator local 22 [S2-bfd-session-vlanif20] discriminator remote 11 [S2-bfd-session-vlanif20] min-tx-interval 100 [S2-bfd-session-vlanif20] min-rx-interval 100 [S2-bfd-session-vlanif20] commit [S2-bfd-session-vlanif20] quit #检查BFD会话状态 此时S1、S2上BFD会话状态都为Up。 #配置VRRP与BFD联动 [S1]interface Vlanif20 [S1-Vlanif20] vrrp vrid 20 track bfd-session 11 increased 30 [S1-Vlanif20] quit [S2]interface Vlanif10 [S2-Vlanif10] vrrp vrid 10 track bfd-session 2 increased 30 [S2-Vlanif10] quit 注意，此处的bfd-session号为本地的BFD discriminator，只需要在Backup状态的接口上配置联动，BFD会话Down时增加本地的VRRP优先级。 #关闭S1上所有接口，模拟链路故障 [S1]interface GigabitEthernet0&#x2F;0&#x2F;10 [S1-GigabitEthernet0&#x2F;0&#x2F;10] shutdown [S1-GigabitEthernet0&#x2F;0&#x2F;10] quit [S1]interface GigabitEthernet0&#x2F;0&#x2F;11 [S1-GigabitEthernet0&#x2F;0&#x2F;11] shutdown [S1-GigabitEthernet0&#x2F;0&#x2F;11] quit [S1]interface GigabitEthernet0&#x2F;0&#x2F;12 [S1-GigabitEthernet0&#x2F;0&#x2F;12] shutdown [S1-GigabitEthernet0&#x2F;0&#x2F;12] quit #在S2上查看BFD会话状态 此时两个BFD会话状态立马变为Down。 #在S2上查看VRRP组状态 VRRP组10、20的Master此时都是S2。 #在S2上查看VRRP组的状态和配置参数信息","categories":[],"tags":[{"name":"VRRP","slug":"VRRP","permalink":"http://example.com/tags/VRRP/"},{"name":"BFD","slug":"BFD","permalink":"http://example.com/tags/BFD/"}]},{"title":"BGP路由优选","slug":"BGP路由优选","date":"2023-11-28T10:19:34.000Z","updated":"2023-11-28T11:52:29.140Z","comments":true,"path":"2023/11/28/BGP路由优选/","permalink":"http://example.com/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/","excerpt":"BGP路由优选实验背景你是公司的网络管理员。公司的网络采用了BGP协议接入了两个服务运营商。公司自己采用了私有的AS号64512，ISP1的AS号为100，ISP2的AS号为200。通过AS100、AS200都可以到达相同的网络，你通过改变BGP的各种属性达到了调整路由走向的目的。","text":"BGP路由优选实验背景你是公司的网络管理员。公司的网络采用了BGP协议接入了两个服务运营商。公司自己采用了私有的AS号64512，ISP1的AS号为100，ISP2的AS号为200。通过AS100、AS200都可以到达相同的网络，你通过改变BGP的各种属性达到了调整路由走向的目的。 实验介绍： 设备互联方式、互联接口地址如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号，所有设备都使用Loopback0地址作为BGP Router ID。 R1在AS100，R5在AS200，R2、R3、R4在AS64512。AS64512内运行OSPF，在互联接口（不包括连接外部AS的接口）、Loopback0接口上激活OSPF。 EBGP对等体关系基于直连接口建立，IBGP对等体关系基于Loopback0接口建立。 R1、R5上存在相同的网段172.16.1.0&#x2F;24、172.16.2.0&#x2F;24、172.16.3.0&#x2F;24、172.16.4.0&#x2F;24，在R1、R5上将其发布到BGP，以用于BGP路由优选。 配置ip，配置bgp：略 #在R1、R5上将Loopback1、Loopback2、Loopback3、Loopback4接口路由发布到BGP中 [R1]bgp 100 [R1-bgp] network 172.16.1.0 24 [R1-bgp] network 172.16.2.0 24 [R1-bgp] network 172.16.3.0 24 [R1-bgp] network 172.16.4.0 24 [R5]bgp 200 [R5-bgp] network 172.16.1.0 24 [R5-bgp] network 172.16.2.0 24 [R5-bgp] network 172.16.3.0 24 [R5-bgp] network 172.16.4.0 24 #在R3上查看BGP路由表，检查BGP路由是否成功学习 R3已经成功学习R1、R5发布的路由，此时所有路由都优选由R2通告的。 修改AS_Path属性在R1上通过路由策略修改BGP路由172.16.1.0&#x2F;24的 AS_Path属性值，使得R3优选R5发布的BGP路由172.16.1.0&#x2F;24。 #创建IP前缀列表1，匹配Loopback1接口路由 [R1]ip ip-prefix 1 permit 172.16.1.0 24 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改AS_Path属性值 [R1]route-policy hcip permit node 10 [R1-route-policy] if-match ip-prefix 1 [R1-route-policy] apply as-path 300 400 additive [R1-route-policy] quit [R1]route-policy hcip permit node 20 注意创建一个空节点，对于另外3条BGP路由不执行任何操作。 #对向BGP对等体R2通告的BGP路由应用Route-Policy [R1]bgp 100 [R1-bgp] peer 10.0.12.2 route-policy hcip export #在R1上触发出方向的软复位，刷新对外通告的BGP路由 refresh bgp all export #在R3上查看BGP路由172.16.1.0&#x2F;24的明细信息 此时R3优选R4通告的BGP路由172.16.1.0&#x2F;24，R2通告的未被优选的原因是AS_Path长度。 修改Local_Preference属性local_Preference：默认100，越大越优先，只能在ibgp对等体之间传递 在R4上通过路由策略修改BGP路由172.16.2.0&#x2F;24的Local_Preference属性值，使得R3优选R4通告的BGP路由172.16.2.0&#x2F;24。 #创建IP前缀列表1，匹配BGP路由172.16.2.0&#x2F;24 [R4]ip ip-prefix 1 permit 172.16.2.0 24 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改Local_Preference属性值 [R4]route-policy hcip permit node 10 [R4-route-policy] if-match ip-prefix 1 [R4-route-policy] apply local-preference 200 [R4-route-policy] quit [R4]route-policy hcip permit node 20 注意创建一个空节点，对于另外3条BGP路由不执行任何操作。 #对向BGP对等体R3通告的BGP路由应用Route-Policy [R4]bgp 64512 [R4-bgp] peer 10.0.3.3 route-policy hcip export #在R4上触发出方向的软复位，刷新对外通告的BGP路由 refresh bgp all export #在R3上查看BGP路由172.16.2.0&#x2F;24的明细信息 此时R3优选R4通告的BGP路由172.16.2.0&#x2F;24，R2通告的BGP路由其Local_Preference值为100，小于R3通告的BGP路由Local_Preference值200，因此R2通告的BGP路由未被优选。 修改MED属性在R2上通过路由策略修改BGP路由172.16.3.0&#x2F;24的MED属性值，使得R3优选R5发布的BGP路由172.16.3.0&#x2F;24。 #创建IP前缀列表1，匹配BGP路由172.16.3.0&#x2F;24 [R2]ip ip-prefix 1 permit 172.16.3.0 24 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改MED属性值 [R2]route-policy hcip permit node 10 [R2-route-policy] if-match ip-prefix 1 [R2-route-policy] apply cost 200 [R2-route-policy] quit [R2]route-policy hcip permit node 20 注意创建一个空节点，对于另外3条BGP路由不执行任何操作。 #对来自BGP对等体R1的BGP路由应用Route-Policy [R2]bgp 64512 [R2-bgp] peer 10.0.12.1 route-policy hcip import #在R2上触发入方向的软复位，刷新接收到的BGP路由 refresh bgp all import #在R3上配置允许比较来自不同AS的BGP路由的MED值 [R3]bgp 64512 [R3-bgp] compare-different-as-med 缺省情况下，不比较来自不同AS邻居的BGP的MED属性值。 #在R3上查看BGP路由172.16.3.0&#x2F;24的明细信息 R2通告的BGP路由172.16.3.0&#x2F;24其MED值为200，而R4通告BGP路由MED值为0，R3优选MED值较小的BGP路由，因此R2通告的BGP路由未被优选。 修改preferred-value属性preferred-value：华为特有的属性值，仅在本地有效，当bgp存在到相同的路由时，将优选prefeerred-value大的路由。只能在路由器本地配置，只影响本设备的路由优选，不会传递给任何bgp对等体。 在R3上通过路由策略修改BGP路由172.16.4.0&#x2F;24的preferred-value属性值，使得R3优选R4通告的BGP路由172.16.4.0&#x2F;24。 #创建IP前缀列表1，匹配BGP路由172.16.4.0&#x2F;24 [R3]ip ip-prefix 1 permit 172.16.4.0 24 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改preferred-value属性值 [R3]route-policy hcip permit node 10 [R3-route-policy] if-match ip-prefix 1 [R3-route-policy] apply preferred-value 300 [R3-route-policy] quit [R3]route-policy hcip permit node 20 注意创建一个空节点，对于另外3条BGP路由不执行任何操作。 #对来自BGP对等体R4的BGP路由应用Route-Policy [R3]bgp 64512 [R3-bgp] peer 10.0.4.4 route-policy hcip import #在R3上触发入方向的软复位，刷新收到的BGP路由 refresh bgp all import #在R3上查看BGP路由172.16.4.0&#x2F;24的明细信息 R4通告的BGP路由172.16.3.0&#x2F;24其preferred-value值为300，而R2通告的preferred-value值为0，R3优选preferred-value值较大的BGP路由，因此R3优选R4通告的BGP路由。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"BGP路由优选","slug":"BGP路由优选","permalink":"http://example.com/tags/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/"}]},{"title":"BGP路由反射器","slug":"BGP路由反射器","date":"2023-11-28T08:48:20.000Z","updated":"2023-11-28T10:16:01.185Z","comments":true,"path":"2023/11/28/BGP路由反射器/","permalink":"http://example.com/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/","excerpt":"BGP路由反射器由于水平分割的原因，为了保证AS内所有的BGP路由器都能学习到完整的BGP路由，就必须在AS内实现IBGP全互联。 然而实现IBGP全互联存在诸多短板： 路由器需维护大量的TCP及BGP连接，尤其在路由器数量较多时。 AS内BGP网络的可扩展性较差，因为通过纯手工配置命令。 为了解决该问题，可应用到RR路由反射器技术。 1、Client：RR客户端，在RR设备上通过手动指定。 指定命令：peer 邻居 reflect-client 2、除了指定的设备为客户端，其它设备均为非客户端。 实验： R1、R2、R3、R4都属于AS64511，其连接方式、互联接口地址如图所示。每台设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号。R1、R2上的Loopback1地址分别为10.1.1.1&#x2F;24、10.2.2.2&#x2F;24，用于模拟用户网段。","text":"BGP路由反射器由于水平分割的原因，为了保证AS内所有的BGP路由器都能学习到完整的BGP路由，就必须在AS内实现IBGP全互联。 然而实现IBGP全互联存在诸多短板： 路由器需维护大量的TCP及BGP连接，尤其在路由器数量较多时。 AS内BGP网络的可扩展性较差，因为通过纯手工配置命令。 为了解决该问题，可应用到RR路由反射器技术。 1、Client：RR客户端，在RR设备上通过手动指定。 指定命令：peer 邻居 reflect-client 2、除了指定的设备为客户端，其它设备均为非客户端。 实验： R1、R2、R3、R4都属于AS64511，其连接方式、互联接口地址如图所示。每台设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号。R1、R2上的Loopback1地址分别为10.1.1.1&#x2F;24、10.2.2.2&#x2F;24，用于模拟用户网段。 所有设备都使用Loopback0地址作为BGP Router ID，R1与R2、R2与R3、R3与R4、R4与R2之间基于直连接口建立IBGP对等体关系，其中R1为R2的路由反射器客户端，R2为R3的路由反射器客户端，R3为R4的路由反射器客户端。 配置ip地址：略 建立ibgp对等体：略 配置路由反射器#R2上将R1配置为路由反射器客户端 [R2]bgp 64511 [R2-bgp] peer 10.0.1.1 reflect-client #R3上将R2配置为路由反射器客户端 [R3]bgp 64511 [R3-bgp] peer 10.0.2.2 reflect-client #R4上将R3配置为路由反射器客户端 [R4]bgp 64511 [R4-bgp] peer 10.0.3.3 reflect-client 验证Orginator_ID实现路由防环在本步骤中，我们将在R2上发布BGP路由10.2.2.0&#x2F;24，并观察该路由依次经路由反射器R3、R4反射后，被通告回R2从而引发潜在路由环路风险的情况。 缺省情况下，R2发布BGP路由后，该路由将被R2直接通告给R4，另一方面也会通过R3反射给R4，此时R4将优选R2直接通告过来的路由，从而不会再将R3反射过来的路由再反射回给R2。为此，我们需要在R2上部署路由策略，使R2不直接向R4通告10.2.2.0&#x2F;24路由。 #配置路由策略 [R2]acl number 2000 [R2-acl-basic-2000] rule 5 permit [R2-acl-basic-2000] quit [R2]route-policy bgp deny node 10 [R2-route-policy] if-match acl 2000 #在BGP中调用路由策略 [R2]bgp 64511 [R2-bgp] peer 10.0.24.4 route-policy bgp export #在R2上发布路由 [R2]bgp 64511 [R2-bgp] network 10.2.2.0 24 #R2上查看BGP路由10.2.2.0&#x2F;24的明细信息 R2将该条路由通告给了R3、R1，但是并未通告给R4。 #R3上查看BGP路由10.2.2.0&#x2F;24的明细信息 R3将来自反射器客户端的BGP路由10.2.2.0&#x2F;24反射给了10.0.34.4（R4）。同时该BGP路由的nexthop为10.0.23.2。 # R4上查看BGP路由10.2.2.0&#x2F;24的明细信息 该条路由来自反射器客户端R3，原始路由经由R3反射，路由的nexthop地址并未改变，同时R3为其添加了Orginator_ID属性，值为10.0.2.2。同时R4将该条路由反射给了R2。 #再次在R2上查看BGP路由10.2.2.0&#x2F;24的明细信息 依旧只存在本地通告的BGP路由，没有R4通告的BGP路由。 #在R2上查看BGP对等体10.0.4.4的详细信息 display bgp peer 10.0.4.4 verbose 从输出信息可以看到R2从R4收到了1个Update报文，未向R4发送Update报文（路由策略限制），但是本地BGP路由表中不存在由R4通告的BGP路由10.2.2.0&#x2F;24。 R4通告的BGP路由Orginator_ID属性值与本地的Router ID一致，R2忽略了该路由通告。 验证Cluster_List实现路由防环为了方便观察现象，取消R2上的BGP路由发布，在R1上将Loopback1接口路由发布到BGP，观察Cluster_List如何防止环路。 #取消R2上的BGP路由发布 [R2]bgp 64511 [R2-bgp] undo network 10.2.2.0 255.255.255.0 #在R1上将Loopback1接口路由发布到BGP [R1]bgp 64511 [R1-bgp] network 10.1.1.0 24 #依次在R1、R2、R3、R4上查看BGP路由10.1.1.0 &#x2F;24的明细信息 R1为BGP路由10.1.1.0&#x2F;24的始发者，R1将路由通告给了R2 来自路由反射器客户端R1的BGP路由10.1.1.0&#x2F;24，R2将其反射给了R3 来自路由反射器客户端R2的BGP路由10.1.1.0&#x2F;24，R2反射时添加了Cluster_List属性，值为10.0.2.2，R3将该条路由反射给了R4 来自路由反射器客户端R3的BGP路由10.1.1.0&#x2F;24，R3反射时添加了Cluster_List属性的值，当前值为10.0.3.3，10.0.2.2，R4将该条路由反射给了R2 #再次查看R2的BGP路由表 R2的BGP路由表中依旧只有一条来自r1的BGP路由10.1.1.0&#x2F;24。 4通告的BGP路由其Cluster_List属性值中包含了R2的Cluster-ID，R2忽略了该路由通告。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"BGP路由反射器","slug":"BGP路由反射器","permalink":"http://example.com/tags/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/"}]},{"title":"BGP实验","slug":"BGP实验","date":"2023-11-28T02:58:58.000Z","updated":"2023-11-28T07:45:03.915Z","comments":true,"path":"2023/11/28/BGP实验/","permalink":"http://example.com/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/","excerpt":"BGP基础实验设备连接方式、IP地址规划、BGP AS号如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号，所有设备都使用Loopback0接口IP地址作为BGP Router ID。R1、R5上存在Loopback1模拟用户网段。 R2、R3、R4之间运行OSPF，在R2、R3、R4的互联接口、Loopback0接口上激活OSPF。!","text":"BGP基础实验设备连接方式、IP地址规划、BGP AS号如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号，所有设备都使用Loopback0接口IP地址作为BGP Router ID。R1、R5上存在Loopback1模拟用户网段。 R2、R3、R4之间运行OSPF，在R2、R3、R4的互联接口、Loopback0接口上激活OSPF。! 实验背景你是公司的网络管理员。公司的网络采用了BGP协议作为路由协议。公司的网络由多个自治系统组成，不同的分支机构使用了不同的AS号，现在你需要完成公司网络的搭建工作。在公司总部使用了OSPF作为IGP，公司内部不同分支机构使用的是私有的BGP AS号。 1.配置ip如拓扑图配置各个接口ip，和loopback 0 ：10.0.x.x r1 loopback 1 ：10.1.1.1 24 r5 loopback 1 ：10.1.5.5 24 r2 r3 r4配置ospf：略 2.配置IBGP对等体在R2、R3、R4之间基于Loopback0接口建立全互联的IBGP对等体关系。 #R2上配置BGP [R2]bgp 64512 [R2-bgp] router-id 10.0.2.2 [R2-bgp] peer 10.0.3.3 as-number 64512 [R2-bgp] peer 10.0.3.3 connect-interface LoopBack0 [R2-bgp] peer 10.0.4.4 as-number 64512 [R2-bgp] peer 10.0.4.4 connect-interface LoopBack0 #R3上配置BGP [R3]bgp 64512 [R3-bgp] router-id 10.0.3.3 [R3-bgp] peer 10.0.2.2 as-number 64512 [R3-bgp] peer 10.0.2.2 connect-interface LoopBack0 [R3-bgp] peer 10.0.4.4 as-number 64512 [R3-bgp] peer 10.0.4.4 connect-interface LoopBack0 #R4上配置BGP [R4]bgp 64512 [R4-bgp] peer 10.0.2.2 as-number 64512 [R4-bgp] peer 10.0.2.2 connect-interface LoopBack0 [R4-bgp] peer 10.0.3.3 as-number 64512 [R4-bgp] peer 10.0.3.3 connect-interface LoopBack0 #分别在R2、R3、R4上检查BGP对等体状态 3.配置EBGP对等体（一般情况使用直连接口建立EBGp） 在R1与R2、R4与R5之间基于Loopback0接口建立EBGP对等体关系，为保证能够正常建立，在R1、R2上配置静态路由使Loopback0之间路由可达（R4、R5同样操作）。 #在R1、R2上配置静态路由 [R1]ip route-static 10.0.2.2 32 10.0.12.2 [R2]ip route-static 10.0.1.1 32 10.0.12.1 #在R4、R5上配置静态路由 [R4]ip route-static 10.0.5.5 32 10.0.45.5 [R5]ip route-static 10.0.4.4 32 10.0.45.4 这里配置静态路由，因为要建立TCP会话的前提，需要在数据层面两路由器相通，所以需要需要手工配置静态路由，实现loopback 0 之间互通 #配置R1、R2之间的EBGP对等体 [R1]bgp 64513 [R1-bgp] router-id 10.0.1.1 [R1-bgp] peer 10.0.2.2 as-number 64512 [R1-bgp] peer 10.0.2.2 ebgp-max-hop 2 [R1-bgp] peer 10.0.2.2 connect-interface LoopBack0 [R2]bgp 64512 [R2-bgp] peer 10.0.1.1 as-number 64513 [R2-bgp] peer 10.0.1.1 ebgp-max-hop 2 [R2-bgp] peer 10.0.1.1 connect-interface LoopBack0 默认情况下，EBGP连接允许的最大跳数为1，这导致EBGP对等体之间只能使用直连链路建立EBGP对等体关系，为使用环回口作为更新源需要手动修改EBGP连接允许的最大跳数。 #配置R4、R5之间的EBGP对等体 [R4]bgp 64512 [R4-bgp] peer 10.0.5.5 as-number 64514 [R4-bgp] peer 10.0.5.5 ebgp-max-hop 2 [R4-bgp] peer 10.0.5.5 connect-interface LoopBack0 [R5]bgp 64514 [R5-bgp] router-id 10.0.5.5 [R5-bgp] peer 10.0.4.4 as-number 64512 [R5-bgp] peer 10.0.4.4 ebgp-max-hop 2 [R5-bgp] peer 10.0.4.4 connect-interface LoopBack0 #在R1、R5上检查EBGP对等体状态 4.在BGP中发布路由在R1、R5上将Loopback1接口路由发布到BGP #在R1、R5上通过network命令发布路由 [R1]bgp 64513 [R1-bgp] network 10.1.1.1 24 [R5]bgp 64514 [R5-bgp] network 10.1.5.5 24 在R3上查看BGP路由表 可以看到此时R3上已经学习到R1、R5上发布的BGP路由，但是都是非有效路由，这是因为它们的下一跳在R3上都不可达，为此可以在R2、R4上通过next-hop-local命令修改下一跳地址为R2、R4的更新源地址。 原因：ebgp对等体在发送数据时，下一跳地址为自身更新源地址，ibgp收到ebgp发送的数据，下一跳不变 #在R2、R4上将路由的下一跳地址修改为自身 [R2]bgp 64512 [R2-bgp] peer 10.0.3.3 next-hop-local [R2-bgp] peer 10.0.4.4 next-hop-local [R4]bgp 64512 [R4-bgp] peer 10.0.2.2 next-hop-local [R4-bgp] peer 10.0.3.3 next-hop-local peer next-hop-local命令一般在ASBR上配置。当设备通过EBGP邻居学到路由再转发给其他IBGP邻居时，默认不修改下一跳，但其EBGP邻居发来的路由的下一跳都是其EBGP邻居的Peer地址，本端对等体所属AS域内的IBGP邻居收到这样的路由后，由于下一跳不可达导致路由无法活跃。因此，需要在ASBR上对IBGP邻居配置peer next-hop-local命令，使得发给IBGP邻居的路由的下一跳是其自身的地址，IBGP邻居收到这样的路由后（由于域内都配置了IGP）发现下一跳可达，路由即为活跃路由。 此命令为覆盖式命令。 执行peer next-hop-local命令后，设备向IBGP对等体&#x2F;对等体组通告路由时，把下一跳属性设为自身的IP地址。 peer next-hop-local命令仅应用于IBGP对等体间。 再次r3上查看bgp路由表 此时两条BGP路由都变成了有效、最优的状态。 #在R1、R5上查看BGP路由表 R1、R5之间相互学习到了对端Loopback1接口路由。 BGP路由汇总实验 BGP AS号、互联地址如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号。 R1、R2、R3使用Loopback0地址作为BGP Router ID，基于直连接口建立EBGP对等体关系。 R1、R3上存在Loopback1、Loopback2接口，用于模拟用户网段。 1.配置ip略 2.配置EBGPd对等体#配置R1 [R1]bgp 64511 [R1-bgp] router-id 10.0.1.1 [R1-bgp] peer 10.0.12.2 as-number 64512 #配置R2 #配置R3 [R3]bgp 64513 [R3-bgp] router-id 10.0.3.3 [R3-bgp] peer 10.0.23.2 as-number 64512 3.BGP路由自动汇总在R1上开启BGP路由自动汇总，将Loopback1、Loopback2接口路由发布到BGP中，并进行自动汇总。 #创建IP前缀列表1，匹配Loopback1、Loopback2接口路由 [R1]ip ip-prefix 1 permit 172.16.0.0 16 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1 [R1]route-policy hcip permit node 10 [R1-route-policy] if-match ip-prefix 1 [R1-route-policy] quit [R1]bgp 64511 [R1-bgp] import-route direct route-policy hcip [R1-bgp] summary automatic Info: Automatic summarization is valid only for the routes imported through the import-route command. 自动汇总只对通过import-route命令引入的路由生效。 #在R1上查看BGP路由表 display bgp routing-table Loopback1、Loopback2接口路由已经发布到BGP，由于R1激活了BGP路由自动汇总，因此R1会将这些路由汇总成172.16.0.0&#x2F;16，同时抑制所有的明细路由，通过明细路由前的“s”标记可以看出，该标记的含义为“suppressed”，表示被抑制，最终R1只对外通告汇总路由172.16.0.0&#x2F;16。 #在R2上查看BGP路由表 display bgp routing-table R2上只能看到一条主类路由172.16.0.0&#x2F;16。 #在R2上查看BGP路由172.16.0.0的明细信息 display bgp routing-table 172.16.0.0 该路由的路径属性中存在Aggregator属性，其中携带了汇总路由生成设备所属的AS号以及其Router ID 4.BGP路由手动汇总在R3上将Loopback1、Loopback2接口路由发布到BGP，在R2上通过aggregate命令执行手动汇总，并抑制明细路由的对外发布。 #创建IP前缀列表1，匹配Loopback1、Loopback2接口路由 [R3]ip ip-prefix 1 permit 172.17.0.0 16 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1 [R3]route-policy hcip permit node 10 [R3-route-policy] if-match ip-prefix 1 [R3-route-policy] quit #将Loopback1、Loopback2接口路由发布到BGP [R3]bgp 64513 [R3-bgp] import-route direct route-policy hcip #查看R2的BGP路由表 display bgp routing-table ​ 在R2的BGP路由表中已经存在R3通告的BGP路由172.17.1.0&#x2F;24、172.17.2.0&#x2F;24。 #R2上执行手动路由汇总，将172.17.1.0&#x2F;24、172.17.2.0&#x2F;24汇总成172.17.0.0&#x2F;22，并抑制明细路由的对外通告 [R2]bgp 64512 [R2-bgp] aggregate 172.17.0.0 22 detail-suppressed #查看R2的BGP路由表 display bgp routing-table ​ 此时在R2的BGP路由表中可以看到汇总后的路由。 #在R2上查看BGP路由172.16.0.0&#x2F;22的明细信息 display bgp routing-table 172.17.0.0 22 从输出信息可以看到AS_Path值为Nil，代表了AS_Path属性值为空，这意味着丢失了明细的AS_Path属性值，BGP依赖AS_Path实现防环，因此AS_Path属性的丢失可能带来路由环路。从该条路由对外通告的对等体中可以看到10.0.23.3（R3)。 #查看R3的BGP路由表 在R3的BGP路由表中可以看到汇总路由172.17.0.0&#x2F;22。 #为防止路由环路，在R2上执行手动汇总时增加as-set关键字 [R2]bgp 64512 [R2-bgp] aggregate 172.17.0.0 255.255.252.0 detail-suppressed as-set #再次在R2上查看BGP路由172.17.0.0&#x2F;22的明细信息 可以看到此时AS_Path属性值为64513，此时该条路由依旧向10.0.23.3（R3）通告。 R3收到关于172.17.0.0&#x2F;22的通告之后，在AS_Path中将看到自身的AS号（64153），将会忽略该路由通告。此时R3的BGP路由表中无法看到汇总路由172.17.0.0&#x2F;22，因此通过在手动路由汇总的配置中使用as-set关键字顺利地规避了路由环路的产生。 BGP路由反射器","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"BGP","slug":"BGP","permalink":"http://example.com/tags/BGP/"}]},{"title":"路由策略","slug":"路由策略","date":"2023-11-26T12:36:59.000Z","updated":"2023-11-26T13:26:00.594Z","comments":true,"path":"2023/11/26/路由策略/","permalink":"http://example.com/2023/11/26/%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5/","excerpt":"设备互联方式、互联地址如图所示，所有设备均创建Loopback0，其IP地址为10.0.x.x&#x2F;32，其中x为设备编号，R1、R2、R3在互联接口、Loopback0接口上激活OSPF。 R3、R4属于IS-IS Area 49.0001，两者都是Level-1路由器，R3、R4的系统ID采用0000.0000.000x格式，其中x为设备编号。","text":"设备互联方式、互联地址如图所示，所有设备均创建Loopback0，其IP地址为10.0.x.x&#x2F;32，其中x为设备编号，R1、R2、R3在互联接口、Loopback0接口上激活OSPF。 R3、R4属于IS-IS Area 49.0001，两者都是Level-1路由器，R3、R4的系统ID采用0000.0000.000x格式，其中x为设备编号。 R1上存在三个业务网段A、B、C（使用Loopback1、2、3接口路由模拟），在R1上将直连路由引入到OSPF，但是OSPF域内的路由器上不需要C业务的路由，为此在R1上引入直连路由时通过Route-Policy过滤引入的路由。 R2上不需要A业务网段的路由，但是R3上需要A、B业务网段的路由，为此在R2上配置Filter-Policy对OSPF接收的路由进行过滤。 IS-IS域内的路由器需要访问A业务，因此需要在R3上执行路由重分发，将OSPF路由引入到IS-IS，但是IS-IS域内的路由器不需要访问B业务，为此在R1上引入直连路由时为A、B业务网段路由打上不同的路由标记，R3上执行重分发时根据路由标记过滤B业务网段路由。 任务思路 设备基础IP地址配置。 配置R1、R2、R3之间的OSPF，在互联接口、Loopback0接口上激活OSPF。在R3、R4之间配置IS-IS。 在R1上将直连路由引入到OSPF中，同时配置路由策略不引入C业务网段的路由，将A、B业务网段路由分别打上路由标记10、20。 在R2上配置Filter-Policy对接收的OSPF路由进行过滤，只接收B业务网段的路由。 在R3上将OSPF路由引入到IS-IS中，通过Route-Policy匹配路由标记，只引入A业务网段的OSPF外部路由。 1.配置ip#配置R1的GE0&#x2F;0&#x2F;2、Loopback0接口IP地址 [R1]interface GigabitEthernet0&#x2F;0&#x2F;2 [R1-GigabitEthernet0&#x2F;0&#x2F;2] ip address 10.0.12.1 255.255.255.0 [R1-GigabitEthernet0&#x2F;0&#x2F;2] quit [R1]interface LoopBack0 [R1-LoopBack0] ip address 10.0.1.1 255.255.255.255 [R1-LoopBack0] quit #在R1上创建多个环回口，用于模拟业务网段A、B、C [R1]interface LoopBack1 [R1-LoopBack1] ip address 172.16.1.1 255.255.255.0 [R1-LoopBack1] quit [R1]interface LoopBack2 [R1-LoopBack2] ip address 172.16.2.1 255.255.255.0 [R1-LoopBack2] quit [R1]interface LoopBack3 [R1-LoopBack3] ip address 172.16.3.1 255.255.255.0 [R1-LoopBack3] quit #配置R2的GE0&#x2F;0&#x2F;2、GE0&#x2F;0&#x2F;3、Loopback0接口IP地址 [R2]interface LoopBack0 [R2-LoopBack0] ip address 10.0.2.2 255.255.255.255 [R2-LoopBack0] quit [R2]interface GigabitEthernet0&#x2F;0&#x2F;2 [R2-GigabitEthernet0&#x2F;0&#x2F;2] ip address 10.0.23.2 255.255.255.0 [R2-GigabitEthernet0&#x2F;0&#x2F;2] quit [R2]interface GigabitEthernet0&#x2F;0&#x2F;3 [R2-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.0.12.2 255.255.255.0 [R2-GigabitEthernet0&#x2F;0&#x2F;3] quit #配置R3的GE0&#x2F;0&#x2F;2、GE0&#x2F;0&#x2F;3、Loopback0接口IP地址 [R3]interface LoopBack0 [R3-LoopBack0] ip address 10.0.3.3 255.255.255.255 [R3-LoopBack0] quit [R3]interface GigabitEthernet0&#x2F;0&#x2F;2 [R3-GigabitEthernet0&#x2F;0&#x2F;2] ip address 10.0.34.3 255.255.255.0 [R3-GigabitEthernet0&#x2F;0&#x2F;2] quit [R3]interface GigabitEthernet0&#x2F;0&#x2F;3 [R3-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.0.23.3 255.255.255.0 [R3-GigabitEthernet0&#x2F;0&#x2F;3] quit #配置R4的GE0&#x2F;0&#x2F;3、Loopback0接口IP地址 [R4]interface GigabitEthernet0&#x2F;0&#x2F;3 [R4-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.0.34.4 255.255.255.0 [R4-GigabitEthernet0&#x2F;0&#x2F;3] quit [R4]interface LoopBack0 [R4-LoopBack0] ip address 10.0.4.4 255.255.255.255 [R4-LoopBack0] quit #在R2、R4上检查IP地址连通性 2.配置ospf和isis#配置R1 [R1]ospf 1 router-id 10.0.1.1 [R1-ospf-1] area 0 [R1-ospf-1-area-0.0.0.0] network 10.0.1.1 0.0.0.0 [R1-ospf-1-area-0.0.0.0] network 10.0.12.1 0.0.0.0 [R1-ospf-1-area-0.0.0.0] quit [R1-ospf-1] quit #配置R2 [R2]ospf 1 router-id 10.0.2.2 [R2-ospf-1] area 0.0.0.0 [R2-ospf-1-area-0.0.0.0] network 10.0.2.2 0.0.0.0 [R2-ospf-1-area-0.0.0.0] network 10.0.12.2 0.0.0.0 [R2-ospf-1-area-0.0.0.0] network 10.0.23.2 0.0.0.0 [R2-ospf-1-area-0.0.0.0] quit [R2-ospf-1] quit #配置R3 [R3]ospf 1 router-id 10.0.3.3 [R3-ospf-1] area 0.0.0.0 [R3-ospf-1-area-0.0.0.0] network 10.0.3.3 0.0.0.0 [R3-ospf-1-area-0.0.0.0] network 10.0.23.3 0.0.0.0 [R3-ospf-1-area-0.0.0.0] quit [R3-ospf-1] quit #在R2上检查OSPF邻居的概要信息 R3、R4上配置IS-IS，区域为49.0001，系统ID采用0000.0000.000x格式（x为设备编号），两台设备都为Level-1路由器，在互联接口、R4的Loopback0接口上激活IS-IS。 #配置R3 [R3]isis 1 [R3-isis-1] is-level level-1 [R3-isis-1] network-entity 49.0001.0000.0000.0003.00 [R3-isis-1] quit [R3]interface GigabitEthernet0&#x2F;0&#x2F;2 [R3-GigabitEthernet0&#x2F;0&#x2F;2] isis enable 1 [R3-GigabitEthernet0&#x2F;0&#x2F;2] quit #配置R4 [R4]isis 1 [R4-isis-1] is-level level-1 [R4-isis-1] network-entity 49.0001.0000.0000.0004.00 [R4-isis-1] quit [R4]interface GigabitEthernet0&#x2F;0&#x2F;3 [R4-GigabitEthernet0&#x2F;0&#x2F;3] isis enable 1 [R4-GigabitEthernet0&#x2F;0&#x2F;3] quit [R4]interface LoopBack 0 [R4-LoopBack0] isis enable 1 [R4-LoopBack0] quit #在R3上检查IS-IS邻居状态 3.在R1上引入直连路由在R1上将直连路由引入到OSPF中，同时配置路由策略过滤C业务网段，将A、B业务网段路由分别打上路由标记10、20。 #创建IP前缀列表1，匹配Loopback1接口路由（A业务网段） [R1]ip ip-prefix 1 index 10 permit 172.16.1.0 24 greater-equal 24 less-equal 24 #创建IP前缀列表2，匹配Loopback2接口路由（B业务网段） [R1]ip ip-prefix 2 index 10 permit 172.16.2.0 24 greater-equal 24 less-equal 24 #创建Route-Policy hcip，并创建节点10、20，分别调用IP前缀列表1、2，打上路由标记 [R1]route-policy hcip permit node 10 [R1-route-policy] if-match ip-prefix 1 [R1-route-policy] apply tag 10 [R1-route-policy] quit [R1]route-policy hcip permit node 20 [R1-route-policy] if-match ip-prefix 2 [R1-route-policy] apply tag 20 [R1-route-policy] quit #在R1的OSPF中引入直连路由，调用Route-Policy hcip [R1]ospf 1 [R1-ospf-1] import-route direct route-policy hcip r1上查看ospf lsdb，Loopback1、2接口路由已经被成功引入OSPF中。 #在R1上查看OSPF LSDB中AS-external LSA 172.16.1.0的相关信息 [R1]display ospf lsdb ase 172.16.1.0 ​ OSPF Process 1 with Router ID 10.0.1.1 ​ Link State Database Type : External Ls id : 172.16.1.0 Adv rtr : 10.0.1.1 Ls age : 165 Len : 36 Options : E seq# : 80000001 chksum : 0xa954 Net mask : 255.255.255.0 TOS 0 Metric: 1 E type : 2 Forwarding Address : 0.0.0.0 Tag : 10 Priority : Low 外部路由172.16.1.0&#x2F;24已经被打上Tag 10。 #在R1上查看OSPF LSDB中AS-external LSA 172.16.2.0的相关信息 [R1]display ospf lsdb ase 172.16.2.0 ​ OSPF Process 1 with Router ID 10.0.1.1 ​ Link State Database Type : External Ls id : 172.16.2.0 Adv rtr : 10.0.1.1 Ls age : 355 Len : 36 Options : E seq# : 80000001 chksum : 0x539f Net mask : 255.255.255.0 TOS 0 Metric: 1 E type : 2 Forwarding Address : 0.0.0.0 Tag : 20 Priority : Low 外部路由172.16.2.0&#x2F;24已经被打上Tag 20。 4.在R2上配置过滤策略在R2上配置Filter-Policy对接收的OSPF路由进行过滤，只接收B业务网段的路由。 #查看配置Filter-Policy前的OSPF路由表 display ospf routing #查看配置Filter-Policy前的IP路由表中的OSPF路由 display ip routing-table protocol ospf 在OSPF路由表以及IP路由表中都可以看到OSPF外部路由172.16.1.0&#x2F;24、172.16.2.0&#x2F;24。 #配置基础ACL [R2]acl number 2000 [R2-acl-basic-2000] rule 5 deny source 172.16.1.0 0.0.0.255 [R2-acl-basic-2000] rule 10 permit #在OSPF中部署入方向的Filter-Policy，调用ACL 2000 [R2]ospf 1 [R2-ospf-1] filter-policy 2000 import #查看配置Filter-Policy后的OSPF路由表 dis ospf routing 发现两条外部路由都还存在 #查看配置Filter-Policy后的IP路由表中的OSPF路由 display ip routing-table protocol ospf 在IP路由表中路由172.16.2.0&#x2F;24已经不存在，但是在OSPF路由表中依旧存在。这验证了对于OSPF，Filter-Policy只是限制路由加入IP路由表，不影响本地的LSDB以及LSA的传递。 #在R3上查看IP路由表中的OSPF路由 display ip routing-table protocol ospf R3的IP路由表中OSPF外部路由172.16.1.0&#x2F;24、172.16.2.0&#x2F;24依旧存在。 5.在R3上将OSPF路由引入到IS-IS在R3上将OSPF路由引入到IS-IS中，通过Route-Policy匹配路由标记，只引入A业务网段的OSPF外部路由。 #创建Route-Policy hcip [R3]route-policy hcip permit node 10 [R3-route-policy] if-match tag 10 [R3-route-policy] quit #在IS-IS中引入OSPF路由，调用Route-Policy hcip只引入A业务网段的OSPF外部路由 [R3]isis 1 [R3-isis-1] import-route ospf 1 level-1 route-policy hcip （注意指定level） #查看R3的IS-IS路由表 display isis route Level-1的路由重分发表中只有172.16.1.0&#x2F;24。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"路由策略","slug":"路由策略","permalink":"http://example.com/tags/%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5/"}]},{"title":"nat实验","slug":"nat实验","date":"2023-11-25T12:41:12.000Z","updated":"2023-11-25T13:54:42.229Z","comments":true,"path":"2023/11/25/nat实验/","permalink":"http://example.com/2023/11/25/nat%E5%AE%9E%E9%AA%8C/","excerpt":"静态nat静态NAT实现了私有地址和公有地址的一对一映射。如果希望一台主机优先使用某个关联地址，或者想要外部网络使用一个指定的公网地址访问内部服务器时，可以使用静态NAT。但是在大型网络中，这种一对一的IP地址映射无法缓解公用地址短缺的问题。","text":"静态nat静态NAT实现了私有地址和公有地址的一对一映射。如果希望一台主机优先使用某个关联地址，或者想要外部网络使用一个指定的公网地址访问内部服务器时，可以使用静态NAT。但是在大型网络中，这种一对一的IP地址映射无法缓解公用地址短缺的问题。 静态NAT实现了私有地址和共有地址一对一的映射（一个私有地址对应一个共有地址），并没有做到缓解地址短缺的问题，只是做到了地址转换。 一个公网地址只会分配给唯一且固定的内网地址 如图配置ip地址和网关 r1上配置静态nat（注意是在公网的接口上，出接口） 注意配置一条静态路由，不然没有路由的下一跳会被丢弃 在r1上查看nat映射关系：dis nat static 验证一下： 发现去往2.2.2.2的源地址变为2.2.2.3，说明nat完成转换。 静态nat两种配置方式： 1.接口下（上述实验采用这种方式）：进入到连接外网路由器的出接口下，然后在接口视图下配置nat映射关系 2.全局：在全局视图下，配置好nat映射关系，再进入到出接口，执行：nat static enable 动态nat动态NAT通过使用地址池来实现。 如上图，当内部主机A和主机B需要与公网中的目的主机通信时，网关RTA会从配置的公网地址池中选择一个未使用的公网地址与之做映射。每台主机都会分配到地址池中的一个唯一地址。当不需要此连接时，对应的地址映射将会被删除，公网地址也会被恢复到地址池中待用。当网关收到回复报文后，会根据之前的映射再次进行转换之后转发给对应主机。 注意： 动态NAT实际上实现的还是私有地址和公有地址一对一的关系，但是共有地址不再绑定给特定的内网地址。实现了一定程度的缓解地址短缺问题。动态NAT地址池中的地址用尽以后，只能等待被占用的公用IP被释放后，其他主机才能使用它来访问公网。 动态NAT转换流程：1）路由器上配置一个内部地址池（公司内部所有主机用到的私有IP）动态映射一个外部地址池（所购买的公有IP）。2）当有一个内网主机访问外网时，路由器首先查看NAT地址转换表；3）若无，则再查看是否配置了动态NAT映射，若配置，则将IP包头中的源IP与内部地址池进行匹配，若有匹配项，则将该内网IP从内部地址池中取出，同时取出外部地址池中的一个IP地址，动态形成NAT地址转换表。注意，外部地址池的公网IP地址取出后，外部地址池中将没有该公网IP了。4）默认当该主机24小时没有联系外网时，该动态NAT条目会自动消失，所被取出的公私有地址重新回到地址池中。 ip如图，pc的网关192.168.1.254 r1上配置默认路由，ip route-static 0.0.0.0 0 172.16.1.2 r1上配置动态地址池： 地址池验证： 配置acl策略： 在r1的外网出接口上调用： 验证： 其中源IP为3、4、5不定，说明是在动态分配外网地址。动态NAT配置完成。 在动态NAT实验中，最后利用PC1测试连通性时，间歇性会丢包 可能的原因：ping的时候默认按地址池中可用地址顺序从1~254进行地址转换，放大nat地址池可解决。 NAPT 如上图，RTA收到一个私网主机发送的报文，源IP地址是192.168.1.1，源端口号是1025，目的IP地址是100.1.1.1，目的端口是80。RTA会从配置的公网地址池中选择一个空闲的公网IP地址和端口号，并建立相应的NAPT表项。这些NAPT表项指定了报文的私网IP地址和端口号与公网IP地址和端口号的映射关系。之后，RTA将报文的源IP地址和端口号转换成公网地址200.10.10.1和端口号2843，并转发报文到公网。当网关RTA收到回复报文后，会根据之前的映射表再次进行转换之后转发给主机A。主机B同理。 注意： NAPT技术允许多个内部地址映射到同一个公有地址的不同端口。NAPT实现了私有地址对共有地址多对一 相当于一种特殊的动态nat 1、端口NAT和动态NAT的配置过程基本一致，只是在应用到接口时，配置命令少no-pat2、端口NAT一个地址可以给多个源地址转换，不是单对单的转换，所以节省了nat地址！3、端口NAT实际应用较多，静态NAT和动态NAT因为地址不能节约，所以实际应用少 Easy IP Easy IP本质上是NAPT（所以原理与NAPT大致相似）由于网关设备出接口IP地址为公网地址，所以可以利用该出接口地址来作为地址转换的公有地址。Easy IP适用于小规模局域网中的主机访问Internet的场景。小规模局域网通常部署在小型的网吧或者办公室中，这些地方内部主机不多，出接口可以通过拨号方式获取一个临时公网IP地址。Easy IP可以实现内部主机使用这个临时公网IP地址访问Internet。 Easy IP适用于小规模局域网中的主机访问Internet的场景。小规模局域网通常部署在小型的网吧或者办公室中，这些地方内部主机不多，出接口可以通过拨号方式获取一个临时公网IP地址。Easy IP可以实现内部主机使用这个临时公网IP地址访问Internet。 Easy IP的配置：1.创建ACL：acl 2000 2.允许1.0的数据进行转换：rule 5 permit source 192.168.1.0 0 .0.0.255 3.进入公网出接口 4.应用acl：nat outbound 2000 （相较于napt少了地址池） 验证： 源地址为出接口地址172.16.1.1，只是端口不同","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"nat","slug":"nat","permalink":"http://example.com/tags/nat/"}]},{"title":"DHCP基础配置","slug":"DHCP基础配置","date":"2023-11-25T06:34:51.000Z","updated":"2023-12-03T13:57:57.899Z","comments":true,"path":"2023/11/25/DHCP基础配置/","permalink":"http://example.com/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/","excerpt":"DHCP是一种终端自动配置协议，客户端通过DHCP协议可获取一个合法的动态IP地址。","text":"DHCP是一种终端自动配置协议，客户端通过DHCP协议可获取一个合法的动态IP地址。 概述随着网络规模的扩大和网络复杂度的提高，网络配置越来越复杂，经常出现计算机位置变化（如便携机或无线网络）和计算机数量超过可分配的IP地址的情况。动态主机配置协议DHCP（Dynamic Host Configuration Protocol）就是为满足这些需求而发展起来的。DHCP协议以服务器&#x2F;客户端（Server&#x2F;Client）模式工作，DHCP客户端向DHCP服务器动态地请求配置信息，DHCP服务器可以很方便地为客户端动态发送配置信息。 DHCP服务器DHCP Server即DHCP服务器，负责客户端IP地址的分配。客户端向服务器发送配置申请报文（包括IP地址、子网掩码、缺省网关等参数），服务器根据策略返回携带相应配置信息的报文，请求报文和回应报文都采用UDP进行封装。 DHCP中继DHCP Relay即DHCP中继，它是为解决服务器和客户端不在同一个网段而提出来的，它提供了对DHCP广播报文的透明传输功能，能够把DHCP客户端的广播报文透明地传送到其它网段的DHCP服务器上，同样能够把DHCP服务器端的广播报文透明地传送到其它网段的DHCP客户端。 基本命令基本命令pc： ipconfig &#x2F;release—释放ip地址ipconfig &#x2F;renew—重新获取ip 将DHCP转化为固定的地址： ip pool 名字—进入地址池staic-bind ip-address 要分配的固定ip mac-address 目标的mac地址—添加固定地址到pc端lease day &lt;0-999&gt;—修改租期（不建议修改） 将部分ip地址排除地址池，用于静态路由配置 ip pool 名字—进入地址池excluded-ip-address 192.168.1.1 192.168.1.50—把1.1到1.50的地址排除出地址池不使用 重置与查看地址池 reset ip pool name 名字—重置ip配置dis ip pool name 名字—查看指定地址池dis ip pool—查看地址池dis ip pool 名字 used—查看使用情况 配置global全局模式 先配置物理接口 interface 接口号—进入物理接口ip address ip地址—配置物理接口IP DHCP enable—开启DHCP功能ip pool 名字—创建一个ip地址池（有几个网段就建几个池）network 192.168.1.0 mask 24—给ip地址池添加一个网段gateway-list 192.168.1.1—设置192.168.1.1这个ip地址为网关dns-list 8.8.8.8 192.168.1.1—配置DNS为8.8.8.8（前面的优先）interface ip地址—进入物理接口dhcp select global—给接口配置全局模式 将pc更改为DHCP获取IP方式，就可以自动分配ip地址了 interface配置方式基于接口的DHCP的配置方式：配置物理接口的ip网关： interface 接口号—进入接口ip address IP网关—配置网关 dhcp enable—开启服务dhcp select interface—选择interface这个配置方式dhcp server dns-list 8.8.8.8-–配置DNS服务 注意：这种配置方式分配的ip地址网段，是该接口所在的网段的ip地址，网关就是这个接口的ip地址 relay（中继）配置方式 用于在服务器上做配置，路由器进行转发，减少负载量，可以对整个网络体系进行配置首先要实现服务器与个网段互通在服务器的配置： 服务器物理接口配置ipip route-static 0.0.0.0 0 下一跳的ip—服务器配置缺省路由保证互通dhcp enable—在服务器开启dhcp功能ip pool 名字—创建ip地址池（需要几个网段就创建几个地址池）network 192.168.1.0 mask 24—创建网段gateway-list 192.168.1.1—创建网关dns-list 8.8.8.8—创建dnsinterface 物理接口—进入物理接口dhcp select global—选择全局配置模式 在路由器&#x2F;核心交换机上的配置 dhcp enable—开启dhcp功能interface 接口号—进入接口 （需要几个网段就分别进入配置）dhcp select relay—开启中继模式dhcp relay server-ip 服务器物理ip—选择中继分配的接口 基本实验 R1和R3模拟客户端，作为DHCP Client。 R2作为DHCP Server为R1和R3分配IP地址。 动态主机配置协议DHCP（Dynamic Host Configuration Protocol）是一种用于集中对用户IP地址进行动态管理和配置的技术。即使规模较小的网络，通过DHCP也可以使后续增加网络设备变得简单快捷。 DHCP协议由RFC 2131定义，采用客户端&#x2F;服务器通信模式，由客户端（DHCP Client）向服务器（DHCP Server）提出配置申请，服务器返回为客户端分配的配置信息。 DHCP可以提供两种地址分配机制，网络管理员可以根据网络需求为不同的主机选择不同的分配策略。 • 动态分配机制：通过DHCP为主机分配一个有使用期限（这个使用期限通常叫做租期）的IP地址。这种分配机制适用于主机需要临时接入网络或者空闲地址数小于网络主机总数且主机不需要永久连接网络的场景。 • 静态分配机制：网络管理员通过DHCP为指定的主机分配固定的IP地址。相比手工静态配置IP地址，通过DHCP方式静态分配机制避免人工配置发生错误，方便管理员统一维护管理。 配置R2 ip：略 开启DHCP功能[R1]dhcp enable Info: The operation may take a few seconds. Please wait for a moment.done. dhcp enable命令是DHCP相关功能的总开关，DHCP Client和DHCP Server等功能都要在执行dhcp enable命令使能DHCP功能后才会生效。 [R2]dhcp enable Info: The operation may take a few seconds. Please wait for a moment.done. [R3]dhcp enable Info: The operation may take a few seconds. Please wait for a moment.done. 配置地址池# 配置R2的GigabitEthernet 0&#x2F;0&#x2F;0的接口地址池，为R1分配IP地址 [R2]interface GigabitEthernet 0&#x2F;0&#x2F;0 [R2-GigabitEthernet0&#x2F;0&#x2F;0]dhcp select interface dhcp select interface命令用来开启接口采用接口地址池的DHCP Server功能。若不执行此命令，则无法配置接口地址池的相关参数。 [R2-GigabitEthernet0&#x2F;0&#x2F;0]dhcp server dns-list 10.0.12.2 dhcp server dns-list命令用来指定接口地址池下的DNS服务器地址。最多可以配置8个DNS Server的IP地址，用空格分隔。 # 配置全局地址池 [R2]ip pool GlobalPool Info: It’s successful to create an IP address pool. 创建名为G**lobalPool的地址池 [R2-ip-pool-GlobalPool]network 10.0.23.0 mask 24 network命令用来配置全局地址池下可分配的网段地址。 [R2-ip-pool-GlobalPool]dns-list 10.0.23.2 [R2-ip-pool-GlobalPool]gateway-list 10.0.23.2 gateway-list命令用来为DHCP Client配置出口网关地址。R3在获取地址之后，会生成一条默认路由，下一跳地址为10.0.23.2。 [R2-ip-pool-GlobalPool]lease day 2 hour 2 lease命令用来配置地址池下的地址租期。当租约被设置为unlimited时，代表租期无限制。缺省情况下，IP地址租期是1天。 [R2-ip-pool-GlobalPool]static-bind ip-address 10.0.23.3 mac-address 00e0-fc6f-6d1f static-bind命令用来将DHCP Server全局地址池下的IP地址与MAC地址进行绑定。00e0-fc6f-6d1f为当前实验环境下R3的GigabitEthernet0&#x2F;0&#x2F;0接口的MAC地址，可以在R3上通过命令“display interface GigabitEthernet0&#x2F;0&#x2F;0”来查看接口的MAC地址。配置完这条命令之后，R3会获得固定的IP–10.0.23.3。 [R2-ip-pool-GlobalPool]quit #开启R2 GigabitEthernet 0&#x2F;0&#x2F;1接口的DHCP Server功能，为R3分配IP地址 [R2]interface GigabitEthernet 0&#x2F;0&#x2F;1 [R2-GigabitEthernet0&#x2F;0&#x2F;1]dhcp select global dhcp select global命令用来开启接口采用全局地址池的DHCP Server功能。当接口收到DHCP Client请求之后，会到所有全局地址池中查找对应的地址池，然后分配可用的地址给DHCP Client。 配置DHCP Client[R1]interface GigabitEthernet 0&#x2F;0&#x2F;0 [R1-GigabitEthernet0&#x2F;0&#x2F;0] ip address dhcp-alloc [R3]interface GigabitEthernet 0&#x2F;0&#x2F;0 [R3-GigabitEthernet0&#x2F;0&#x2F;0] ip address dhcp-alloc 结果验证查看R1和R3的地址及路由等信息[R1]display ip interface brief Interface IP Address&#x2F;Mask Physical Protocol GigabitEthernet0&#x2F;0&#x2F;0 10.0.12.254&#x2F;24 up up 仅保留关键信息，可以看到R1已经获取到了IP地址**。 [R1]display dns server Type: D:Dynamic S:Static No. Type IP Address 1 D 10.0.12.2 仅保留关键信息，可以看到R1已经获取到了DNS地址**。 [R1]display ip routing-table Destination&#x2F;Mask Proto Pre Cost Flags NextHop Interface 0.0.0.0&#x2F;0 Unr 60 0 D 10.0.12.2 GigabitEthernet0&#x2F;0&#x2F;0 仅保留关键信息，可以看到R1已经获取到了默认路由**。 [R3]display ip interface brief Interface IP Address&#x2F;Mask Physical Protocol GigabitEthernet0&#x2F;0&#x2F;0 10.0.23.3&#x2F;24 up up 仅保留关键信息，可以看到R3已经获取到了固定的IP地址**。 [R3]display dns server Type: D:Dynamic S:Static No. Type IP Address 1 D 2.23.0.10 仅保留关键信息，可以看到R3已经获取到了DNS地址**。 [R3]display ip routing-table Route Flags: R - relay, D - download to fib -—————————————————————————– Routing Tables: Public ​ Destinations : 8 Routes : 8 Destination&#x2F;Mask Proto Pre Cost Flags NextHop Interface 0.0.0.0&#x2F;0 Unr 60 0 D 10.0.23.2 GigabitEthernet0&#x2F;0&#x2F;0 仅保留关键信息，可以看到R3已经获取到了默认路由**。 2、查看R2上的地址分配情况[R2]display ip pool name GlobalPool Pool-name : GlobalPool Pool-No : 1 Lease : 2 Days 2 Hours 0 Minutes Domain-name : - DNS-server0 : 10.0.23.2 NBNS-server0 : - Netbios-type : - Position : Local Status : Unlocked Gateway-0 : 10.0.23.2 Mask : 255.255.255.0 VPN instance : – -—————————————————————————- ​ Start End Total Used Idle(Expired) Conflict Disable -—————————————————————————- ​ 10.0.23.1 10.0.23.254 253 1 252(0) 0 0 -—————————————————————————- display ip pool命令用来查看已配置的IP地址池信息。包括地址池的名称、租期、锁定状态、地址池中IP地址的状态等。 [R2]display ip pool interface GigabitEthernet0&#x2F;0&#x2F;1 Pool-name : GigabitEthernet****0&#x2F;0&#x2F;1 Pool-No : 0 Lease : 1 Days 0 Hours 0 Minutes Domain-name : - DNS-server0 : 10.0.12.2 NBNS-server0 : - Netbios-type : - Position : Interface Status : Unlocked Gateway-0 : 10.0.12.2 Mask : 255.255.255.0 VPN instance : – -—————————————————————————- ​ Start End Total Used Idle(Expired) Conflict Disable -—————————————————————————- ​ 10.0.12.1 10.0.12.254 253 1 252(0) 0 0 -—————————————————————————- 当配置接口地址池时，地址池的名称为接口的名称。分配的网关地址为该接口的IP地址，且无法修改。 中继实验交换机4上有多个vlan，交换机1模拟dhcp服务器实现为多个vlan分配地址，交换机3作为dhcp终极连接服务器和客户端 实验步骤创建VLAN[S1]vlan 40 [S3]vlan batch 10 20 30 40 [S4]vlan batch 10 20 30 配置接口放通相应的VLAN[S4]interface GigabitEthernet0&#x2F;0&#x2F;3 [S4-GigabitEthernet0&#x2F;0&#x2F;3] port link-type trunk [S4-GigabitEthernet0&#x2F;0&#x2F;3] port trunk allow-pass vlan 10 20 30 [S4-GigabitEthernet0&#x2F;0&#x2F;3] quit [S3]interface GigabitEthernet0&#x2F;0&#x2F;1 [S3-GigabitEthernet0&#x2F;0&#x2F;1] port link-type access [S3-GigabitEthernet0&#x2F;0&#x2F;1] port default vlan 40 [S3-GigabitEthernet0&#x2F;0&#x2F;1] quit [S3]interface GigabitEthernet0&#x2F;0&#x2F;3 [S3-GigabitEthernet0&#x2F;0&#x2F;3] port link-type trunk [S3-GigabitEthernet0&#x2F;0&#x2F;3] port trunk allow-pass vlan 10 20 30 [S3-GigabitEthernet0&#x2F;0&#x2F;3] quit [S1]interface GigabitEthernet0&#x2F;0&#x2F;12 [S1-GigabitEthernet0&#x2F;0&#x2F;12] port link-type access [S1-GigabitEthernet0&#x2F;0&#x2F;12] port default vlan 40 [S1-GigabitEthernet0&#x2F;0&#x2F;12] quit 交换机4和交换机3之间因为放通多个vlan，所以使用trunk口，交换机3和交换机1之间只有一个vlan40，所以配置access口，pvid&#x3D;40 VLANIF配置[S4]interface Vlanif 10 [S4-Vlanif10] quit [S4]interface Vlanif 20 [S4-Vlanif20] quit [S4]interface Vlanif 30 [S4-Vlanif30] quit [S3]interface Vlanif 10 [S3-Vlanif10] ip address 10.0.10.3 24 [S3-Vlanif10] quit [S3]interface Vlanif 20 [S3-Vlanif20] ip address 10.0.20.3 24 [S3-Vlanif20] quit [S3]interface Vlanif 30 [S3-Vlanif30] ip address 10.0.30.3 24 [S3-Vlanif30] quit [S3]interface Vlanif 40 [S3-Vlanif40] ip address 10.0.40.3 24 [S3-Vlanif40] quit [S1]interface Vlanif 40 [S1-Vlanif40] ip address 10.0.40.1 24 [S1-Vlanif40] quit 检查一下交换机3和1之间的连通性 （开启DHCP服务，配置全局地址池，同时为S4上的VLANIF30分配静态IP地址。）： 开启DHCP服务[S1]dhcp enable 创建地址池VLAN10，用于给S4的VLANIF10分配地址[S1]ip pool vlan10 &#x2F;&#x2F;创建地址池名为vlan10 [S1-ip-pool-vlan10] gateway-list 10.0.10.3 &#x2F;&#x2F;网关是中继上的vlanif 10 [S1-ip-pool-vlan10] network 10.0.10.0 mask 255.255.255.0 &#x2F;&#x2F;设置分配ip范围是10.0.10.1-10.0.10.255 [S1-ip-pool-vlan10] dns-list 10.0.10.3 [S1-ip-pool-vlan10] quit 创建地址池VLAN20，用于给S4的VLANIF20分配地址[S1]ip pool vlan20 [S1-ip-pool-vlan20] gateway-list 10.0.20.3 [S1-ip-pool-vlan20] network 10.0.20.0 mask 255.255.255.0 [S1-ip-pool-vlan20] dns-list 10.0.20.3 [S1-ip-pool-vlan20] quit 创建地址池VLAN30，用于给S4的VLANIF30分配地址[S1]ip pool vlan30 [S1-ip-pool-vlan30] gateway-list 10.0.30.3 [S1-ip-pool-vlan30] network 10.0.30.0 mask 255.255.255.0 [S1-ip-pool-vlan30] dns-list 10.0.30.3 [S1-ip-pool-vlan30] quit 查看s4的vlanif30的mac为了实现给s4的vlanif30口静态绑定一个指定的ip地址，我们需要先查看一下mac 在S1上为S4的VLANIF30配置静态地址分配 给s4的vlanif口静态分配ip：10.0.30.2 在VLANIF40接口下使能DHCP Server[S1]interface Vlanif 40 [S1-Vlanif40] dhcp select global &#x2F;&#x2F;全局的使能 查看IP地址池配置情况[S1]display ip pool name vlan30 地址池vlan30已经存在一个“Used”地址，该地址为静态分配的地址。 配置前往用户网段的路由[S1]ip route-static 10.0.10.0 24 10.0.40.3 [S1]ip route-static 10.0.20.0 24 10.0.40.3 [S1]ip route-static 10.0.30.0 24 10.0.40.3 （或者配置缺省路由） 保证连通性 在S3上完成DHCP Relay相关配置 开启DHCP服务[S3]dhcp enable 在接口上配置DHCP Relay，指定DHCP Server[S3]interface Vlanif10 [S3-Vlanif10] dhcp select relay [S3-Vlanif10] dhcp relay server-ip 10.0.40.1 [S3-Vlanif10] quit [S3]interface Vlanif20 [S3-Vlanif20] dhcp select relay [S3-Vlanif20] dhcp relay server-ip 10.0.40.1 [S3-Vlanif20] quit [S3]interface Vlanif30 [S3-Vlanif30] dhcp select relay [S3-Vlanif30] dhcp relay server-ip 10.0.40.1 [S3-Vlanif30] quit 查看relay配置 DHCP Client配置在S4上配置VLANIF10、20、30接口通过DHCP获取IP地址 开启DHCP服务[S4]dhcp enable 开启接口通过DHCP获取地址[S4]interface Vlanif10 [S4-Vlanif10] ip address dhcp-alloc [S4-Vlanif10] quit [S4]interface Vlanif20 [S4-Vlanif20] ip address dhcp-alloc [S4-Vlanif20] quit [S4]interface Vlanif30 [S4-Vlanif30] ip address dhcp-alloc [S4-Vlanif30] quit 查看各个接口IP地址获取情况display interface Vlanif 10 Vlanif10 current state : UP Line protocol current state : UP Last line protocol up time : 2020-06-05 17:37:57 UTC-08:00 Description: Route Port,The Maximum Transmit Unit is 1500 Internet Address is allocated by DHCP, 10.0.10.254&#x2F;24 [S4]display interface Vlanif 20 Vlanif20 current state : UP Line protocol current state : UP Last line protocol up time : 2020-06-05 17:41:23 UTC-08:00 Description: Route Port,The Maximum Transmit Unit is 1500 Internet Address is allocated by DHCP, 10.0.20.254&#x2F;24 [S4]display interface Vlanif 30 Vlanif30 current state : UP Line protocol current state : UP Last line protocol up time : 2020-06-05 17:43:22 UTC-08:00 Description: Route Port,The Maximum Transmit Unit is 1500 Internet Address is allocated by DHCP, 10.0.30.2&#x2F;24 接口已经通过DHCP获取到IP地址，并且VLANIF30的地址为静态分配的地址：10.0.30.2。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"DHCP Relay","slug":"DHCP-Relay","permalink":"http://example.com/tags/DHCP-Relay/"},{"name":"DHCP","slug":"DHCP","permalink":"http://example.com/tags/DHCP/"}]},{"title":"vlan间通信","slug":"vlan间通信","date":"2023-11-24T07:17:21.000Z","updated":"2023-11-25T07:51:39.450Z","comments":true,"path":"2023/11/24/vlan间通信/","permalink":"http://example.com/2023/11/24/vlan%E9%97%B4%E9%80%9A%E4%BF%A1/","excerpt":"VLAN间通信背景划分VLAN后，不同VLAN的用户间不能二层互访，这样能起到隔离广播的作用。但实际应用中，不同VLAN的用户又常有互访的需求，此时就需要实现不同VLAN的用户互访，简称VLAN间互访。","text":"VLAN间通信背景划分VLAN后，不同VLAN的用户间不能二层互访，这样能起到隔离广播的作用。但实际应用中，不同VLAN的用户又常有互访的需求，此时就需要实现不同VLAN的用户互访，简称VLAN间互访。 实验拓扑 详解：R2划入vlan2，R3划入vlan3，与交换机之间采用access口，由于交换机g0&#x2F;0&#x2F;1需要通过多个vlan，所以配成trunk口。R2和R3相当于主机，发送和接受的数据都不带标签，交换机g0&#x2F;0&#x2F;2收到R2发送的数据，打上标签vlan2，然后发出去；交换机g0&#x2F;0&#x2F;1收到数据后，发现vlan的标签允许通过，则数据带着vlan2的标签通过；然后交换机g0&#x2F;0&#x2F;3口转发数据时，发现自己的pvid是vlan3，和vlan2不一样，所以不接受，则vlan2和vlan3不能通信。 在某些场景下，需要特定vlan之间通信 方法一：dot1q接口 在r1上配置两个dot1q接口，g0&#x2F;0&#x2F;1.1和g0&#x2F;0&#x2F;1.2，分别对应vlan2和vlan3，作用就是可以终结vlan标签（剥离），vlan2的标签到r1后，被剥离掉vlan2的标签，然后转发时又被g0&#x2F;0&#x2F;1.2打上vlan3的标签，交换机g0&#x2F;0&#x2F;1通过，到g0&#x2F;0&#x2F;3，access口发现和自己的pvid一样，然后剥离掉标签，转发数据帧给r3. 方法二：vlanif接口：交换机上配置vlanif2和vlanif3，ip地址配成192.168.2.254和192.168.3.254 其实就是相当于两个不同网段的网关，然后实现三层的转发 Access接口交换机上常用来连接用户PC、服务器等终端设备的接口。Access接口所连接的这些设备的网卡往往只收发无标记帧。Access接口只能加入一个VLAN。只能允许一个VLAN通过。 转发原则 接收原则： ①收到不带标签的数据帧，打上标签，vlan id&#x3D;端口的PVID ②收到带标签的数据帧，检查数据帧vlan id是否和端口的PVID相同，相同直接接收；不同拒绝接收 发送原则： ①数据帧vlan id和端口PVID 相同，剥离标签发送； ②数据帧vlan id和端口PVID 不同，禁止发送。 Trunk接口Trunk接口允许多个VLAN的数据帧通过，这些数据帧通过802.1Q Tag实现区分。Trunk接口常用于交换机之间的互联，也用于连接路由器、防火墙等设备的 子接口 转发原则 接收原则： ①收到不带标签的数据帧，打上标签，vlan id&#x3D;端口的PVID，然后查看该vlanid是否在允许列表中，是–接收，不是–拒绝 ②收到带标签的数据帧，查看该vlan id是否在允许列表中，是–接收，不是–拒绝 发送原则： 查看vlan id是否在允许列表中，I:不是–拒绝发送；II：是，查看接口的PVID和vlan id是否相同，相同–剥标签发送；不同–直接发送。 Hybrid接口Hybrid接口与Trunk接口类似，也允许多个VLAN的数据帧通过，这些数据帧通过802.1Q Tag实现区分。用户可以灵活指定Hybrid接口在发送某个（或某些）VLAN的数据帧时是否携带Tag 转发原则 接收原则： ①收到不带标签的数据帧，打上标签，vlan id&#x3D;端口的PVID，然后查看该vlanid是否在允许列表中，是–接收，不是–拒绝 ②收到带标签的数据帧，查看该vlan id是否在允许列表中，是–接收，不是–拒绝发送原则：查看vlan id是否在允许列表中，I:不是–拒绝发送；II：是，是否带标签发送取决于接口的配置。 PVID可以手工修改，默认是1，access口的就是本身的vlan号，trunk可以有一个主vlan和多个副vlan，收到的数据和主vlan相同就剥离转发，收到和主vlan不一样的标签，查表，看看是不是在允许通过的列表，如果有，就带着原来的转发，要是没有，就不让过去啦。 实验配置过程# R2和R3的IP地址及网关配置 system-view Enter system view, return user view with Ctrl+Z. [R2]interface GigabitEthernet 0&#x2F;0&#x2F;1 [R2-GigabitEthernet0&#x2F;0&#x2F;1]ip address 192.168.2.1 24 [R2-GigabitEthernet0&#x2F;0&#x2F;1]quit [R2]ip route-static 0.0.0.0 0 192.168.2.254 配置默认路由，相当于给设备配置了网关。 system-view Enter system view, return user view with Ctrl+Z. [R3]interface GigabitEthernet 0&#x2F;0&#x2F;1 [R3-GigabitEthernet0&#x2F;0&#x2F;1]ip address 192.168.3.1 24 [R3-GigabitEthernet0&#x2F;0&#x2F;1]quit [R3]ip route-static 0.0.0.0 0 192.168.3.254 # 在S1上对R2和R3进行VLAN划分 [S1]vlan batch 2 3 Info: This operation may take a few seconds. Please wait for a moment…done. [S1]interface GigabitEthernet 0&#x2F;0&#x2F;2 [S1-GigabitEthernet0&#x2F;0&#x2F;2]port link-type access [S1-GigabitEthernet0&#x2F;0&#x2F;2]port default vlan 2 [S1-GigabitEthernet0&#x2F;0&#x2F;2]quit [S1]interface GigabitEthernet 0&#x2F;0&#x2F;3 [S1-GigabitEthernet0&#x2F;0&#x2F;3]port link-type access [S1-GigabitEthernet0&#x2F;0&#x2F;3]port default vlan 3 步骤 1 通过Dot1q终结子接口实现VLAN间互访 # 配置S1上的Trunk接口 [S1]interface GigabitEthernet 0&#x2F;0&#x2F;1 [S1-GigabitEthernet0&#x2F;0&#x2F;1]port trunk allow-pass vlan 2 3 因为VLAN间互访数据要由R1来终结VLAN，所以S1和R1之间的链路要允许VLAN2和VLAN3通过**。 # 在R1上创建并配置Dot1q终结子接口 [R1]interface GigabitEthernet 0&#x2F;0&#x2F;1.2 创建并进入子接口视图。2代表子接口的编号，一般建议子接口编号与VLAN ID相同，方便记忆。 [R1-GigabitEthernet0&#x2F;0&#x2F;1.2]dot1q termination vid 2 dot1q termination vid vlan-id命令用来配置子接口Dot1q终结的VLAN ID。 以此配置为例：当GigabitEthernet0&#x2F;0&#x2F;1接口收到带有VLAN 2标签的数据之后，会交由2号子接口进行VLAN终结操作并做后续处理。从2号子接口发出的数据也会带上VLAN 2的标签。 [R1-GigabitEthernet0&#x2F;0&#x2F;1.2]arp broadcast enable 终结子接口不能转发广播报文，在收到广播报文后它们直接把该报文丢弃。为了允许终结子接口能转发广播报文，可以通过在子接口上执行命令arp broadcast enable使能终结子接口的ARP广播功能。部分设备默认使能该功能，此命令的配置根据设备而定。 [R1-GigabitEthernet0&#x2F;0&#x2F;1.2]ip address 192.168.2.254 24 [R1-GigabitEthernet0&#x2F;0&#x2F;1.2]quit [R1]interface GigabitEthernet 0&#x2F;0&#x2F;1.3 [R1-GigabitEthernet0&#x2F;0&#x2F;1.3]dot1q termination vid 3 [R1-GigabitEthernet0&#x2F;0&#x2F;1.3]arp broadcast enable [R1-GigabitEthernet0&#x2F;0&#x2F;1.3]ip address 192.168.3.254 24 [R1-GigabitEthernet0&#x2F;0&#x2F;1.3]quit # 检测VLAN间互访联通性 ping 192.168.3.1 PING 192.168.3.1: 56 data bytes, press CTRL_C to break Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;1 ttl&#x3D;254 time&#x3D;60 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;2 ttl&#x3D;254 time&#x3D;40 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;3 ttl&#x3D;254 time&#x3D;110 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;4 ttl&#x3D;254 time&#x3D;70 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;5 ttl&#x3D;254 time&#x3D;100 ms — 192.168.3.1 ping statistics — 5 packet(s) transmitted 5 packet(s) received 0.00% packet loss round-trip min&#x2F;avg&#x2F;max &#x3D; 40&#x2F;76&#x2F;110 ms tracert 192.168.3.1 traceroute to 192.168.3.1(192.168.3.1), max hops: 30 ,packet length: 40,press CTRL_C to break 1 192.168.2.254 30 ms 50 ms 50 ms 2 192.168.3.1 70 ms 60 ms 60 ms 此时VLAN2和VLAN3之间已经可以正常的互访。 步骤 2 通过VLANIF接口实现VLAN间互访 # 清除上一步配置 [S1]interface GigabitEthernet 0&#x2F;0&#x2F;1 [S1-GigabitEthernet0&#x2F;0&#x2F;1]undo port trunk allow-pass vlan 2 3 [S1-GigabitEthernet0&#x2F;0&#x2F;1]undo port link-type [R1]undo interface GigabitEthernet 0&#x2F;0&#x2F;1.2 [R1]undo interface GigabitEthernet 0&#x2F;0&#x2F;1.3 # 在S1上创建相应的VLANIF接口 [S1]interface Vlanif 2 interface vlanif vlan-id命令用来创建VLANIF接口并进入VLANIF接口视图。只有先通过命令创建VLAN后，才能执行interface vlanif命令创建VLANIF接口。 [S1-Vlanif2]ip address 192.168.2.254 24 [S1-Vlanif2]quit [S1]interface Vlanif 3 [S1-Vlanif3]ip address 192.168.3.254 24 [S1-Vlanif3]quit # 检测VLAN间互访联通性 ping 192.168.3.1 PING 192.168.3.1: 56 data bytes, press CTRL_C to break Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;1 ttl&#x3D;254 time&#x3D;100 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;2 ttl&#x3D;254 time&#x3D;50 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;3 ttl&#x3D;254 time&#x3D;50 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;4 ttl&#x3D;254 time&#x3D;60 ms Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;5 ttl&#x3D;254 time&#x3D;70 ms — 192.168.3.1 ping statistics — 5 packet(s) transmitted 5 packet(s) received 0.00% packet loss round-trip min&#x2F;avg&#x2F;max &#x3D; 50&#x2F;66&#x2F;100 ms tracert 192.168.3.1 traceroute to 192.168.3.1(192.168.3.1), max hops: 30 ,packet length: 40,press CTRL_C to break 1 192.168.2.254 40 ms 30 ms 20 ms 2 192.168.3.1 40 ms 30 ms 40 ms 此时VLAN2和VLAN3之间已经可以正常的互访。","categories":[{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"vlan间通信","slug":"vlan间通信","permalink":"http://example.com/tags/vlan%E9%97%B4%E9%80%9A%E4%BF%A1/"},{"name":"dot1q","slug":"dot1q","permalink":"http://example.com/tags/dot1q/"},{"name":"vlanif","slug":"vlanif","permalink":"http://example.com/tags/vlanif/"}]}],"categories":[{"name":"基础知识","slug":"基础知识","permalink":"http://example.com/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"},{"name":"ip实验","slug":"ip实验","permalink":"http://example.com/categories/ip%E5%AE%9E%E9%AA%8C/"}],"tags":[{"name":"子网划分","slug":"子网划分","permalink":"http://example.com/tags/%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86/"},{"name":"ap上线","slug":"ap上线","permalink":"http://example.com/tags/ap%E4%B8%8A%E7%BA%BF/"},{"name":"wlan","slug":"wlan","permalink":"http://example.com/tags/wlan/"},{"name":"USG5500","slug":"USG5500","permalink":"http://example.com/tags/USG5500/"},{"name":"防火墙nat","slug":"防火墙nat","permalink":"http://example.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99nat/"},{"name":"rstp","slug":"rstp","permalink":"http://example.com/tags/rstp/"},{"name":"mstp","slug":"mstp","permalink":"http://example.com/tags/mstp/"},{"name":"链路聚合","slug":"链路聚合","permalink":"http://example.com/tags/%E9%93%BE%E8%B7%AF%E8%81%9A%E5%90%88/"},{"name":"lacp","slug":"lacp","permalink":"http://example.com/tags/lacp/"},{"name":"eth-trunk","slug":"eth-trunk","permalink":"http://example.com/tags/eth-trunk/"},{"name":"mpls","slug":"mpls","permalink":"http://example.com/tags/mpls/"},{"name":"hybrid","slug":"hybrid","permalink":"http://example.com/tags/hybrid/"},{"name":"tag","slug":"tag","permalink":"http://example.com/tags/tag/"},{"name":"telnet","slug":"telnet","permalink":"http://example.com/tags/telnet/"},{"name":"aaa","slug":"aaa","permalink":"http://example.com/tags/aaa/"},{"name":"FTP","slug":"FTP","permalink":"http://example.com/tags/FTP/"},{"name":"VRRP","slug":"VRRP","permalink":"http://example.com/tags/VRRP/"},{"name":"BFD","slug":"BFD","permalink":"http://example.com/tags/BFD/"},{"name":"BGP路由优选","slug":"BGP路由优选","permalink":"http://example.com/tags/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/"},{"name":"BGP路由反射器","slug":"BGP路由反射器","permalink":"http://example.com/tags/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/"},{"name":"BGP","slug":"BGP","permalink":"http://example.com/tags/BGP/"},{"name":"路由策略","slug":"路由策略","permalink":"http://example.com/tags/%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5/"},{"name":"nat","slug":"nat","permalink":"http://example.com/tags/nat/"},{"name":"DHCP Relay","slug":"DHCP-Relay","permalink":"http://example.com/tags/DHCP-Relay/"},{"name":"DHCP","slug":"DHCP","permalink":"http://example.com/tags/DHCP/"},{"name":"vlan间通信","slug":"vlan间通信","permalink":"http://example.com/tags/vlan%E9%97%B4%E9%80%9A%E4%BF%A1/"},{"name":"dot1q","slug":"dot1q","permalink":"http://example.com/tags/dot1q/"},{"name":"vlanif","slug":"vlanif","permalink":"http://example.com/tags/vlanif/"}]}