<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>BGP路由优选</title>
      <link href="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/"/>
      <url>/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/</url>
      
        <content type="html"><![CDATA[<h1 id="BGP路由优选"><a href="#BGP路由优选" class="headerlink" title="BGP路由优选"></a>BGP路由优选</h1><h2 id="实验背景"><a href="#实验背景" class="headerlink" title="实验背景"></a>实验背景</h2><p>你是公司的网络管理员。公司的网络采用了BGP协议接入了两个服务运营商。公司自己采用了私有的AS号64512，ISP1的AS号为100，ISP2的AS号为200。通过AS100、AS200都可以到达相同的网络，你通过改变BGP的各种属性达到了调整路由走向的目的。</p><span id="more"></span><p>实验介绍：</p><p>设备互联方式、互联接口地址如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号，所有设备都使用Loopback0地址作为BGP Router ID。</p><p>R1在AS100，R5在AS200，R2、R3、R4在AS64512。AS64512内运行OSPF，在互联接口（不包括连接外部AS的接口）、Loopback0接口上激活OSPF。</p><p>EBGP对等体关系基于直连接口建立，IBGP对等体关系基于Loopback0接口建立。</p><p>R1、R5上存在相同的网段172.16.1.0&#x2F;24、172.16.2.0&#x2F;24、172.16.3.0&#x2F;24、172.16.4.0&#x2F;24，在R1、R5上将其发布到BGP，以用于BGP路由优选。</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/tuopu22sd182306.png" alt="tuopu22sd182306"></p><p>配置ip，配置bgp：略</p><p>#在R1、R5上将Loopback1、Loopback2、Loopback3、Loopback4接口路由发布到BGP中</p><p>[R1]bgp 100</p><p>[R1-bgp] network 172.16.1.0 24</p><p>[R1-bgp] network 172.16.2.0 24</p><p>[R1-bgp] network 172.16.3.0 24</p><p>[R1-bgp] network 172.16.4.0 24</p><p>[R5]bgp 200</p><p>[R5-bgp] network 172.16.1.0 24</p><p>[R5-bgp] network 172.16.2.0 24</p><p>[R5-bgp] network 172.16.3.0 24</p><p>[R5-bgp] network 172.16.4.0 24</p><p>#在R3上查看BGP路由表，检查BGP路由是否成功学习</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/r3chakandp128185306.png" alt="r3chakandp128185306"></p><p>R3已经成功学习R1、R5发布的路由，此时所有路由都优选由R2通告的。</p><h2 id="修改AS-Path属性"><a href="#修改AS-Path属性" class="headerlink" title="修改AS_Path属性"></a>修改AS_Path属性</h2><p>在R1上通过路由策略修改BGP路由172.16.1.0&#x2F;24的 AS_Path属性值，使得R3优选R5发布的BGP路由172.16.1.0&#x2F;24。</p><p>#创建IP前缀列表1，匹配Loopback1接口路由</p><p>[R1]ip ip-prefix 1 permit 172.16.1.0 24 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改AS_Path属性值</p><p>[R1]route-policy hcip permit node 10</p><p>[R1-route-policy] if-match ip-prefix 1</p><p>[R1-route-policy] apply as-path 300 400 additive</p><p>[R1-route-policy] quit</p><p>[R1]route-policy hcip permit node 20</p><p>注意创建一个空节点，对于另外3条BGP路由不执行任何操作。</p><p>#对向BGP对等体R2通告的BGP路由应用Route-Policy</p><p>[R1]bgp 100</p><p>[R1-bgp] peer 10.0.12.2 route-policy hcip export</p><p>#在R1上触发出方向的软复位，刷新对外通告的BGP路由</p><p><R1>refresh bgp all export</R1></p><p>#在R3上查看BGP路由172.16.1.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/as5cs28190005.png" alt="as5cs28190005"></p><p>此时R3优选R4通告的BGP路由172.16.1.0&#x2F;24，R2通告的未被优选的原因是AS_Path长度。</p><h2 id="修改Local-Preference属性"><a href="#修改Local-Preference属性" class="headerlink" title="修改Local_Preference属性"></a>修改Local_Preference属性</h2><p>local_Preference：默认100，越大越优先，只能在ibgp对等体之间传递</p><p>在R4上通过路由策略修改BGP路由172.16.2.0&#x2F;24的Local_Preference属性值，使得R3优选R4通告的BGP路由172.16.2.0&#x2F;24。</p><p>#创建IP前缀列表1，匹配BGP路由172.16.2.0&#x2F;24</p><p>[R4]ip ip-prefix 1 permit 172.16.2.0 24 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改Local_Preference属性值</p><p>[R4]route-policy hcip permit node 10</p><p>[R4-route-policy] if-match ip-prefix 1</p><p>[R4-route-policy] apply local-preference 200</p><p>[R4-route-policy] quit</p><p>[R4]route-policy hcip permit node 20</p><p>注意创建一个空节点，对于另外3条BGP路由不执行任何操作。</p><p>#对向BGP对等体R3通告的BGP路由应用Route-Policy</p><p>[R4]bgp 64512</p><p>[R4-bgp] peer 10.0.3.3 route-policy hcip export</p><p>#在R4上触发出方向的软复位，刷新对外通告的BGP路由</p><p><R4>refresh bgp all export</R4></p><p>#在R3上查看BGP路由172.16.2.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/local55chakan192014.png" alt="local55chakan192014"></p><p>此时R3优选R4通告的BGP路由172.16.2.0&#x2F;24，R2通告的BGP路由其Local_Preference值为100，小于R3通告的BGP路由Local_Preference值200，因此R2通告的BGP路由未被优选。</p><h2 id="修改MED属性"><a href="#修改MED属性" class="headerlink" title="修改MED属性"></a>修改MED属性</h2><p>在R2上通过路由策略修改BGP路由172.16.3.0&#x2F;24的MED属性值，使得R3优选R5发布的BGP路由172.16.3.0&#x2F;24。</p><p>#创建IP前缀列表1，匹配BGP路由172.16.3.0&#x2F;24</p><p>[R2]ip ip-prefix 1 permit 172.16.3.0 24 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改MED属性值</p><p>[R2]route-policy hcip permit node 10</p><p>[R2-route-policy] if-match ip-prefix 1</p><p>[R2-route-policy] apply cost 200</p><p>[R2-route-policy] quit</p><p>[R2]route-policy hcip permit node 20</p><p>注意创建一个空节点，对于另外3条BGP路由不执行任何操作。</p><p>#对来自BGP对等体R1的BGP路由应用Route-Policy</p><p>[R2]bgp 64512</p><p>[R2-bgp] peer 10.0.12.1 route-policy hcip import</p><p>#在R2上触发入方向的软复位，刷新接收到的BGP路由</p><p><R2>refresh bgp all import</R2></p><p>#在R3上配置允许比较来自不同AS的BGP路由的MED值</p><p>[R3]bgp 64512</p><p>[R3-bgp] compare-different-as-med  </p><p>缺省情况下，不比较来自不同AS邻居的BGP的MED属性值。</p><p>#在R3上查看BGP路由172.16.3.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/medchakanf2735.png" alt="medchakanf2735"></p><p>R2通告的BGP路由172.16.3.0&#x2F;24其MED值为200，而R4通告BGP路由MED值为0，R3优选MED值较小的BGP路由，因此R2通告的BGP路由未被优选。</p><h2 id="修改preferred-value属性"><a href="#修改preferred-value属性" class="headerlink" title="修改preferred-value属性"></a>修改preferred-value属性</h2><p>preferred-value：华为特有的属性值，仅在本地有效，当bgp存在到相同的路由时，将优选prefeerred-value大的路由。只能在路由器本地配置，只影响本设备的路由优选，不会传递给任何bgp对等体。</p><p>在R3上通过路由策略修改BGP路由172.16.4.0&#x2F;24的preferred-value属性值，使得R3优选R4通告的BGP路由172.16.4.0&#x2F;24。</p><p>#创建IP前缀列表1，匹配BGP路由172.16.4.0&#x2F;24</p><p>[R3]ip ip-prefix 1 permit 172.16.4.0 24 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1，修改preferred-value属性值</p><p>[R3]route-policy hcip permit node 10</p><p>[R3-route-policy] if-match ip-prefix 1</p><p>[R3-route-policy] apply preferred-value 300</p><p>[R3-route-policy] quit</p><p>[R3]route-policy hcip permit node 20</p><p>注意创建一个空节点，对于另外3条BGP路由不执行任何操作。</p><p>#对来自BGP对等体R4的BGP路由应用Route-Policy</p><p>[R3]bgp 64512</p><p>[R3-bgp] peer 10.0.4.4 route-policy hcip import</p><p>#在R3上触发入方向的软复位，刷新收到的BGP路由</p><p><R3>refresh bgp all import</R3></p><p>#在R3上查看BGP路由172.16.4.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/prexiiuhai8193458.png" alt="prexiiuhai8193458"></p><p>R4通告的BGP路由172.16.3.0&#x2F;24其preferred-value值为300，而R2通告的preferred-value值为0，R3优选preferred-value值较大的BGP路由，因此R3优选R4通告的BGP路由。</p>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BGP路由优选 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BGP路由反射器</title>
      <link href="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/"/>
      <url>/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="BGP路由反射器"><a href="#BGP路由反射器" class="headerlink" title="BGP路由反射器"></a>BGP路由反射器</h1><p>由于水平分割的原因，为了保证AS内所有的BGP路由器都能学习到完整的BGP路由，就必须在AS内实现IBGP全互联。</p><p>然而实现IBGP全互联存在诸多短板：</p><p> 路由器需维护大量的TCP及BGP连接，尤其在路由器数量较多时。</p><p> AS内BGP网络的可扩展性较差，因为通过纯手工配置命令。</p><p>为了解决该问题，可应用到RR路由反射器技术。</p><p>1、Client：RR客户端，在RR设备上通过手动指定。</p><blockquote><p>指定命令：peer 邻居 reflect-client</p></blockquote><p>2、除了指定的设备为客户端，其它设备均为非客户端。</p><p>实验：</p><p>R1、R2、R3、R4都属于AS64511，其连接方式、互联接口地址如图所示。每台设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号。R1、R2上的Loopback1地址分别为10.1.1.1&#x2F;24、10.2.2.2&#x2F;24，用于模拟用户网段。</p><span id="more"></span><p>所有设备都使用Loopback0地址作为BGP Router ID，R1与R2、R2与R3、R3与R4、R4与R2之间基于直连接口建立IBGP对等体关系，其中R1为R2的路由反射器客户端，R2为R3的路由反射器客户端，R3为R4的路由反射器客户端。</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/bgpluy8165208.png" alt="bgpluy8165208"></p><p>配置ip地址：略</p><p>建立ibgp对等体：略</p><h1 id="配置路由反射器"><a href="#配置路由反射器" class="headerlink" title="配置路由反射器"></a>配置路由反射器</h1><p>#R2上将R1配置为路由反射器客户端</p><p>[R2]bgp 64511</p><p>[R2-bgp] peer 10.0.1.1 reflect-client</p><p>#R3上将R2配置为路由反射器客户端</p><p>[R3]bgp 64511</p><p>[R3-bgp] peer 10.0.2.2 reflect-client</p><p>#R4上将R3配置为路由反射器客户端</p><p>[R4]bgp 64511</p><p>[R4-bgp] peer 10.0.3.3 reflect-client</p><h1 id="验证Orginator-ID实现路由防环"><a href="#验证Orginator-ID实现路由防环" class="headerlink" title="验证Orginator_ID实现路由防环"></a>验证Orginator_ID实现路由防环</h1><p>在本步骤中，我们将在R2上发布BGP路由10.2.2.0&#x2F;24，并观察该路由依次经路由反射器R3、R4反射后，被通告回R2从而引发潜在路由环路风险的情况。</p><p>缺省情况下，R2发布BGP路由后，该路由将被R2直接通告给R4，另一方面也会通过R3反射给R4，此时R4将优选R2直接通告过来的路由，从而不会再将R3反射过来的路由再反射回给R2。为此，我们需要在R2上部署路由策略，使R2不直接向R4通告10.2.2.0&#x2F;24路由。</p><p>#配置路由策略</p><p>[R2]acl number 2000</p><p>[R2-acl-basic-2000] rule 5 permit</p><p>[R2-acl-basic-2000] quit</p><p>[R2]route-policy bgp deny node 10</p><p>[R2-route-policy] if-match acl 2000</p><p>#在BGP中调用路由策略</p><p>[R2]bgp 64511</p><p>[R2-bgp] peer 10.0.24.4 route-policy bgp export</p><p>#在R2上发布路由</p><p>[R2]bgp 64511</p><p>[R2-bgp] network 10.2.2.0 24</p><p>#R2上查看BGP路由10.2.2.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/chakan102224728.png" alt="chakan102224728"></p><p>R2将该条路由通告给了R3、R1，但是并未通告给R4。</p><p>#R3上查看BGP路由10.2.2.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/r174808.png" alt="r174808"></p><p>R3将来自反射器客户端的BGP路由10.2.2.0&#x2F;24反射给了10.0.34.4（R4）。同时该BGP路由的nexthop为10.0.23.2。</p><p># R4上查看BGP路由10.2.2.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/r4chakan80119.png" alt="r4chakan80119"></p><p>该条路由来自反射器客户端R3，原始路由经由R3反射，路由的nexthop地址并未改变，同时R3为其添加了Orginator_ID属性，值为10.0.2.2。同时R4将该条路由反射给了R2。</p><p>#再次在R2上查看BGP路由10.2.2.0&#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/zacifa80349.png" alt="zacifa80349"></p><p>依旧只存在本地通告的BGP路由，没有R4通告的BGP路由。</p><p>#在R2上查看BGP对等体10.0.4.4的详细信息</p><p>display bgp peer 10.0.4.4 verbose</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/safhaofbsh1128180629.png" alt="safhaofbsh1128180629"></p><p>从输出信息可以看到R2从R4收到了1个Update报文，未向R4发送Update报文（路由策略限制），但是本地BGP路由表中不存在由R4通告的BGP路由10.2.2.0&#x2F;24。</p><p>R4通告的BGP路由Orginator_ID属性值与本地的Router ID一致，R2忽略了该路由通告。</p><h1 id="验证Cluster-List实现路由防环"><a href="#验证Cluster-List实现路由防环" class="headerlink" title="验证Cluster_List实现路由防环"></a>验证Cluster_List实现路由防环</h1><p>为了方便观察现象，取消R2上的BGP路由发布，在R1上将Loopback1接口路由发布到BGP，观察Cluster_List如何防止环路。</p><p>#取消R2上的BGP路由发布</p><p>[R2]bgp 64511</p><p>[R2-bgp] undo network 10.2.2.0 255.255.255.0</p><p>#在R1上将Loopback1接口路由发布到BGP</p><p>[R1]bgp 64511</p><p>[R1-bgp] network 10.1.1.0 24</p><p>#依次在R1、R2、R3、R4上查看BGP路由10.1.1.0 &#x2F;24的明细信息</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/xinfuaiell181000.png" alt="xinfuaiell181000"></p><p>R1为BGP路由10.1.1.0&#x2F;24的始发者，R1将路由通告给了R2</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/2xinfahol128181116.png" alt="2xinfahol128181116"></p><p>来自路由反射器客户端R1的BGP路由10.1.1.0&#x2F;24，R2将其反射给了R3</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/3xinmbxmcx1128181206.png" alt="3xinmbxmcx1128181206"></p><p>来自路由反射器客户端R2的BGP路由10.1.1.0&#x2F;24，R2反射时添加了Cluster_List属性，值为10.0.2.2，R3将该条路由反射给了R4</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/44xinm1334.png" alt="44xinm1334"></p><p>来自路由反射器客户端R3的BGP路由10.1.1.0&#x2F;24，R3反射时添加了Cluster_List属性的值，当前值为10.0.3.3，10.0.2.2，R4将该条路由反射给了R2</p><p>#再次查看R2的BGP路由表</p><p><img src="/2023/11/28/BGP%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/zaizaici661435.png" alt="zaizaici661435"></p><p>R2的BGP路由表中依旧只有一条来自r1的BGP路由10.1.1.0&#x2F;24。</p><p>4通告的BGP路由其Cluster_List属性值中包含了R2的Cluster-ID，R2忽略了该路由通告。</p>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BGP路由反射器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BGP实验</title>
      <link href="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/"/>
      <url>/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="BGP基础实验"><a href="#BGP基础实验" class="headerlink" title="BGP基础实验"></a>BGP基础实验</h1><p>设备连接方式、IP地址规划、BGP AS号如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号，所有设备都使用Loopback0接口IP地址作为BGP Router ID。R1、R5上存在Loopback1模拟用户网段。</p><p>R2、R3、R4之间运行OSPF，在R2、R3、R4的互联接口、Loopback0接口上激活OSPF。!</p><span id="more"></span><h2 id="实验背景"><a href="#实验背景" class="headerlink" title="实验背景"></a>实验背景</h2><p>你是公司的网络管理员。公司的网络采用了BGP协议作为路由协议。公司的网络由多个自治系统组成，不同的分支机构使用了不同的AS号，现在你需要完成公司网络的搭建工作。在公司总部使用了OSPF作为IGP，公司内部不同分支机构使用的是私有的BGP AS号。</p><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/bgpadaw110633.png" alt="bgpadaw110633"></p><h1 id="1-配置ip"><a href="#1-配置ip" class="headerlink" title="1.配置ip"></a>1.配置ip</h1><p>如拓扑图配置各个接口ip，和loopback 0 ：10.0.x.x</p><p>r1 loopback 1 ：10.1.1.1 24</p><p>r5 loopback 1 ：10.1.5.5 24</p><p>r2 r3 r4配置ospf：略</p><h1 id="2-配置IBGP对等体"><a href="#2-配置IBGP对等体" class="headerlink" title="2.配置IBGP对等体"></a>2.配置IBGP对等体</h1><p>在R2、R3、R4之间基于Loopback0接口建立全互联的IBGP对等体关系。</p><p>#R2上配置BGP</p><p>[R2]bgp 64512</p><p>[R2-bgp] router-id 10.0.2.2</p><p>[R2-bgp] peer 10.0.3.3 as-number 64512</p><p>[R2-bgp] peer 10.0.3.3 connect-interface LoopBack0</p><p>[R2-bgp] peer 10.0.4.4 as-number 64512</p><p>[R2-bgp] peer 10.0.4.4 connect-interface LoopBack0</p><p>#R3上配置BGP</p><p>[R3]bgp 64512</p><p>[R3-bgp] router-id 10.0.3.3</p><p>[R3-bgp] peer 10.0.2.2 as-number 64512</p><p>[R3-bgp] peer 10.0.2.2 connect-interface LoopBack0</p><p>[R3-bgp] peer 10.0.4.4 as-number 64512</p><p>[R3-bgp] peer 10.0.4.4 connect-interface LoopBack0</p><p>#R4上配置BGP</p><p>[R4]bgp 64512</p><p>[R4-bgp] peer 10.0.2.2 as-number 64512</p><p>[R4-bgp] peer 10.0.2.2 connect-interface LoopBack0</p><p>[R4-bgp] peer 10.0.3.3 as-number 64512</p><p>[R4-bgp] peer 10.0.3.3 connect-interface LoopBack0</p><p>#分别在R2、R3、R4上检查BGP对等体状态</p><h1 id="3-配置EBGP对等体"><a href="#3-配置EBGP对等体" class="headerlink" title="3.配置EBGP对等体"></a>3.配置EBGP对等体</h1><p>（一般情况使用直连接口建立EBGp）</p><p>在R1与R2、R4与R5之间基于Loopback0接口建立EBGP对等体关系，为保证能够正常建立，在R1、R2上配置静态路由使Loopback0之间路由可达（R4、R5同样操作）。</p><p>#在R1、R2上配置静态路由</p><p>[R1]ip route-static 10.0.2.2 32 10.0.12.2</p><p>[R2]ip route-static 10.0.1.1 32 10.0.12.1</p><p>#在R4、R5上配置静态路由</p><p>[R4]ip route-static 10.0.5.5 32 10.0.45.5</p><p>[R5]ip route-static 10.0.4.4 32 10.0.45.4</p><p>这里配置静态路由，因为要建立TCP会话的前提，需要在数据层面两路由器相通，所以需要需要手工配置静态路由，实现loopback 0 之间互通</p><p>#配置R1、R2之间的EBGP对等体</p><p>[R1]bgp 64513</p><p>[R1-bgp] router-id 10.0.1.1</p><p>[R1-bgp] peer 10.0.2.2 as-number 64512</p><p>[R1-bgp] peer 10.0.2.2 ebgp-max-hop 2</p><p>[R1-bgp] peer 10.0.2.2 connect-interface LoopBack0</p><p>[R2]bgp 64512</p><p>[R2-bgp] peer 10.0.1.1 as-number 64513</p><p>[R2-bgp] peer 10.0.1.1 ebgp-max-hop 2</p><p>[R2-bgp] peer 10.0.1.1 connect-interface LoopBack0</p><p>默认情况下，EBGP连接允许的最大跳数为1，这导致EBGP对等体之间只能使用直连链路建立EBGP对等体关系，为使用环回口作为更新源需要手动修改EBGP连接允许的最大跳数。</p><p>#配置R4、R5之间的EBGP对等体</p><p>[R4]bgp 64512</p><p>[R4-bgp] peer 10.0.5.5 as-number 64514</p><p>[R4-bgp] peer 10.0.5.5 ebgp-max-hop 2</p><p>[R4-bgp] peer 10.0.5.5 connect-interface LoopBack0</p><p>[R5]bgp 64514</p><p>[R5-bgp] router-id 10.0.5.5</p><p>[R5-bgp] peer 10.0.4.4 as-number 64512</p><p>[R5-bgp] peer 10.0.4.4 ebgp-max-hop 2</p><p>[R5-bgp] peer 10.0.4.4 connect-interface LoopBack0</p><p>#在R1、R5上检查EBGP对等体状态</p><h1 id="4-在BGP中发布路由"><a href="#4-在BGP中发布路由" class="headerlink" title="4.在BGP中发布路由"></a>4.在BGP中发布路由</h1><p>在R1、R5上将Loopback1接口路由发布到BGP</p><p>#在R1、R5上通过network命令发布路由</p><p>[R1]bgp 64513</p><p>[R1-bgp] network 10.1.1.1 24</p><p>[R5]bgp 64514</p><p>[R5-bgp] network 10.1.5.5 24</p><p>在R3上查看BGP路由表</p><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/luyoub122914.png" alt="luyoub122914"></p><p>可以看到此时R3上已经学习到R1、R5上发布的BGP路由，但是都是<strong>非有效路由</strong>，这是因为它们的下一跳在R3上都不可达，为此可以在R2、R4上通过<strong>next-hop-local</strong>命令修改下一跳地址为R2、R4的更新源地址。</p><p>原因：ebgp对等体在发送数据时，下一跳地址为自身更新源地址，ibgp收到ebgp发送的数据，下一跳不变</p><p>#在R2、R4上将路由的下一跳地址修改为自身</p><p>[R2]bgp 64512</p><p>[R2-bgp] peer 10.0.3.3 next-hop-local</p><p>[R2-bgp] peer 10.0.4.4 next-hop-local</p><p>[R4]bgp 64512</p><p>[R4-bgp] peer 10.0.2.2 next-hop-local</p><p>[R4-bgp] peer 10.0.3.3 next-hop-local</p><p><strong>peer next-hop-local</strong>命令一般在ASBR上配置。当设备通过EBGP邻居学到路由再转发给其他IBGP邻居时，默认不修改下一跳，但其EBGP邻居发来的路由的下一跳都是其EBGP邻居的Peer地址，本端对等体所属AS域内的IBGP邻居收到这样的路由后，由于下一跳不可达导致路由无法活跃。因此，需要在ASBR上对IBGP邻居配置<strong>peer next-hop-local</strong>命令，使得发给IBGP邻居的路由的下一跳是其自身的地址，IBGP邻居收到这样的路由后（由于域内都配置了IGP）发现下一跳可达，路由即为活跃路由。</p><p>此命令为覆盖式命令。</p><p>执行<strong>peer next-hop-local</strong>命令后，设备向IBGP对等体&#x2F;对等体组通告路由时，把下一跳属性设为自身的IP地址。</p><p><strong>peer next-hop-local</strong>命令仅应用于IBGP对等体间。</p><p>再次r3上查看bgp路由表</p><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/louybadwad128123318.png" alt="louybadwad128123318"></p><p>此时两条BGP路由都变成了有效、最优的状态。</p><p>#在R1、R5上查看BGP路由表<img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/r11128123426.png" alt="r11128123426"></p><p>R1、R5之间相互学习到了对端Loopback1接口路由。</p><h1 id="BGP路由汇总实验"><a href="#BGP路由汇总实验" class="headerlink" title="BGP路由汇总实验"></a>BGP路由汇总实验</h1><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/luyouhuizongdaw143536.png" alt="luyouhuizongdaw143536"></p><p>BGP AS号、互联地址如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x&#x2F;32，其中x为设备编号。</p><p>R1、R2、R3使用Loopback0地址作为BGP Router ID，基于直连接口建立EBGP对等体关系。</p><p>R1、R3上存在Loopback1、Loopback2接口，用于模拟用户网段。</p><h1 id="1-配置ip-1"><a href="#1-配置ip-1" class="headerlink" title="1.配置ip"></a>1.配置ip</h1><p>略</p><h1 id="2-配置EBGPd对等体"><a href="#2-配置EBGPd对等体" class="headerlink" title="2.配置EBGPd对等体"></a>2.配置EBGPd对等体</h1><p>#配置R1</p><p>[R1]bgp 64511</p><p>[R1-bgp] router-id 10.0.1.1</p><p>[R1-bgp] peer 10.0.12.2 as-number 64512</p><p>#配置R2</p><p>#配置R3</p><p>[R3]bgp 64513</p><p>[R3-bgp] router-id 10.0.3.3</p><p>[R3-bgp] peer 10.0.23.2 as-number 64512</p><h1 id="3-BGP路由自动汇总"><a href="#3-BGP路由自动汇总" class="headerlink" title="3.BGP路由自动汇总"></a>3.BGP路由自动汇总</h1><p>在R1上开启BGP路由自动汇总，将Loopback1、Loopback2接口路由发布到BGP中，并进行自动汇总。</p><p>#创建IP前缀列表1，匹配Loopback1、Loopback2接口路由</p><p>[R1]ip ip-prefix 1 permit 172.16.0.0 16 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1</p><p>[R1]route-policy hcip permit node 10</p><p>[R1-route-policy] if-match ip-prefix 1</p><p>[R1-route-policy] quit</p><p>[R1]bgp 64511</p><p>[R1-bgp] import-route direct route-policy hcip</p><p>[R1-bgp] summary automatic</p><p>Info: Automatic summarization is valid only for the routes imported through the import-route command.</p><p>自动汇总只对通过<strong>import-route</strong>命令引入的路由生效。</p><p>#在R1上查看BGP路由表</p><p><R1>displaybgprouting-table</R1></p><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/r11128123426.png" alt="r11128123426"></p><p>Loopback1、Loopback2接口路由已经发布到BGP，由于R1激活了BGP路由自动汇总，因此R1会将这些路由汇总成172.16.0.0&#x2F;16，同时抑制所有的明细路由，通过明细路由前的“s”标记可以看出，该标记的含义为“suppressed”，表示被抑制，最终R1只对外通告汇总路由172.16.0.0&#x2F;16。</p><p>#在R2上查看BGP路由表</p><p><R2>display bgp routing-table </R2></p><p>R2上只能看到一条主类路由172.16.0.0&#x2F;16。</p><p>#在R2上查看BGP路由172.16.0.0的明细信息</p><p><R2>display bgp routing-table 172.16.0.0</R2></p><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/r2jyj28150027.png" alt="r2jyj28150027"></p><p>该路由的路径属性中存在Aggregator属性，其中携带了汇总路由生成设备所属的AS号以及其Router ID</p><h1 id="4-BGP路由手动汇总"><a href="#4-BGP路由手动汇总" class="headerlink" title="4.BGP路由手动汇总"></a>4.BGP路由手动汇总</h1><p>在R3上将Loopback1、Loopback2接口路由发布到BGP，在R2上通过<strong>aggregate</strong>命令执行手动汇总，并抑制明细路由的对外发布。</p><p>#创建IP前缀列表1，匹配Loopback1、Loopback2接口路由</p><p>[R3]ip ip-prefix 1 permit 172.17.0.0 16 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10，在其中调用IP前缀列表1</p><p>[R3]route-policy hcip permit node 10</p><p>[R3-route-policy] if-match ip-prefix 1</p><p>[R3-route-policy] quit</p><p>#将Loopback1、Loopback2接口路由发布到BGP </p><p>[R3]bgp 64513</p><p>[R3-bgp] import-route direct route-policy hcip</p><p>#查看R2的BGP路由表</p><p><R2>displaybgprouting-table</R2></p><p>​<img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/QQr2aef31128150511.png" alt="QQr2aef31128150511"></p><p>在R2的BGP路由表中已经存在R3通告的BGP路由172.17.1.0&#x2F;24、172.17.2.0&#x2F;24。</p><p>#R2上执行手动路由汇总，将172.17.1.0&#x2F;24、172.17.2.0&#x2F;24汇总成172.17.0.0&#x2F;22，并抑制明细路由的对外通告</p><p>[R2]bgp 64512</p><p>[R2-bgp] aggregate 172.17.0.0 22 detail-suppressed</p><p>#查看R2的BGP路由表</p><p><R2>displaybgprouting-table</R2></p><p>​</p><p>此时在R2的BGP路由表中可以看到汇总后的路由。</p><p> <img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/radwahh128150729.png" alt="radwahh128150729"></p><p>#在R2上查看BGP路由172.16.0.0&#x2F;22的明细信息</p><p><R2>display bgp routing-table 172.17.0.0 22</R2></p><p>从输出信息<img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/diushi222f1030.png" alt="diushi222f1030">可以看到AS_Path值为Nil，代表了AS_Path属性值为空，这意味着丢失了明细的AS_Path属性值，BGP依赖AS_Path实现防环，因此AS_Path属性的丢失可能带来路由环路。从该条路由对外通告的对等体中可以看到10.0.23.3（R3)。</p><p>#查看R3的BGP路由表</p><p>在R3的BGP路由表中可以看到汇总路由172.17.0.0&#x2F;22。</p><p>#为防止路由环路，在R2上执行手动汇总时增加as-set关键字</p><p>[R2]bgp 64512</p><p>[R2-bgp] aggregate 172.17.0.0 255.255.252.0 detail-suppressed as-set</p><p>#再次在R2上查看BGP路由172.17.0.0&#x2F;22的明细信息</p><p><img src="/2023/11/28/BGP%E5%AE%9E%E9%AA%8C/as645138151320.png" alt="as645138151320"></p><p>可以看到此时AS_Path属性值为64513，此时该条路由<strong>依旧向10.0.23.3（R3）</strong>通告。</p><p>R3收到关于172.17.0.0&#x2F;22的通告之后，在AS_Path中将看到自身的AS号（64153），将会忽略该路由通告。此时R3的BGP路由表中无法看到汇总路由172.17.0.0&#x2F;22，因此通过在手动路由汇总的配置中使用as-set关键字顺利地规避了路由环路的产生。</p><h1 id="BGP路由反射器"><a href="#BGP路由反射器" class="headerlink" title="BGP路由反射器"></a>BGP路由反射器</h1>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BGP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>路由策略</title>
      <link href="/2023/11/26/%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5/"/>
      <url>/2023/11/26/%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<p><img src="/2023/11/26/%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5/luyouceltuopu126203917.png" alt="luyouceltuopu126203917"></p><p>设备互联方式、互联地址如图所示，所有设备均创建Loopback0，其IP地址为10.0.x.x&#x2F;32，其中x为设备编号，R1、R2、R3在互联接口、Loopback0接口上激活OSPF。</p><p>R3、R4属于IS-IS Area 49.0001，两者都是Level-1路由器，R3、R4的系统ID采用0000.0000.000x格式，其中x为设备编号。</p><span id="more"></span><p>R1上存在三个业务网段A、B、C（使用Loopback1、2、3接口路由模拟），在R1上将直连路由引入到OSPF，但是OSPF域内的路由器上不需要C业务的路由，为此在R1上引入直连路由时通过Route-Policy过滤引入的路由。</p><p>R2上不需要A业务网段的路由，但是R3上需要A、B业务网段的路由，为此在R2上配置Filter-Policy对OSPF接收的路由进行过滤。</p><p>IS-IS域内的路由器需要访问A业务，因此需要在R3上执行路由重分发，将OSPF路由引入到IS-IS，但是IS-IS域内的路由器不需要访问B业务，为此在R1上引入直连路由时为A、B业务网段路由打上不同的路由标记，R3上执行重分发时根据路由标记过滤B业务网段路由。</p><h1 id="任务思路"><a href="#任务思路" class="headerlink" title="任务思路"></a>任务思路</h1><ol><li>设备基础IP地址配置。</li><li>配置R1、R2、R3之间的OSPF，在互联接口、Loopback0接口上激活OSPF。在R3、R4之间配置IS-IS。</li><li>在R1上将直连路由引入到OSPF中，同时配置路由策略不引入C业务网段的路由，将A、B业务网段路由分别打上路由标记10、20。</li><li>在R2上配置Filter-Policy对接收的OSPF路由进行过滤，只接收B业务网段的路由。</li><li>在R3上将OSPF路由引入到IS-IS中，通过Route-Policy匹配路由标记，只引入A业务网段的OSPF外部路由。</li></ol><h1 id="1-配置ip"><a href="#1-配置ip" class="headerlink" title="1.配置ip"></a>1.配置ip</h1><p>#配置R1的GE0&#x2F;0&#x2F;2、Loopback0接口IP地址</p><p>[R1]interface GigabitEthernet0&#x2F;0&#x2F;2</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;2] ip address 10.0.12.1 255.255.255.0</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;2] quit</p><p>[R1]interface LoopBack0</p><p>[R1-LoopBack0] ip address 10.0.1.1 255.255.255.255</p><p>[R1-LoopBack0] quit</p><p>#在R1上创建多个环回口，用于模拟业务网段A、B、C</p><p>[R1]interface LoopBack1</p><p>[R1-LoopBack1] ip address 172.16.1.1 255.255.255.0</p><p>[R1-LoopBack1] quit</p><p>[R1]interface LoopBack2</p><p>[R1-LoopBack2] ip address 172.16.2.1 255.255.255.0</p><p>[R1-LoopBack2] quit</p><p>[R1]interface LoopBack3</p><p>[R1-LoopBack3] ip address 172.16.3.1 255.255.255.0</p><p>[R1-LoopBack3] quit</p><p>#配置R2的GE0&#x2F;0&#x2F;2、GE0&#x2F;0&#x2F;3、Loopback0接口IP地址</p><p>[R2]interface LoopBack0</p><p>[R2-LoopBack0] ip address 10.0.2.2 255.255.255.255</p><p>[R2-LoopBack0] quit</p><p>[R2]interface GigabitEthernet0&#x2F;0&#x2F;2</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;2] ip address 10.0.23.2 255.255.255.0</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;2] quit</p><p>[R2]interface GigabitEthernet0&#x2F;0&#x2F;3</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.0.12.2 255.255.255.0</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;3] quit</p><p>#配置R3的GE0&#x2F;0&#x2F;2、GE0&#x2F;0&#x2F;3、Loopback0接口IP地址</p><p>[R3]interface LoopBack0</p><p>[R3-LoopBack0] ip address 10.0.3.3 255.255.255.255</p><p>[R3-LoopBack0] quit</p><p>[R3]interface GigabitEthernet0&#x2F;0&#x2F;2</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;2] ip address 10.0.34.3 255.255.255.0</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;2] quit</p><p>[R3]interface GigabitEthernet0&#x2F;0&#x2F;3</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.0.23.3 255.255.255.0</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;3] quit</p><p>#配置R4的GE0&#x2F;0&#x2F;3、Loopback0接口IP地址</p><p>[R4]interface GigabitEthernet0&#x2F;0&#x2F;3</p><p>[R4-GigabitEthernet0&#x2F;0&#x2F;3] ip address 10.0.34.4 255.255.255.0</p><p>[R4-GigabitEthernet0&#x2F;0&#x2F;3] quit</p><p>[R4]interface LoopBack0</p><p>[R4-LoopBack0] ip address 10.0.4.4 255.255.255.255</p><p>[R4-LoopBack0] quit</p><p>#在R2、R4上检查IP地址连通性</p><h1 id="2-配置ospf和isis"><a href="#2-配置ospf和isis" class="headerlink" title="2.配置ospf和isis"></a>2.配置ospf和isis</h1><p>#配置R1</p><p>[R1]ospf 1 router-id 10.0.1.1</p><p>[R1-ospf-1] area 0</p><p>[R1-ospf-1-area-0.0.0.0] network 10.0.1.1 0.0.0.0</p><p>[R1-ospf-1-area-0.0.0.0] network 10.0.12.1 0.0.0.0</p><p>[R1-ospf-1-area-0.0.0.0] quit</p><p>[R1-ospf-1] quit</p><p>#配置R2</p><p>[R2]ospf 1 router-id 10.0.2.2</p><p>[R2-ospf-1] area 0.0.0.0</p><p>[R2-ospf-1-area-0.0.0.0] network 10.0.2.2 0.0.0.0</p><p>[R2-ospf-1-area-0.0.0.0] network 10.0.12.2 0.0.0.0</p><p>[R2-ospf-1-area-0.0.0.0] network 10.0.23.2 0.0.0.0</p><p>[R2-ospf-1-area-0.0.0.0] quit</p><p>[R2-ospf-1] quit</p><p>#配置R3</p><p>[R3]ospf 1 router-id 10.0.3.3</p><p>[R3-ospf-1] area 0.0.0.0</p><p>[R3-ospf-1-area-0.0.0.0] network 10.0.3.3 0.0.0.0</p><p>[R3-ospf-1-area-0.0.0.0] network 10.0.23.3 0.0.0.0</p><p>[R3-ospf-1-area-0.0.0.0] quit</p><p>[R3-ospf-1] quit</p><p>#在R2上检查OSPF邻居的概要信息</p><p>R3、R4上配置IS-IS，区域为49.0001，系统ID采用0000.0000.000x格式（x为设备编号），两台设备都为Level-1路由器，在互联接口、R4的Loopback0接口上激活IS-IS。</p><p>#配置R3</p><p>[R3]isis 1</p><p>[R3-isis-1] is-level level-1</p><p>[R3-isis-1] network-entity 49.0001.0000.0000.0003.00</p><p>[R3-isis-1] quit</p><p>[R3]interface GigabitEthernet0&#x2F;0&#x2F;2</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;2] isis enable 1</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;2] quit</p><p>#配置R4</p><p>[R4]isis 1</p><p>[R4-isis-1] is-level level-1</p><p>[R4-isis-1] network-entity 49.0001.0000.0000.0004.00</p><p>[R4-isis-1] quit</p><p>[R4]interface GigabitEthernet0&#x2F;0&#x2F;3</p><p>[R4-GigabitEthernet0&#x2F;0&#x2F;3] isis enable 1</p><p>[R4-GigabitEthernet0&#x2F;0&#x2F;3] quit</p><p>[R4]interface LoopBack 0</p><p>[R4-LoopBack0] isis enable 1</p><p>[R4-LoopBack0] quit</p><p>#在R3上检查IS-IS邻居状态</p><h1 id="3-在R1上引入直连路由"><a href="#3-在R1上引入直连路由" class="headerlink" title="3.在R1上引入直连路由"></a>3.在R1上引入直连路由</h1><p>在R1上将直连路由引入到OSPF中，同时配置路由策略过滤C业务网段，将A、B业务网段路由分别打上路由标记10、20。</p><p>#创建IP前缀列表1，匹配Loopback1接口路由（A业务网段）</p><p>[R1]ip ip-prefix 1 index 10 permit 172.16.1.0 24 greater-equal 24 less-equal 24</p><p>#创建IP前缀列表2，匹配Loopback2接口路由（B业务网段）</p><p>[R1]ip ip-prefix 2 index 10 permit 172.16.2.0 24 greater-equal 24 less-equal 24</p><p>#创建Route-Policy hcip，并创建节点10、20，分别调用IP前缀列表1、2，打上路由标记</p><p>[R1]route-policy hcip permit node 10</p><p>[R1-route-policy] if-match ip-prefix 1</p><p>[R1-route-policy] apply tag 10</p><p>[R1-route-policy] quit</p><p>[R1]route-policy hcip permit node 20</p><p>[R1-route-policy] if-match ip-prefix 2</p><p>[R1-route-policy] apply tag 20 </p><p>[R1-route-policy] quit</p><p>#在R1的OSPF中引入直连路由，调用Route-Policy hcip</p><p>[R1]ospf 1</p><p>[R1-ospf-1] import-route direct route-policy hcip</p><p>r1上查看ospf lsdb，Loopback1、2接口路由已经被成功引入OSPF中。</p><p>#在R1上查看OSPF LSDB中AS-external LSA 172.16.1.0的相关信息</p><p>[R1]display ospf lsdb ase 172.16.1.0 </p><p>​ OSPF Process 1 with Router ID 10.0.1.1</p><p>​ Link State Database</p><p> Type    : External</p><p> Ls id   : 172.16.1.0</p><p> Adv rtr  : 10.0.1.1  </p><p> Ls age   : 165 </p><p> Len    : 36 </p><p> Options  :  E  </p><p> seq#    : 80000001 </p><p> chksum   : 0xa954</p><p> Net mask  : 255.255.255.0 </p><p> TOS 0  Metric: 1 </p><p> E type   : 2</p><p> Forwarding Address : 0.0.0.0 </p><p> Tag    : 10 </p><p> Priority  : Low</p><p>外部路由172.16.1.0&#x2F;24已经被打上Tag 10。</p><p>#在R1上查看OSPF LSDB中AS-external LSA 172.16.2.0的相关信息</p><p>[R1]display ospf lsdb ase 172.16.2.0</p><p>​ OSPF Process 1 with Router ID 10.0.1.1</p><p>​ Link State Database</p><p> Type    : External</p><p> Ls id   : 172.16.2.0</p><p> Adv rtr  : 10.0.1.1  </p><p> Ls age   : 355 </p><p> Len    : 36 </p><p> Options  :  E  </p><p> seq#    : 80000001 </p><p> chksum   : 0x539f</p><p> Net mask  : 255.255.255.0 </p><p> TOS 0  Metric: 1 </p><p> E type   : 2</p><p> Forwarding Address : 0.0.0.0 </p><p> Tag    : 20 </p><p> Priority  : Low</p><p>外部路由172.16.2.0&#x2F;24已经被打上Tag 20。</p><h1 id="4-在R2上配置过滤策略"><a href="#4-在R2上配置过滤策略" class="headerlink" title="4.在R2上配置过滤策略"></a>4.在R2上配置过滤策略</h1><p>在R2上配置Filter-Policy对接收的OSPF路由进行过滤，只接收B业务网段的路由。</p><p>#查看配置Filter-Policy前的OSPF路由表</p><p><R2>display ospf routing</R2></p><p>#查看配置Filter-Policy前的IP路由表中的OSPF路由</p><p><R2>display ip routing-table protocol ospf</R2></p><p>在OSPF路由表以及IP路由表中<strong>都可以看到</strong>OSPF外部路由172.16.1.0&#x2F;24、172.16.2.0&#x2F;24。</p><p>#配置基础ACL </p><p>[R2]acl number 2000</p><p>[R2-acl-basic-2000] rule 5 deny source 172.16.1.0 0.0.0.255</p><p>[R2-acl-basic-2000] rule 10 permit</p><p>#在OSPF中部署入方向的Filter-Policy，调用ACL 2000</p><p>[R2]ospf 1</p><p>[R2-ospf-1] filter-policy 2000 import</p><p>#查看配置Filter-Policy后的OSPF路由表</p><p>dis ospf routing</p><p>发现两条外部路由都还存在</p><p>#查看配置Filter-Policy后的IP路由表中的OSPF路由</p><p><R2>display ip routing-table protocol ospf</R2></p><p>在IP路由表中路由172.16.2.0&#x2F;24已经不存在，但是在OSPF路由表中依旧存在。这验证了对于OSPF，Filter-Policy只是限制路由加入IP路由表，不影响本地的LSDB以及LSA的传递。</p><p>#在R3上查看IP路由表中的OSPF路由</p><p><R3>display ip routing-table protocol ospf </R3></p><p>R3的IP路由表中OSPF外部路由172.16.1.0&#x2F;24、172.16.2.0&#x2F;24依旧存在。</p><h1 id="5-在R3上将OSPF路由引入到IS-IS"><a href="#5-在R3上将OSPF路由引入到IS-IS" class="headerlink" title="5.在R3上将OSPF路由引入到IS-IS"></a>5.在R3上将OSPF路由引入到IS-IS</h1><p>在R3上将OSPF路由引入到IS-IS中，通过Route-Policy匹配路由标记，只引入A业务网段的OSPF外部路由。</p><p>#创建Route-Policy hcip</p><p>[R3]route-policy hcip permit node 10</p><p>[R3-route-policy] if-match tag 10</p><p>[R3-route-policy] quit</p><p>#在IS-IS中引入OSPF路由，调用Route-Policy hcip只引入A业务网段的OSPF外部路由</p><p>[R3]isis 1</p><p>[R3-isis-1] import-route ospf 1 <strong>level-1</strong> route-policy hcip</p><p>（注意指定level）</p><p>#查看R3的IS-IS路由表</p><p><R3>display isis route </R3></p><p>Level-1的路由重分发表中只有172.16.1.0&#x2F;24。</p>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 路由策略 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nat实验</title>
      <link href="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/"/>
      <url>/2023/11/25/nat%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="静态nat"><a href="#静态nat" class="headerlink" title="静态nat"></a>静态nat</h1><p>静态NAT实现了私有地址和公有地址的一对一映射。如果希望一台主机优先使用某个关联地址，或者想要外部网络使用一个指定的公网地址访问内部服务器时，可以使用静态NAT。但是在大型网络中，这种一对一的IP地址映射无法缓解公用地址短缺的问题。</p><span id="more"></span><p>静态NAT实现了私有地址和共有地址一对一的映射（一个私有地址对应一个共有地址），并没有做到缓解地址短缺的问题，只是做到了地址转换。</p><p>一个公网地址只会分配给唯一且固定的内网地址</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/jingttuopu4509.png" alt="jingttuopu4509"></p><p>如图配置ip地址和网关</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/jingta15204327.png" alt="jingta15204327"></p><p>r1上配置静态nat（注意是在公网的接口上，出接口）</p><p>注意配置一条静态路由，不然没有路由的下一跳会被丢弃</p><p>在r1上查看nat映射关系：dis nat static</p><p>验证一下：<img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/jingtainatjg25204222.png" alt="jingtainatjg25204222"></p><p>发现去往2.2.2.2的源地址变为2.2.2.3，说明nat完成转换。</p><p>静态nat两种配置方式：</p><p>1.接口下（上述实验采用这种方式）：进入到连接外网路由器的出接口下，然后在接口视图下配置nat映射关系</p><p>2.全局：在全局视图下，配置好nat映射关系，再进入到出接口，执行：nat static enable</p><h1 id="动态nat"><a href="#动态nat" class="headerlink" title="动态nat"></a>动态nat</h1><p>动态NAT通过使用地址池来实现。</p><p>如上图，当内部主机A和主机B需要与公网中的目的主机通信时，网关RTA会从配置的公网地址池中选择一个未使用的公网地址与之做映射。每台主机都会分配到地址池中的一个唯一地址。当不需要此连接时，对应的地址映射将会被删除，公网地址也会被恢复到地址池中待用。当网关收到回复报文后，会根据之前的映射再次进行转换之后转发给对应主机。</p><p>注意：</p><p>动态NAT实际上实现的还是私有地址和公有地址一对一的关系，但是共有地址不再绑定给特定的内网地址。实现了一定程度的缓解地址短缺问题。<br>动态NAT地址池中的地址用尽以后，只能等待被占用的公用IP被释放后，其他主机才能使用它来访问公网。<img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/dongtaitu00800.png" alt="dongtaitu00800"></p><h2 id="动态NAT转换流程："><a href="#动态NAT转换流程：" class="headerlink" title="动态NAT转换流程："></a>动态NAT转换流程：</h2><p>1）路由器上配置一个内部地址池（公司内部所有主机用到的私有IP）动态映射一个外部地址池（所购买的公有IP）。<br>2）当有一个内网主机访问外网时，路由器首先查看NAT地址转换表；<br>3）若无，则再查看是否配置了动态NAT映射，若配置，则将IP包头中的源IP与内部地址池进行匹配，若有匹配项，则将该内网IP从内部地址池中取出，同时取出外部地址池中的一个IP地址，动态形成NAT地址转换表。注意，外部地址池的公网IP地址取出后，外部地址池中将没有该公网IP了。<br>4）默认当该主机24小时没有联系外网时，该动态NAT条目会自动消失，所被取出的公私有地址重新回到地址池中。</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/tuopudawda12714.png" alt="tuopudawda12714"></p><p>ip如图，pc的网关192.168.1.254</p><p>r1上配置默认路由，ip route-static 0.0.0.0 0 172.16.1.2</p><p>r1上配置动态地址池：</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/acldongtai2005212357.png" alt="acldongtai2005212357"></p><p>地址池验证：</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/dizhichi1201.png" alt="dizhichi1201"></p><p>配置acl策略：</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/acl55da612432.png" alt="acl55da612432"></p><p>在r1的外网出接口上调用：</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/natout25212448.png" alt="natout25212448"></p><p>验证：</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/dongtaijiegy12547.png" alt="dongtaijiegy12547"></p><p>其中源IP为3、4、5不定，说明是在动态分配外网地址。动态NAT配置完成。</p><p>在动态NAT实验中，最后利用PC1测试连通性时，间歇性会丢包</p><p>可能的原因：ping的时候默认按地址池中可用地址顺序从1~254进行地址转换，放大nat地址池可解决。</p><h1 id="NAPT"><a href="#NAPT" class="headerlink" title="NAPT"></a>NAPT</h1><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/NApttu39.png" alt="NApttu39"></p><p>如上图，RTA收到一个私网主机发送的报文，源IP地址是192.168.1.1，源端口号是1025，目的IP地址是100.1.1.1，目的端口是80。RTA会从配置的公网地址池中选择一个空闲的公网IP地址和端口号，并建立相应的NAPT表项。这些NAPT表项指定了报文的私网IP地址和端口号与公网IP地址和端口号的映射关系。之后，RTA将报文的源IP地址和端口号转换成公网地址200.10.10.1和端口号2843，并转发报文到公网。当网关RTA收到回复报文后，会根据之前的映射表再次进行转换之后转发给主机A。主机B同理。</p><p>注意：</p><p>NAPT技术允许多个内部地址映射到同一个公有地址的不同端口。<br>NAPT实现了私有地址对共有地址多对一</p><p>相当于一种特殊的动态nat</p><p>1、端口NAT和动态NAT的配置过程基本一致，只是在应用到接口时，配置命令少no-pat<br>2、端口NAT一个地址可以给多个源地址转换，不是单对单的转换，所以节省了nat地址！<br>3、端口NAT实际应用较多，静态NAT和动态NAT因为地址不能节约，所以实际应用少</p><h1 id="Easy-IP"><a href="#Easy-IP" class="headerlink" title="Easy IP"></a>Easy IP</h1><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/easydahwka5.png" alt="easydahwka5"></p><p>Easy IP本质上是NAPT（所以原理与NAPT大致相似）<br>由于网关设备出接口IP地址为公网地址，所以可以利用该<strong>出接口地址</strong>来作为地址转换的公有地址。<br>Easy IP适用于小规模局域网中的主机访问Internet的场景。小规模局域网通常部署在小型的网吧或者办公室中，这些地方内部主机不多，出接口可以通过拨号方式获取一个临时公网IP地址。Easy IP可以实现内部主机使用这个临时公网IP地址访问Internet。</p><p>Easy IP适用于小规模局域网中的主机访问Internet的场景。小规模局域网通常部署在小型的网吧或者办公室中，这些地方内部主机不多，出接口可以通过拨号方式获取一个临时公网IP地址。Easy IP可以实现内部主机使用这个临时公网IP地址访问Internet。</p><h2 id="Easy-IP的配置："><a href="#Easy-IP的配置：" class="headerlink" title="Easy IP的配置："></a>Easy IP的配置：</h2><p>1.创建ACL：acl 2000</p><p>2.允许1.0的数据进行转换：rule 5 permit source 192.168.1.0 0 .0.0.255</p><p>3.进入公网出接口</p><p>4.应用acl：nat outbound 2000</p><p>（相较于napt少了地址池）</p><p>验证：</p><p><img src="/2023/11/25/nat%E5%AE%9E%E9%AA%8C/easadwaawh215116.png" alt="easadwaawh215116"></p><p>源地址为出接口地址172.16.1.1，只是端口不同</p>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DHCP基础配置</title>
      <link href="/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/"/>
      <url>/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p> DHCP是一种终端自动配置协议，客户端通过DHCP协议可获取一个合法的动态IP地址。</p><span id="more"></span><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>随着网络规模的扩大和网络复杂度的提高，网络配置越来越复杂，经常出现计算机位置变化（如便携机或无线网络）和计算机数量超过可分配的IP地址的情况。动态主机配置协议DHCP（Dynamic Host Configuration Protocol）就是为满足这些需求而发展起来的。DHCP协议以服务器&#x2F;客户端（Server&#x2F;Client）模式工作，DHCP客户端向DHCP服务器动态地请求配置信息，DHCP服务器可以很方便地为客户端动态发送配置信息。</p><h3 id="DHCP服务器"><a href="#DHCP服务器" class="headerlink" title="DHCP服务器"></a>DHCP服务器</h3><p>DHCP Server即DHCP服务器，负责客户端IP地址的分配。客户端向服务器发送配置申请报文（包括IP地址、子网掩码、缺省网关等参数），服务器根据策略返回携带相应配置信息的报文，请求报文和回应报文都采用UDP进行封装。</p><h3 id="DHCP中继"><a href="#DHCP中继" class="headerlink" title="DHCP中继"></a>DHCP中继</h3><p>DHCP Relay即DHCP中继，它是为解决服务器和客户端不在同一个网段而提出来的，它提供了对DHCP广播报文的透明传输功能，能够把DHCP客户端的广播报文透明地传送到其它网段的DHCP服务器上，同样能够把DHCP服务器端的广播报文透明地传送到其它网段的DHCP客户端。</p><h1 id="DHCP基础配置"><a href="#DHCP基础配置" class="headerlink" title="DHCP基础配置"></a>DHCP基础配置</h1><p><img src="/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/dhcpzz111.png" alt="dhcpzz111">交换机4上有多个vlan，交换机1模拟dhcp服务器实现为多个vlan分配地址，交换机3作为dhcp终极连接服务器和客户端</p><h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><h3 id="创建VLAN"><a href="#创建VLAN" class="headerlink" title="创建VLAN"></a>创建VLAN</h3><p>[S1]vlan 40</p><p>[S3]vlan batch 10 20 30 40</p><p>[S4]vlan batch 10 20 30</p><h3 id="配置接口放通相应的VLAN"><a href="#配置接口放通相应的VLAN" class="headerlink" title="配置接口放通相应的VLAN"></a>配置接口放通相应的VLAN</h3><p>[S4]interface GigabitEthernet0&#x2F;0&#x2F;3</p><p>[S4-GigabitEthernet0&#x2F;0&#x2F;3] port link-type trunk</p><p>[S4-GigabitEthernet0&#x2F;0&#x2F;3] port trunk allow-pass vlan 10 20 30</p><p>[S4-GigabitEthernet0&#x2F;0&#x2F;3] quit</p><p>[S3]interface GigabitEthernet0&#x2F;0&#x2F;1</p><p>[S3-GigabitEthernet0&#x2F;0&#x2F;1] port link-type access</p><p>[S3-GigabitEthernet0&#x2F;0&#x2F;1] port default vlan 40</p><p>[S3-GigabitEthernet0&#x2F;0&#x2F;1] quit</p><p>[S3]interface GigabitEthernet0&#x2F;0&#x2F;3</p><p>[S3-GigabitEthernet0&#x2F;0&#x2F;3] port link-type trunk</p><p>[S3-GigabitEthernet0&#x2F;0&#x2F;3] port trunk allow-pass vlan 10 20 30</p><p>[S3-GigabitEthernet0&#x2F;0&#x2F;3] quit</p><p>[S1]interface GigabitEthernet0&#x2F;0&#x2F;12</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;12] port link-type access</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;12] port default vlan 40</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;12] quit</p><p>交换机4和交换机3之间因为放通多个vlan，所以使用trunk口，交换机3和交换机1之间只有一个vlan40，所以配置access口，pvid&#x3D;40</p><h3 id="VLANIF配置"><a href="#VLANIF配置" class="headerlink" title="VLANIF配置"></a>VLANIF配置</h3><p>[S4]interface Vlanif 10</p><p>[S4-Vlanif10] quit</p><p>[S4]interface Vlanif 20</p><p>[S4-Vlanif20] quit</p><p>[S4]interface Vlanif 30</p><p>[S4-Vlanif30] quit</p><p>[S3]interface Vlanif 10</p><p>[S3-Vlanif10] ip address 10.0.10.3 24</p><p>[S3-Vlanif10] quit</p><p>[S3]interface Vlanif 20</p><p>[S3-Vlanif20] ip address 10.0.20.3 24</p><p>[S3-Vlanif20] quit</p><p>[S3]interface Vlanif 30</p><p>[S3-Vlanif30] ip address 10.0.30.3 24</p><p>[S3-Vlanif30] quit</p><p>[S3]interface Vlanif 40</p><p>[S3-Vlanif40] ip address 10.0.40.3 24</p><p>[S3-Vlanif40] quit</p><p>[S1]interface Vlanif 40</p><p>[S1-Vlanif40] ip address 10.0.40.1 24</p><p>[S1-Vlanif40] quit</p><p>检查一下交换机3和1之间的连通性</p><p>（开启DHCP服务，配置全局地址池，同时为S4上的VLANIF30分配静态IP地址。）：</p><h3 id="开启DHCP服务"><a href="#开启DHCP服务" class="headerlink" title="开启DHCP服务"></a>开启DHCP服务</h3><p>[S1]dhcp enable</p><h3 id="创建地址池VLAN10，用于给S4的VLANIF10分配地址"><a href="#创建地址池VLAN10，用于给S4的VLANIF10分配地址" class="headerlink" title="创建地址池VLAN10，用于给S4的VLANIF10分配地址"></a>创建地址池VLAN10，用于给S4的VLANIF10分配地址</h3><p>[S1]ip pool vlan10 &#x2F;&#x2F;创建地址池名为vlan10</p><p>[S1-ip-pool-vlan10] gateway-list 10.0.10.3  &#x2F;&#x2F;网关是中继上的vlanif 10</p><p>[S1-ip-pool-vlan10] network 10.0.10.0 mask 255.255.255.0 &#x2F;&#x2F;设置分配ip范围是10.0.10.1-10.0.10.255</p><p>[S1-ip-pool-vlan10] dns-list 10.0.10.3</p><p>[S1-ip-pool-vlan10] quit</p><h3 id="创建地址池VLAN20，用于给S4的VLANIF20分配地址"><a href="#创建地址池VLAN20，用于给S4的VLANIF20分配地址" class="headerlink" title="创建地址池VLAN20，用于给S4的VLANIF20分配地址"></a>创建地址池VLAN20，用于给S4的VLANIF20分配地址</h3><p>[S1]ip pool vlan20</p><p>[S1-ip-pool-vlan20] gateway-list 10.0.20.3</p><p>[S1-ip-pool-vlan20] network 10.0.20.0 mask 255.255.255.0</p><p>[S1-ip-pool-vlan20] dns-list 10.0.20.3</p><p>[S1-ip-pool-vlan20] quit</p><h3 id="创建地址池VLAN30，用于给S4的VLANIF30分配地址"><a href="#创建地址池VLAN30，用于给S4的VLANIF30分配地址" class="headerlink" title="创建地址池VLAN30，用于给S4的VLANIF30分配地址"></a>创建地址池VLAN30，用于给S4的VLANIF30分配地址</h3><p>[S1]ip pool vlan30</p><p>[S1-ip-pool-vlan30] gateway-list 10.0.30.3</p><p>[S1-ip-pool-vlan30] network 10.0.30.0 mask 255.255.255.0</p><p>[S1-ip-pool-vlan30] dns-list 10.0.30.3</p><p>[S1-ip-pool-vlan30] quit</p><h3 id="查看s4的vlanif30的mac"><a href="#查看s4的vlanif30的mac" class="headerlink" title="查看s4的vlanif30的mac"></a>查看s4的vlanif30的mac</h3><p>为了实现给s4的vlanif30口静态绑定一个指定的ip地址，我们需要先查看一下mac<img src="/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/macsiis30.png" alt="macsiis30"></p><h3 id="在S1上为S4的VLANIF30配置静态地址分配"><a href="#在S1上为S4的VLANIF30配置静态地址分配" class="headerlink" title="在S1上为S4的VLANIF30配置静态地址分配"></a>在S1上为S4的VLANIF30配置静态地址分配</h3><p><img src="/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/mac0234.png" alt="mac0234"></p><p>给s4的vlanif口静态分配ip：10.0.30.2</p><h3 id="在VLANIF40接口下使能DHCP-Server"><a href="#在VLANIF40接口下使能DHCP-Server" class="headerlink" title="在VLANIF40接口下使能DHCP Server"></a>在VLANIF40接口下使能DHCP Server</h3><p>[S1]interface Vlanif 40 </p><p>[S1-Vlanif40] dhcp select global &#x2F;&#x2F;全局的使能</p><h3 id="查看IP地址池配置情况"><a href="#查看IP地址池配置情况" class="headerlink" title="查看IP地址池配置情况"></a>查看IP地址池配置情况</h3><p>[S1]display ip pool name vlan30</p><p><img src="/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/3chakan0.png" alt="3chakan0"></p><p>地址池vlan30已经存在一个“Used”地址，该地址为静态分配的地址。</p><h3 id="配置前往用户网段的路由"><a href="#配置前往用户网段的路由" class="headerlink" title="配置前往用户网段的路由"></a>配置前往用户网段的路由</h3><p>[S1]ip route-static 10.0.10.0 24 10.0.40.3 </p><p>[S1]ip route-static 10.0.20.0 24 10.0.40.3</p><p>[S1]ip route-static 10.0.30.0 24 10.0.40.3</p><p>（或者配置缺省路由）</p><p>保证连通性</p><p>在S3上完成DHCP Relay相关配置</p><h3 id="开启DHCP服务-1"><a href="#开启DHCP服务-1" class="headerlink" title="开启DHCP服务"></a>开启DHCP服务</h3><p>[S3]dhcp enable</p><h3 id="在接口上配置DHCP-Relay，指定DHCP-Server"><a href="#在接口上配置DHCP-Relay，指定DHCP-Server" class="headerlink" title="在接口上配置DHCP Relay，指定DHCP Server"></a>在接口上配置DHCP Relay，指定DHCP Server</h3><p>[S3]interface Vlanif10</p><p>[S3-Vlanif10] dhcp select relay</p><p>[S3-Vlanif10] dhcp relay server-ip 10.0.40.1</p><p>[S3-Vlanif10] quit</p><p>[S3]interface Vlanif20</p><p>[S3-Vlanif20] dhcp select relay</p><p>[S3-Vlanif20] dhcp relay server-ip 10.0.40.1</p><p>[S3-Vlanif20] quit</p><p>[S3]interface Vlanif30</p><p>[S3-Vlanif30] dhcp select relay</p><p>[S3-Vlanif30] dhcp relay server-ip 10.0.40.1</p><p>[S3-Vlanif30] quit</p><h3 id="查看relay配置"><a href="#查看relay配置" class="headerlink" title="查看relay配置"></a>查看relay配置</h3><p><img src="/2023/11/25/DHCP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/relayallss7.png" alt="relayallss7"></p><h3 id="DHCP-Client配置"><a href="#DHCP-Client配置" class="headerlink" title="DHCP Client配置"></a>DHCP Client配置</h3><p>在S4上配置VLANIF10、20、30接口通过DHCP获取IP地址</p><h4 id="开启DHCP服务-2"><a href="#开启DHCP服务-2" class="headerlink" title="开启DHCP服务"></a>开启DHCP服务</h4><p>[S4]dhcp enable</p><h4 id="开启接口通过DHCP获取地址"><a href="#开启接口通过DHCP获取地址" class="headerlink" title="开启接口通过DHCP获取地址"></a>开启接口通过DHCP获取地址</h4><p>[S4]interface Vlanif10</p><p>[S4-Vlanif10] ip address dhcp-alloc</p><p>[S4-Vlanif10] quit</p><p>[S4]interface Vlanif20</p><p>[S4-Vlanif20] ip address dhcp-alloc</p><p>[S4-Vlanif20] quit</p><p>[S4]interface Vlanif30</p><p>[S4-Vlanif30] ip address dhcp-alloc</p><p>[S4-Vlanif30] quit</p><h4 id="查看各个接口IP地址获取情况"><a href="#查看各个接口IP地址获取情况" class="headerlink" title="查看各个接口IP地址获取情况"></a>查看各个接口IP地址获取情况</h4><p><S4>display interface Vlanif 10</S4></p><p>Vlanif10 current state : UP</p><p>Line protocol current state : UP</p><p>Last line protocol up time : 2020-06-05 17:37:57 UTC-08:00</p><p>Description:</p><p>Route Port,The Maximum Transmit Unit is 1500</p><p>Internet Address is allocated by DHCP, 10.0.10.254&#x2F;24</p><p>[S4]display interface Vlanif 20</p><p>Vlanif20 current state : UP</p><p>Line protocol current state : UP</p><p>Last line protocol up time : 2020-06-05 17:41:23 UTC-08:00</p><p>Description:</p><p>Route Port,The Maximum Transmit Unit is 1500</p><p>Internet Address is allocated by DHCP, 10.0.20.254&#x2F;24</p><p>[S4]display interface Vlanif 30</p><p>Vlanif30 current state : UP</p><p>Line protocol current state : UP</p><p>Last line protocol up time : 2020-06-05 17:43:22 UTC-08:00</p><p>Description:</p><p>Route Port,The Maximum Transmit Unit is 1500</p><p>Internet Address is allocated by DHCP, 10.0.30.2&#x2F;24</p><p>接口已经通过DHCP获取到IP地址，并且VLANIF30的地址为静态分配的地址：10.0.30.2。</p>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DHCP Relay </tag>
            
            <tag> DHCP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vlan间通信</title>
      <link href="/2023/11/24/vlan%E9%97%B4%E9%80%9A%E4%BF%A1/"/>
      <url>/2023/11/24/vlan%E9%97%B4%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="VLAN间通信"><a href="#VLAN间通信" class="headerlink" title="VLAN间通信"></a>VLAN间通信</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>划分VLAN后，不同VLAN的用户间不能二层互访，这样能起到隔离广播的作用。但实际应用中，不同VLAN的用户又常有互访的需求，此时就需要实现不同VLAN的用户互访，简称VLAN间互访。</p><span id="more"></span><h2 id="实验拓扑"><a href="#实验拓扑" class="headerlink" title="实验拓扑"></a>实验拓扑</h2><p><img src="/2023/11/24/vlan%E9%97%B4%E9%80%9A%E4%BF%A1/vlantx001.png" alt="vlantx001"></p><p>详解：R2划入vlan2，R3划入vlan3，与交换机之间采用access口，由于交换机g0&#x2F;0&#x2F;1需要通过多个vlan，所以配成trunk口。R2和R3相当于主机，发送和接受的数据都不带标签，交换机g0&#x2F;0&#x2F;2收到R2发送的数据，打上标签vlan2，然后发出去；交换机g0&#x2F;0&#x2F;1收到数据后，发现vlan的标签允许通过，则数据带着vlan2的标签通过；然后交换机g0&#x2F;0&#x2F;3口转发数据时，发现自己的pvid是vlan3，和vlan2不一样，所以不接受，则vlan2和vlan3不能通信。</p><p>在某些场景下，需要特定vlan之间通信</p><p>方法一：dot1q接口</p><p>在r1上配置两个dot1q接口，g0&#x2F;0&#x2F;1.1和g0&#x2F;0&#x2F;1.2，分别对应vlan2和vlan3，作用就是可以终结vlan标签（剥离），vlan2的标签到r1后，被剥离掉vlan2的标签，然后转发时又被g0&#x2F;0&#x2F;1.2打上vlan3的标签，交换机g0&#x2F;0&#x2F;1通过，到g0&#x2F;0&#x2F;3，access口发现和自己的pvid一样，然后剥离掉标签，转发数据帧给r3.</p><p>方法二：vlanif接口：交换机上配置vlanif2和vlanif3，ip地址配成192.168.2.254和192.168.3.254</p><p>其实就是相当于两个不同网段的网关，然后实现三层的转发</p><h2 id="Access接口"><a href="#Access接口" class="headerlink" title="Access接口"></a>Access接口</h2><p>交换机上常用来连接用户PC、服务器等终端设备的接口。Access接口所连接的这些设备的网卡往往只收发无标记帧。Access接口只能加入一个VLAN。只能允许一个VLAN通过。</p><p><strong>转发原则</strong></p><p>接收原则：</p><p>①收到不带标签的数据帧，打上标签，vlan id&#x3D;端口的PVID</p><p>②收到带标签的数据帧，检查数据帧vlan id是否和端口的PVID相同，相同直接接收；不同拒绝接收</p><p>发送原则：</p><p>①数据帧vlan id和端口PVID 相同，剥离标签发送；</p><p>②数据帧vlan id和端口PVID 不同，禁止发送。</p><h2 id="Trunk接口"><a href="#Trunk接口" class="headerlink" title="Trunk接口"></a>Trunk接口</h2><p>Trunk接口允许多个VLAN的数据帧通过，这些数据帧通过802.1Q Tag实现区分。Trunk接口常用于交换机之间的互联，也用于连接路由器、防火墙等设备的</p><p>子接口</p><p><strong>转发原则</strong></p><p>接收原则：</p><p>①收到不带标签的数据帧，打上标签，vlan id&#x3D;端口的PVID，然后查看该vlanid是否在允许列表中，是–接收，不是–拒绝</p><p>②收到带标签的数据帧，查看该vlan id是否在允许列表中，是–接收，不是–拒绝</p><p>发送原则：</p><p>查看vlan id是否在允许列表中，I:不是–拒绝发送；II：是，查看接口的PVID和vlan id是否相同，相同–剥标签发送；不同–直接发送。</p><h2 id="Hybrid接口"><a href="#Hybrid接口" class="headerlink" title="Hybrid接口"></a>Hybrid接口</h2><p>Hybrid接口与Trunk接口类似，也允许多个VLAN的数据帧通过，这些数据帧通过802.1Q Tag实现区分。用户可以灵活指定Hybrid接口在发送某个（或某些）VLAN的数据帧时是否携带Tag</p><p><strong>转发原则</strong></p><p>接收原则：</p><p>①收到不带标签的数据帧，打上标签，vlan id&#x3D;端口的PVID，然后查看该vlanid是否在允许列表中，是–接收，不是–拒绝</p><p>②收到带标签的数据帧，查看该vlan id是否在允许列表中，是–接收，不是–拒绝发送原则：查看vlan id是否在允许列表中，I:不是–拒绝发送；II：是，是否带标签发送取决于接口的配置。</p><h2 id="PVID"><a href="#PVID" class="headerlink" title="PVID"></a>PVID</h2><p>可以手工修改，默认是1，access口的就是本身的vlan号，trunk可以有一个主vlan和多个副vlan，收到的数据和主vlan相同就剥离转发，收到和主vlan不一样的标签，查表，看看是不是在允许通过的列表，如果有，就带着原来的转发，要是没有，就不让过去啦。</p><h2 id="实验配置过程"><a href="#实验配置过程" class="headerlink" title="实验配置过程"></a>实验配置过程</h2><p># R2和R3的IP地址及网关配置</p><p><R2> system-view</R2></p><p>Enter system view, return user view with Ctrl+Z.</p><p>[R2]interface GigabitEthernet 0&#x2F;0&#x2F;1</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;1]ip address 192.168.2.1 24</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;1]quit</p><p>[R2]ip route-static 0.0.0.0 0 192.168.2.254</p><p>配置默认路由，相当于给设备配置了网关。</p><p><R3>system-view </R3></p><p>Enter system view, return user view with Ctrl+Z.</p><p>[R3]interface GigabitEthernet 0&#x2F;0&#x2F;1</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;1]ip address 192.168.3.1 24</p><p>[R3-GigabitEthernet0&#x2F;0&#x2F;1]quit</p><p>[R3]ip route-static 0.0.0.0 0 192.168.3.254</p><p># 在S1上对R2和R3进行VLAN划分</p><p>[S1]vlan batch 2 3</p><p>Info: This operation may take a few seconds. Please wait for a moment…done.</p><p>[S1]interface GigabitEthernet 0&#x2F;0&#x2F;2</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;2]port link-type access </p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;2]port default vlan 2</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;2]quit</p><p>[S1]interface GigabitEthernet 0&#x2F;0&#x2F;3</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;3]port link-type access </p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;3]port default vlan 3</p><p>步骤 1 通过Dot1q终结子接口实现VLAN间互访 </p><p># 配置S1上的Trunk接口</p><p>[S1]interface GigabitEthernet 0&#x2F;0&#x2F;1</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;1]port trunk allow-pass vlan 2 3</p><p><em>因为VLAN间<strong>互访数据要</strong>由R1来终结VLAN<strong>，</strong>所以S1和R1之间<strong>的链路要允许</strong>VLAN2和VLAN3通过**。</em></p><p># 在R1上创建并配置Dot1q终结子接口</p><p>[R1]interface GigabitEthernet 0&#x2F;0&#x2F;1.2 </p><p>创建并进入子接口视图。2代表子接口的编号，一般建议子接口编号与VLAN ID相同，方便记忆。</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.2]dot1q termination vid 2 </p><p><strong>dot1q termination vid</strong> <em>vlan-id</em>命令用来配置子接口Dot1q终结的VLAN ID。</p><p>以此配置为例：当GigabitEthernet0&#x2F;0&#x2F;1接口收到带有VLAN 2标签的数据之后，会交由2号子接口进行VLAN终结操作并做后续处理。从2号子接口发出的数据也会带上VLAN 2的标签。</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.2]arp broadcast enable </p><p>终结子接口不能转发广播报文，在收到广播报文后它们直接把该报文丢弃。为了允许终结子接口能转发广播报文，可以通过在子接口上执行命令<strong>arp broadcast enable</strong>使能终结子接口的ARP广播功能。部分设备默认使能该功能，此命令的配置根据设备而定。</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.2]ip address 192.168.2.254 24 </p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.2]quit</p><p>[R1]interface GigabitEthernet 0&#x2F;0&#x2F;1.3</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.3]dot1q termination vid 3</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.3]arp broadcast enable</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.3]ip address 192.168.3.254 24</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1.3]quit</p><p># 检测VLAN间互访联通性 </p><p><R2>ping 192.168.3.1</R2></p><p> PING 192.168.3.1: 56  data bytes, press CTRL_C to break</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;1 ttl&#x3D;254 time&#x3D;60 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;2 ttl&#x3D;254 time&#x3D;40 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;3 ttl&#x3D;254 time&#x3D;110 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;4 ttl&#x3D;254 time&#x3D;70 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;5 ttl&#x3D;254 time&#x3D;100 ms</p><p> — 192.168.3.1 ping statistics —</p><p>  5 packet(s) transmitted</p><p>  5 packet(s) received</p><p>  0.00% packet loss</p><p>  round-trip min&#x2F;avg&#x2F;max &#x3D; 40&#x2F;76&#x2F;110 ms</p><p><R2>tracert 192.168.3.1 </R2></p><p> traceroute to  192.168.3.1(192.168.3.1), max hops: 30 ,packet length: 40,press CTRL_C to break </p><p> 1 192.168.2.254 30 ms  50 ms  50 ms </p><p> 2 192.168.3.1 70 ms  60 ms  60 ms </p><p>此时VLAN2和VLAN3之间已经可以正常的互访。</p><p>步骤 2 通过VLANIF接口实现VLAN间互访</p><p># 清除上一步配置</p><p>[S1]interface GigabitEthernet 0&#x2F;0&#x2F;1</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;1]undo port trunk allow-pass vlan 2 3</p><p>[S1-GigabitEthernet0&#x2F;0&#x2F;1]undo port link-type</p><p>[R1]undo interface GigabitEthernet 0&#x2F;0&#x2F;1.2 </p><p>[R1]undo interface GigabitEthernet 0&#x2F;0&#x2F;1.3</p><p># 在S1上创建相应的VLANIF接口 </p><p>[S1]interface Vlanif 2</p><p><strong>interface vlanif</strong> <em>vlan-id</em>命令用来创建VLANIF接口并进入VLANIF接口视图。只有先通过命令创建VLAN后，才能执行interface vlanif命令创建VLANIF接口。</p><p>[S1-Vlanif2]ip address 192.168.2.254 24</p><p>[S1-Vlanif2]quit</p><p>[S1]interface Vlanif 3</p><p>[S1-Vlanif3]ip address 192.168.3.254 24 </p><p>[S1-Vlanif3]quit</p><p># 检测VLAN间互访联通性</p><p><R2>ping 192.168.3.1 </R2></p><p> PING 192.168.3.1: 56  data bytes, press CTRL_C to break</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;1 ttl&#x3D;254 time&#x3D;100 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;2 ttl&#x3D;254 time&#x3D;50 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;3 ttl&#x3D;254 time&#x3D;50 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;4 ttl&#x3D;254 time&#x3D;60 ms</p><p>  Reply from 192.168.3.1: bytes&#x3D;56 Sequence&#x3D;5 ttl&#x3D;254 time&#x3D;70 ms</p><p> — 192.168.3.1 ping statistics —</p><p>  5 packet(s) transmitted</p><p>  5 packet(s) received</p><p>  0.00% packet loss</p><p>  round-trip min&#x2F;avg&#x2F;max &#x3D; 50&#x2F;66&#x2F;100 ms</p><p><R2>tracert 192.168.3.1 </R2></p><p> traceroute to  192.168.3.1(192.168.3.1), max hops: 30 ,packet length: 40,press CTRL_C to break </p><p> 1 192.168.2.254 40 ms  30 ms  20 ms </p><p> 2 192.168.3.1 40 ms  30 ms  40 ms</p><p>此时VLAN2和VLAN3之间已经可以正常的互访。</p>]]></content>
      
      
      <categories>
          
          <category> ip实验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vlan间通信 </tag>
            
            <tag> dot1q </tag>
            
            <tag> vlanif </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
